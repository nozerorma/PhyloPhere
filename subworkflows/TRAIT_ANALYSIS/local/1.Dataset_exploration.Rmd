---
title: "Data Visualization for trait analysis"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r header}

#  ██████╗ ██╗  ██╗██╗   ██╗██╗      ██████╗ ██████╗ ██╗  ██╗███████╗██████╗ ███████╗
#  ██╔══██╗██║  ██║╚██╗ ██╔╝██║     ██╔═══██╗██╔══██╗██║  ██║██╔════╝██╔══██╗██╔════╝
#  ██████╔╝███████║ ╚████╔╝ ██║     ██║   ██║██████╔╝███████║█████╗  ██████╔╝█████╗
#  ██╔═══╝ ██╔══██║  ╚██╔╝  ██║     ██║   ██║██╔═══╝ ██╔══██║██╔══╝  ██╔══██╗██╔══╝
#  ██║     ██║  ██║   ██║   ███████╗╚██████╔╝██║     ██║  ██║███████╗██║  ██║███████╗
#  ╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝ ╚═════╝ ╚═╝     ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝

## PHYLOPHERE: A Nextflow pipeline including a complete set
## of phylogenetic comparative tools and analyses for Phenome-Genome studies

### Github: https://github.com/nozerorma/caastools/nf-phylophere
### Author: Miguel Ramon (miguel.ramon@upf.edu)

#### File: dataset_exploration.Rmd

```

# Data Visualization and Processing

Script to visualize and process data. It generates family distribution plots, summary tables, and a processed dataset.

---

## Setup and Directory Configuration
This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Call the setup function from commons.R
source("./obj/commons.R")
setup_rmd()

# Load necessary libraries
library(dplyr)
library(ggplot2)
library(readr)
library(reshape2)

# Objects
color_palette <- paste0(clade_name, "_palette") # Color palette for the clade
capitalized_taxon <- tools::toTitleCase(taxon_of_interest) # Capitalized taxon name
capitalized_trait <- tools::toTitleCase(gsub("_", " ", trait)) # Capitalized and deconvoluted trait name
capitalized_clade <- tools::toTitleCase(gsub("_", " ", clade_name)) # Capitalized and deconvoluted clade name

createDir(species_distribution_dir)

```

## 1. Dataset Visualization
This section visualizes the distribution of species across families to provide an overview of the dataset.

```{r dataset_visualization, fig.height=7, fig.width=7, dev='png', dpi=320}

# 1. DATA VISUALIZATION  ------------------------------------------------------
# Calculate species count per taxon_of_interest
# Note that for this section we use the original trait dataframe (trait_df_ori), and will generate two plots
# : one for the pruned tree species, and another for all species in the original dataframe.

taxa_distribution <- trait_df_ori %>%
  dplyr::rename(taxa = !!taxon_of_interest) %>%
  dplyr::group_by(taxa) %>%
  dplyr::summarise(count = n())

# Ensure species order matches phylogeny
ordered_species <-  tidytree::as_tibble(pruned_tree) %>%
  dplyr::arrange(desc(.data$node)) %>%
  # Remove internal nodes by filtering only rows where label is not NA
  dplyr::filter(!is.na(.data$label)) %>%
  dplyr::pull(.data$label)

print(ordered_species)

# Define ordered taxa for plotting based on phylogeny order
ordered_taxa <- ordered_species %>%
  sapply(function(sp) {
    idx <- which(trait_df_ori$species == sp)
    if (length(idx) == 0) return(NA_character_)
    trait_df_ori[[taxon_of_interest]][idx[1]]
  }) %>%
  unname() %>%
  na.omit() %>%
  unique()

print(ordered_taxa)

## PLOT FUNCTION --------------------------------------------------------------
taxa_plot.f <- function(df, ordered_taxa_levels){
  max_count <- max(df$count, na.rm = TRUE)
  palette_values <- get_palette_values()
  debug_log("taxa_plot.f rows = %d, palette_values = %s", nrow(df), ifelse(is.null(palette_values), "<none>", "ok"))
  fill_scale <- if (is.null(palette_values)) {
    ggplot2::scale_fill_discrete()
  } else {
    ggplot2::scale_fill_manual(values = palette_values, breaks = NULL)
  }
  ggplot2::ggplot(df, 
                aes(x = taxa, y = count, fill = taxa)) +
  scale_x_discrete(limits = rev(ordered_taxa_levels)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), 
            vjust = 0.5, hjust = -1.5, 
            color = "black", fontface = "bold", 
            size = 6) +
  labs(x = paste(capitalized_taxon, "-", clade_name), 
       y = "Number of species", 
       title = paste(capitalized_taxon, "distribution in", clade_name)) +
  fill_scale + 
  scale_y_continuous(limits = c(0, max_count+2), expand = c(0, 0)) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(hjust = 1, size = 18, face = "bold", color = "black"),
    axis.text.x = element_blank(),
    plot.title = element_text(size = 20, hjust = 0.5, margin = margin(t = 20), face = "bold", color = "black"),
    axis.title.x = element_text(size = 18, hjust = 0.5, margin = margin(t = 20), face = "bold", color = "black"),
    axis.title.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()
}


# Order taxa for the full dataset using original data order
ordered_taxa_all <- unique(taxa_distribution$taxa)

# Create bar plot for taxa distribution (all taxa)
taxa_distribution_all <- taxa_distribution %>%
  dplyr::mutate(taxa = factor(taxa, levels = ordered_taxa_all)) %>%
  dplyr::arrange(taxa, .by_group = TRUE)

p1 <- taxa_plot.f(taxa_distribution_all, ordered_taxa_all)

# Save the plot to the results directory
ggplot2::ggsave(file.path(species_distribution_dir, paste0(clade_name, "_", taxon_of_interest, "_distribution_original.png")), p1, 
                device = "png", width = 10, height = 10, dpi = "retina")

# Display the plot
p1

# Prune taxa distribution to only include species in the pruned tree
pruned_taxa_distribution <- taxa_distribution %>%
  dplyr::filter(taxa %in% (trait_df %>%
                             dplyr::pull(!!sym(taxon_of_interest)) %>%
                             unique()))

# Create bar plot for pruned taxa distribution
pruned_taxa_distribution <- pruned_taxa_distribution %>%
  dplyr::mutate(taxa = factor(taxa, levels = ordered_taxa)) %>%
  dplyr::arrange(taxa, .by_group = TRUE)

p2 <- taxa_plot.f(pruned_taxa_distribution, ordered_taxa)

# Save the plot to the results directory
ggplot2::ggsave(file.path(species_distribution_dir, paste0(clade_name, "_", taxon_of_interest, "_distribution_pruned.png")), p2, 
                device = "png", width = 10, height = 10, dpi = "retina")

# Display the plot
p2

```

## 2. Data Processing and statistical overview

```{r stats_overview}

# Apply stats.f to trait_df
# Here we directly use trait_df from the global environment, already loaded and pruned using the phylogeny
stats_df <- stats.f(trait_df)

# Save the melted dataframe
save_path <- file.path(species_distribution_dir, "trait_stats.csv")
if (!is.null(stats_df)) {
  write.csv(stats_df, save_path, row.names = FALSE)
}

# Print an excerpt
if (!is.null(stats_df)) {
  print(head(stats_df))
}

```

## Session Information

```{r debug_dump, results='asis'}

if (length(phylo_debug_log) > 0) {
  cat("### Debug log\n")
  cat(paste0("[DEBUG] ", phylo_debug_log, "\n"))
}

```

```{r session_info}

sessionInfo()

```
