---
title: "Independent Contrast Selection for Trait Analysis using CAASTools-paired"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r header}

#  ██████╗ ██╗  ██╗██╗   ██╗██╗      ██████╗ ██████╗ ██╗  ██╗███████╗██████╗ ███████╗
#  ██╔══██╗██║  ██║╚██╗ ██╔╝██║     ██╔═══██╗██╔══██╗██║  ██║██╔════╝██╔══██╗██╔════╝
#  ██████╔╝███████║ ╚████╔╝ ██║     ██║   ██║██████╔╝███████║█████╗  ██████╔╝█████╗
#  ██╔═══╝ ██╔══██║  ╚██╔╝  ██║     ██║   ██║██╔═══╝ ██╔══██║██╔══╝  ██╔══██╗██╔══╝
#  ██║     ██║  ██║   ██║   ███████╗╚██████╔╝██║     ██║  ██║███████╗██║  ██║███████╗
#  ╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝ ╚═════╝ ╚═╝     ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝

## PHYLOPHERE: A Nextflow pipeline including a complete set
## of phylogenetic comparative tools and analyses for Phenome-Genome studies

### Github: https://github.com/nozerorma/caastools/nf-phylophere
### Author: Miguel Ramon (miguel.ramon@upf.edu)

#### File: Independent_contrasts.Rmd

```

# Independent Contrast Selection for Neoplasia Analysis in Primates
This document outlines the process of selecting phylogenetically independent species pairs for trait analysis using CAASTools-paired. 


## Setup and Directory Configuration

This section configures the working environment, sets directories, and loads necessary functions and libraries.


```{r setup, message=TRUE, warning=TRUE}

# Call the setup function from commons.R
source("./obj/commons.R")
setup_rmd()

# Debug helper (prints into HTML output)
if (is.null(getOption("phylo_debug"))) {
  options(phylo_debug = TRUE)
}
if (!exists("phylo_debug_log", envir = .GlobalEnv)) {
  phylo_debug_log <- character()
}
if (!exists("debug_log", inherits = TRUE)) {
  debug_log <- function(...) {
    msg <- sprintf(...)
    phylo_debug_log <<- c(phylo_debug_log, msg)
    cat("[DEBUG] ", msg, "\n", sep = "")
  }
}

# Load additional libraries
library(purrr)
library(tibble)

# Load selection algorithm
source("./obj/selection_algorithm.R")

color_palette <- paste0(clade_name, "_palette") # Color palette for the clade
capitalized_taxon <- tools::toTitleCase(taxon_of_interest) # Capitalized taxon name
capitalized_trait <- tools::toTitleCase(gsub("_", " ", trait)) # Capitalized and deconvoluted trait name
capitalized_clade <- tools::toTitleCase(gsub("_", " ", clade_name)) # Capitalized and deconvoluted clade name

createDir(traitfile_dir)

```

## 2. Patristic Distance Calculation

This section calculates evolutionary distances between species using the phylogenetic tree. Patristic distance represents the sum of branch lengths separating two species.

```{r patristic_distances, message=TRUE, warning=TRUE}

# Calculate patristic distances using pruned tree
distance_matrix <- calculate_patristic_distances(
  tree = pruned_tree, 
  df = trait_df
)

# Display distance matrix preview
cat("Distance matrix dimensions:", dim(distance_matrix), "\n")
head(distance_matrix[, 1:5])

```

## 3. Independent Contrast Pair Selection

This section selects phylogenetically independent species pairs for CAAS analysis. The algorithm prioritizes pairs with small evolutionary distances but large trait differences, while ensuring phylogenetic independence between pairs using the Dunn index.

When the input `traits_df` contains a numeric `p` column (population size), tie-breaking now follows: highest Dunn index → highest absolute trait difference (`diff`) → highest combined `n` for the pair. If `n` is absent, behaviour is unchanged.

```{r pair_selection, message=TRUE, warning=TRUE}

# Run pair selection for both malignant and neoplasia traits
selected_pairs.f <- function(my_trait) {
  
  cat("\n=== Selecting pairs for", my_trait, "===\n")
  
  # Select pairs using phylogeny-aware algorithm
  selected_pairs <- pair_sel.f(
    distance_matrix = distance_matrix,
    overlap_df = pairwise_data,
    traits_df = stats_df,
    my_trait = my_trait
  )$selected_pairs
  
  cat("Selected", nrow(selected_pairs), "phylogenetically independent pairs\n")
  
  return(selected_pairs)
}

selected_pairs <- selected_pairs.f(trait)

# Display selected pairs
print(selected_pairs)

```