---
title: "Independent Contrast Selection for Trait Analysis using CAASTools-paired"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r header}

#  ██████╗ ██╗  ██╗██╗   ██╗██╗      ██████╗ ██████╗ ██╗  ██╗███████╗██████╗ ███████╗
#  ██╔══██╗██║  ██║╚██╗ ██╔╝██║     ██╔═══██╗██╔══██╗██║  ██║██╔════╝██╔══██╗██╔════╝
#  ██████╔╝███████║ ╚████╔╝ ██║     ██║   ██║██████╔╝███████║█████╗  ██████╔╝█████╗
#  ██╔═══╝ ██╔══██║  ╚██╔╝  ██║     ██║   ██║██╔═══╝ ██╔══██║██╔══╝  ██╔══██╗██╔══╝
#  ██║     ██║  ██║   ██║   ███████╗╚██████╔╝██║     ██║  ██║███████╗██║  ██║███████╗
#  ╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝ ╚═════╝ ╚═╝     ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝

## PHYLOPHERE: A Nextflow pipeline including a complete set
## of phylogenetic comparative tools and analyses for Phenome-Genome studies

### Github: https://github.com/nozerorma/caastools/nf-phylophere
### Author: Miguel Ramon (miguel.ramon@upf.edu)

#### File: Independent_contrasts.Rmd

```

# Independent Contrast Selection for Neoplasia Analysis in Primates
This document outlines the process of selecting phylogenetically independent species pairs for trait analysis using CAASTools-paired. 


## Setup and Directory Configuration

This section configures the working environment, sets directories, and loads necessary functions and libraries.


```{r setup, message=TRUE, warning=TRUE}

# Call the setup function from commons.R
source("./obj/commons.R")
setup_rmd()

# Debug helper (prints into HTML output)
if (is.null(getOption("phylo_debug"))) {
  options(phylo_debug = TRUE)
}
if (!exists("phylo_debug_log", envir = .GlobalEnv)) {
  phylo_debug_log <- character()
}
if (!exists("debug_log", inherits = TRUE)) {
  debug_log <- function(...) {
    msg <- sprintf(...)
    phylo_debug_log <<- c(phylo_debug_log, msg)
    cat("[DEBUG] ", msg, "\n", sep = "")
  }
}

# Load additional libraries
library(purrr)
library(tibble)

# Load selection algorithm
source("./obj/selection_algorithm.R")

color_palette <- paste0(clade_name, "_palette") # Color palette for the clade
capitalized_taxon <- tools::toTitleCase(taxon_of_interest) # Capitalized taxon name
capitalized_trait <- tools::toTitleCase(gsub("_", " ", trait)) # Capitalized and deconvoluted trait name
capitalized_clade <- tools::toTitleCase(gsub("_", " ", clade_name)) # Capitalized and deconvoluted clade name

createDir(traitfile_dir)
createDir(bootstrap_traitfile_dir)

```

## 2. Patristic Distance Calculation

This section calculates evolutionary distances between species using the phylogenetic tree. Patristic distance represents the sum of branch lengths separating two species.

```{r patristic_distances, message=TRUE, warning=TRUE}

# Calculate patristic distances using pruned tree
distance_matrix <- calculate_patristic_distances(
  tree = pruned_tree, 
  df = trait_df
)

# Display distance matrix preview
cat("Distance matrix dimensions:", dim(distance_matrix), "\n")
head(distance_matrix[, 1:5])

```

## 3. Independent Contrast Pair Selection

This section selects phylogenetically independent species pairs for CAAS analysis. The algorithm prioritizes pairs with small evolutionary distances but large trait differences, while ensuring phylogenetic independence between pairs using the Dunn index.

When the input `traits_df` contains a numeric `p` column (population size), tie-breaking now follows: highest Dunn index → highest absolute trait difference (`diff`) → highest combined `n` for the pair. If `n` is absent, behaviour is unchanged.

```{r pair_selection, message=TRUE, warning=TRUE}

# Load summary stats from Dataset Exploration
stats_path <- file.path(species_distribution_dir, "trait_stats.csv")
if (!file.exists(stats_path)) {
  stop("Missing trait stats file: ", stats_path)
}
stats_df <- read.csv(stats_path, stringsAsFactors = FALSE)

# Load pairwise overlap data from CI-composition step
pairwise_path <- file.path(ci_dir, "pairwise_data.csv")
if (!file.exists(pairwise_path)) {
  stop("Missing pairwise overlap file: ", pairwise_path)
}
pairwise_data <- read.csv(pairwise_path, stringsAsFactors = FALSE) %>%
  dplyr::filter(trait_overlap == FALSE)

# Run pair selection for both malignant and neoplasia traits
selected_pairs.f <- function(my_trait) {
  
  cat("\n=== Selecting pairs for", my_trait, "===\n")
  
  # Select pairs using phylogeny-aware algorithm
  selected_pairs <- pair_sel.f(
    distance_matrix = distance_matrix,
    overlap_df = pairwise_data,
    traits_df = stats_df,
    my_trait = my_trait
  )$selected_pairs
  
  cat("Selected", nrow(selected_pairs), "phylogenetically independent pairs\n")
  
  return(selected_pairs)
}

selected_pairs <- selected_pairs.f(trait)

# Display selected pairs
print(selected_pairs)

```


## 4. Trait File Generation

This section generates trait files in the format required for CAAS discovery, assigning contrast groups (high/low extremes) to each species.

```{r traitfile_generation, message=TRUE, warning=TRUE}

# Function to generate trait files from selected pairs
gen_traitfiles <- function(df) {
  df <- df %>%
    tibble::rownames_to_column(var = "pair_id") %>%
    dplyr::mutate(rank = dplyr::row_number()) %>%
    tidyr::pivot_longer(
      cols = c(species1, species2), 
      names_to = "global_label", 
      values_to = "species"
    ) %>%
    dplyr::mutate(
      global_label = ifelse(
        global_label == "species1", 
        "high_extreme", 
        "low_extreme"
      )
    )
  
  # Assign contrast groups
  filtered_species <- df %>%
    dplyr::group_by(global_label) %>%
    dplyr::select(species, global_label) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(
      contrast_group = case_when(
        global_label == "high_extreme" ~ 1,
        global_label == "low_extreme" ~ 0,
        TRUE ~ NA_integer_
      )
    ) %>%
    dplyr::select(-global_label) %>%
    dplyr::mutate(pair = rep(1:(nrow(df)/2), each = 2)) %>%
    dplyr::arrange(contrast_group, pair)
  
  return(filtered_species)
}

# Generate trait files for selected pairs
traits_res <- gen_traitfiles(selected_pairs)

# Save trait files
trait_path <- file.path(traitfile_dir, trait)
createDir(trait_path)
write.table(  
  traits_res, 
  file.path(trait_path, trait, "traitfile.tab"), 
  quote = FALSE, 
  row.names = FALSE, 
  col.names = FALSE, 
  sep = "\t"
)
cat("Trait file saved for", trait, "with", nrow(traits_res), "entries\n")

head(traits_res)

```

## 5. Bootstrap Trait Files for Permutation Analysis

This section extracts species  for use in bootstrap/permutation testing.
```{r bootstrap_traitfiles, message=TRUE, warning=TRUE}

# Extract malignant prevalence traitfile with ZIMS-ACE validation
bootstrap_traitfile <- trait_df %>%
  dplyr::select(species, trait) 

# Save malignant traitfile
boot_path <- file.path(bootstrap_traitfile_dir, trait)
createDir(boot_path)
write.table(
  bootstrap_traitfile, 
  file.path(boot_path, "boot_traitfile.tab"), 
  quote = FALSE, 
  row.names = FALSE, 
  col.names = FALSE, 
  sep = "\t"
)

# Display summary
cat("Bootstrap traitfile:", nrow(bootstrap_traitfile), "species\n")

# Preview
head(bootstrap_traitfile)

```

## Session Information

```{r debug_dump, results='asis'}

if (length(phylo_debug_log) > 0) {
  cat("### Debug log\n")
  cat(paste0("[DEBUG] ", phylo_debug_log, "\n"))
}

```

```{r session_info}
sessionInfo()
```
