---
title: "Independent contrast selection"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

# Independent Contrast Selection for Neoplasia Analysis in Primates
This script performs independent contrast selection for neoplasia analysis in primates, focusing on malignancy prevalence across species. It includes data preparation, pair selection based on evolutionary distances, and trait file generation for further analysis.

## Setup and Directory Configuration

This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}
# Source commons.R for setup
source("./functions/commons.R")
setup_rmd()

# Load additional libraries
library(purrr)
library(tibble)

# Load selection algorithm
source("./functions/selection_algorithm.R")
```

## 1. Data Import

This section loads pre-processed trait data and curated conflict-resolution results from earlier analysis steps.

```{r data_import, message=FALSE, warning=FALSE}
# Load processed cancer traits with longevity quotient
cancer_traits_processed <- read.csv(
  file.path(trait_dir, "cancer_traits_processed-LQ.csv")
)

# Load melted traits for pair selection
melted_traits <- read.csv(
  file.path(trait_dir, "melted_traits.csv")
) %>%
  # Rename necropsy_counts to n
  dplyr::rename(n = necropsy_counts)

# Load ZIMS-ACE comparison data
zims_ace_data <- readRDS(
  file = file.path(ci_overlaps_dir, "zims_ace_data.rds")
)

# Load conflict-resolved species pairs (curated overlaps)
conflicts_jeff <- readRDS(
  file = file.path(curation_dir, "Jeffrey/conflicts_jeff.rds")
)

# Display summary
cat("Cancer traits loaded:", nrow(cancer_traits_processed), "species\n")
cat("Melted traits loaded:", nrow(melted_traits), "observations\n")
cat("Conflict resolution lists:", names(conflicts_jeff), "\n")
```

## 2. Patristic Distance Calculation

This section calculates evolutionary distances between species using the phylogenetic tree. Patristic distance represents the sum of branch lengths separating two species.

```{r patristic_distances, message=FALSE, warning=FALSE}
# Calculate patristic distances using pruned tree
distance_matrix <- calculate_patristic_distances(
  tree = pruned_tree, 
  df = cancer_traits_processed
)

# Display distance matrix preview
cat("Distance matrix dimensions:", dim(distance_matrix), "\n")
head(distance_matrix[, 1:5])
```

## 3. Independent Contrast Pair Selection

This section selects phylogenetically independent species pairs for CAAS analysis. The algorithm prioritizes pairs with small evolutionary distances but large trait differences, while ensuring phylogenetic independence between pairs using the Dunn index.

When the input `traits_df` contains a numeric `n` column (here renamed from `necropsy_counts`), tie-breaking now follows: highest Dunn index → highest absolute trait difference (`diff`) → highest combined `n` for the pair. If `n` is absent, behaviour is unchanged.

```{r pair_selection, message=FALSE, warning=FALSE}
# Run pair selection for both malignant and neoplasia traits
selected_pairs_list <- lapply(c("malignant", "neoplasia"), function(trait) {
  
  cat("\n=== Selecting pairs for", trait, "prevalence ===\n")
  
  # Select pairs using phylogeny-aware algorithm
  selected_pairs <- pair_sel.f(
    distance_matrix = distance_matrix,
    overlap_df = conflicts_jeff[[paste0(trait, "_OK")]],
    traits_df = melted_traits,
    my_trait = paste0(trait, "_prevalence")
  )$selected_pairs
  
  cat("Selected", nrow(selected_pairs), "phylogenetically independent pairs\n")
  
  return(selected_pairs)
})

# Name the list elements
names(selected_pairs_list) <- c("malignant_prevalence", "neoplasia_prevalence")

# Display selected pairs
print(selected_pairs_list)
```

## 4. Trait File Generation

This section generates trait files in the format required for CAAS discovery, assigning contrast groups (high/low extremes) to each species.

```{r traitfile_generation, message=FALSE, warning=FALSE}
# Function to generate trait files from selected pairs
gen_traitfiles <- function(df) {
  df <- df %>%
    rownames_to_column(var = "pair_id") %>%
    mutate(rank = row_number()) %>%
    pivot_longer(
      cols = c(species1, species2), 
      names_to = "global_label", 
      values_to = "species"
    ) %>%
    mutate(
      global_label = ifelse(
        global_label == "species1", 
        "high_extreme", 
        "low_extreme"
      )
    )
  
  # Assign contrast groups
  filtered_species <- df %>%
    group_by(global_label) %>%
    select(species, global_label) %>%
    ungroup() %>%
    mutate(
      contrast_group = case_when(
        global_label == "high_extreme" ~ 1,
        global_label == "low_extreme" ~ 0,
        TRUE ~ NA_integer_
      )
    ) %>%
    select(-global_label) %>%
    mutate(pair = rep(1:(nrow(df)/2), each = 2)) %>%
    arrange(contrast_group, pair)
  
  return(filtered_species)
}

# Generate trait files for selected pairs
traits_res <- lapply(selected_pairs_list, gen_traitfiles)
names(traits_res) <- names(selected_pairs_list)

# Save trait files
for (trait_name in names(traits_res)) {
  trait_path <- file.path(traitfile_dir, trait_name)
  createDir(trait_path)
  write.table(
    traits_res[[trait_name]], 
    file.path(trait_path, "traitfile.tab"), 
    quote = FALSE, 
    row.names = FALSE, 
    col.names = FALSE, 
    sep = "\t"
  )
  cat("Trait file saved for", trait_name, "with", nrow(traits_res[[trait_name]]), "entries\n")
}

```

## 6. Bootstrap Trait Files for Permutation Analysis

This section extracts species with concordant ZIMS and ACE prevalence values for use in bootstrap/permutation testing. Only species where ACE values fall within ZIMS confidence intervals (or where ACE data is unavailable) are included.

```{r bootstrap_traitfiles, message=FALSE, warning=FALSE}
# Extract malignant prevalence traitfile with ZIMS-ACE validation

malignant_traitfile <- zims_ace_data %>%
  select(
    species, 
    malignant_prevalence.ZIMS, 
    malignant_prevalence.ACE, 
    malignant_CI_lb.jeff.ZIMS, 
    malignant_CI_ub.jeff.ZIMS
  ) %>%
  # Check if ACE value falls within ZIMS confidence interval
  mutate(
    is_in_ZIMS = ifelse(
      !is.na(malignant_prevalence.ACE), 
      malignant_prevalence.ACE >= malignant_CI_lb.jeff.ZIMS & 
      malignant_prevalence.ACE <= malignant_CI_ub.jeff.ZIMS, 
      NA
    )
  ) %>%
  # Mark unknown (no ACE data) as UNK, keep TRUE or UNK only
  mutate(is_in_ZIMS = ifelse(is.na(is_in_ZIMS), "UNK", is_in_ZIMS)) %>%
  filter(is_in_ZIMS != FALSE) %>%
  dplyr::select(species, malignant_prevalence.ZIMS) %>%
  # Prune species not in the tree
  filter(species %in% pruned_tree$tip.label)

# Extract neoplasia prevalence traitfile with ZIMS-ACE validation
neoplasia_traitfile <- zims_ace_data %>%
  select(
    species, 
    neoplasia_prevalence.ZIMS, 
    neoplasia_prevalence.ACE, 
    neoplasia_CI_lb.jeff.ZIMS, 
    neoplasia_CI_ub.jeff.ZIMS
  ) %>%
  # Check if ACE value falls within ZIMS confidence interval
  mutate(
    is_in_ZIMS = ifelse(
      !is.na(neoplasia_prevalence.ACE), 
      neoplasia_prevalence.ACE >= neoplasia_CI_lb.jeff.ZIMS & 
      neoplasia_prevalence.ACE <= neoplasia_CI_ub.jeff.ZIMS, 
      NA
    )
  ) %>%
  # Mark unknown (no ACE data) as UNK, keep TRUE or UNK only
  mutate(is_in_ZIMS = ifelse(is.na(is_in_ZIMS), "UNK", is_in_ZIMS)) %>%
  filter(is_in_ZIMS != FALSE) %>%
  dplyr::select(species, neoplasia_prevalence.ZIMS) %>%
  # Prune species not in the tree
  filter(species %in% pruned_tree$tip.label)

# Save malignant traitfile
malignant_boot_path <- file.path(bootstrap_traitfile_dir, "malignant_prevalence")
createDir(malignant_boot_path)
write.table(
  malignant_traitfile, 
  file.path(malignant_boot_path, "boot_traitfile.tab"), 
  quote = FALSE, 
  row.names = FALSE, 
  col.names = FALSE, 
  sep = "\t"
)

# Save neoplasia traitfile
neoplasia_boot_path <- file.path(bootstrap_traitfile_dir, "neoplasia_prevalence")
createDir(neoplasia_boot_path)
write.table(
  neoplasia_traitfile,
  file.path(neoplasia_boot_path, "boot_traitfile.tab"),
  quote = FALSE, 
  row.names = FALSE, 
  col.names = FALSE, 
  sep = "\t"
)

# Display summary
cat("Malignant bootstrap traitfile:", nrow(malignant_traitfile), "species\n")
cat("Neoplasia bootstrap traitfile:", nrow(neoplasia_traitfile), "species\n")

# Preview
head(malignant_traitfile)
head(neoplasia_traitfile)
```

## Session Information

```{r session_info}
sessionInfo()
```
