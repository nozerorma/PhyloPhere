---
title: "Curating Primate Cancer Data with ACE dataset (Jeffreys prior(0.5,0.5)"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

# Curating Primate Cancer Data with ACE dataset (Jeffreys prior(0.5,0.5))
This script curates primate cancer data by comparing the ZIMS dataset with the ACE dataset from Zach et al. (2025). It focuses on malignant and neoplasia prevalence, computing confidence intervals using Jeffreys prior (0.5,0.5) for robustness against small sample sizes. The idea is to identify and resolve contradictions in prevalence data between the two datasets, using quartile-based selection and visualizing the results through connected dot plots and scatter plots.

## Setup and Directory Configuration
This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)

```

```{r dirdef, message=FALSE, warning=FALSE}

# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.

```

## Load Libraries
Load DescTools library for CI computation.
```{r,warning=FALSE,message=FALSE}
# They should not be needed, recheck
# library(DescTools)
# library(binom)
```

### 1. Importing other primate cancer datasets for consistency analysis
This section loads and processes additional cancer trait data from different sources, ensuring consistency in the dataset. The data is filtered to include only primate species and relevant traits. Specific dataset to be compared can be specified in the `dataset` variable.

```{r, dataset_import}

# 1. DATA IMPORT  ------------------------------------------------------
# Load additional cancer trait data
# We will be using the dataset from "Cancer Prevalence across Vertebrates" from Zach et al. (https://doi.org/10.1158/2159-8290.CD-24-0573)
alt_dataset.f <- file.path(dataDir, "8.Mammals_cancer_data/zach-2025/cancerAcrossVertebrates/min20-2022.05.16.csv")
alt_dataset <- read.csv(alt_dataset.f) # Specify the dataset to be compared.

# Filter for primate species
# Binomize species in zach's data
alt_dataset$Species <- gsub(" ", "_", alt_dataset$Species)

# Compute CIs in zach's data
alt_dataset_ci <- alt_dataset %>%
  group_by(Species) %>%
  # Jeffreys beta (bayesian) CI. Using a non-informative prior Beta(0.5,0.5).
  # We will use this method to compute the CIs for malignant and neoplasia prevalence as it seems more robust for small sample sizes than Wilson's method.
  mutate(
    malignant_CI_lb.jeff = binom.confint(Malignant, RecordsWithDenominators, method = "bayes", priors=c(0.5,0.5), conf.level=0.95)[, 5],
    malignant_CI_ub.jeff = binom.confint(Malignant, RecordsWithDenominators, method = "bayes", priors=c(0.5,0.5), conf.level=0.95)[, 6],
    malignant_CI.jeff = paste0("[", round(malignant_CI_lb.jeff, 2), "-", round(malignant_CI_ub.jeff, 2), "]"),
    neoplasia_CI_lb.jeff = binom.confint(NeoplasiaWithDenominators, RecordsWithDenominators, method = "bayes", priors=c(0.5,0.5), conf.level=0.95)[, 5],
    neoplasia_CI_ub.jeff = binom.confint(NeoplasiaWithDenominators, RecordsWithDenominators, method = "bayes", priors=c(0.5,0.5), conf.level=0.95)[, 6],
    neoplasia_CI.jeff = paste0("[", round(neoplasia_CI_lb.jeff, 2), "-", round(neoplasia_CI_ub.jeff, 2), "]")) %>%
  dplyr::select(Orders, Family, Species, RecordsWithDenominators, Malignant, MalignancyPrevalence, 
                malignant_CI_lb.jeff, malignant_CI_ub.jeff, malignant_CI.jeff,
                NeoplasiaWithDenominators, NeoplasiaPrevalence,
                neoplasia_CI_lb.jeff, neoplasia_CI_ub.jeff, neoplasia_CI.jeff) %>%
  dplyr::rename(species = Species) %>%
  dplyr::filter(Orders == "Primates")

# Excerpt the ACE dataset
head(alt_dataset_ci)
```

## 2. Ranking: Pairwise Phenotypic Differences

This section identifies species pairs with non-overlapping confidence intervals for malignant and neoplasia prevalence, calculating the absolute difference in prevalence for each pair. These differences will inform the ranking process. We will be testing together how Wilson and Jeffrey's CI compare.

All the code related to Wilson's CI is commented out, as we will be using Jeffrey's method for the analysis. The code can be uncommented if needed.

```{r pheno_diff_wil plot, dev="png", fig.width=15, fig.height=12, dpi=320}

# 2. RANKING: PAIRWISE PHENOTYPIC DIFFERENCES  ------------------------------------------------------
# Load cancer traits with confidence intervals
# Load processed cancer traits data with longevity quotient (LQ)
cancer_traits_processed <- read.csv(file.path(trait_dir, "cancer_traits_processed-LQ.csv"))

ci_dir <- file.path(trait_dir, "CIs")
cancer_traits_ci <- read.csv(file.path(ci_dir, "cancer_traits_CI-jeff.csv"))

# Load and filter pairwise data for non-overlapping malignant prevalence
malignant_overlap_data.jeff <- read.csv(file.path(ci_dir, "pairwise_data-jeff.csv"), header = TRUE, sep = ",") %>%
  filter(malignant_overlap == FALSE)  # Keep pairs where CIs do not overlap

# Load and filter pairwise data for non-overlapping neoplasia prevalence
neoplasia_overlap_data.jeff <- read.csv(file.path(ci_dir, "pairwise_data-jeff.csv"), header = TRUE, sep = ",") %>%
  filter(neoplasia_overlap == FALSE)  # Keep pairs where CIs do not overlap

# Plot the CIs
create_connected_dot_plot <- function(data, prefix, mode, title, median_value) {
  # Construct column names based on prefix
  prevalence_col1 <- paste0(prefix, "prevalence1")
  prevalence_col2 <- paste0(prefix, "prevalence2")
  ci_lb_col1 <- paste0(prefix, "CI_lb.", mode, "1")
  ci_ub_col1 <- paste0(prefix, "CI_ub.", mode, "1")
  ci_lb_col2 <- paste0(prefix, "CI_lb.", mode, "2")
  ci_ub_col2 <- paste0(prefix, "CI_ub.", mode, "2")
  
  # Remove duplicate pairs by keeping only top-bottom order
  data <- data %>%
    mutate(absdiff = abs(!!sym(prevalence_col1) - !!sym(prevalence_col2))) %>%  # Compute absolute difference
    mutate(diff = !!sym(prevalence_col1) - !!sym(prevalence_col2)) %>%  # Compute difference
    filter(diff >= 0) %>%  # Keep only positive differences
    mutate(sorted_pair = paste(sort(c(species1, species2)), collapse = " vs "))
  
  # Prepare data with pair labels and order by species alfabetically
  data <- data %>%
    mutate(pair_label = paste(species1, "vs", species2),
           pair_id = row_number(),
           pair_label_colored = paste0("<span style='color:salmon4'>", species1, "</span> vs <span style='color:skyblue4'>", species2, "</span>")) %>%
    arrange(desc(species1), desc(species2))
  
  # Data for species1 (top)
  species1_data <- data %>%
    select(pair_id, pair_label, pair_label_colored, species = species1, 
           prevalence = !!sym(prevalence_col1), 
           CI_lb = !!sym(ci_lb_col1), 
           CI_ub = !!sym(ci_ub_col1)) %>%
    mutate(species_type = "top")
  
  # Data for species2 (bottom)
  species2_data <- data %>%
    select(pair_id, pair_label, pair_label_colored, species = species2, 
           prevalence = !!sym(prevalence_col2), 
           CI_lb = !!sym(ci_lb_col2), 
           CI_ub = !!sym(ci_ub_col2)) %>%
    mutate(species_type = "bottom")
  
  # Combine into long format
  long_data <- bind_rows(species1_data, species2_data)
  long_data$pair_label <- factor(long_data$pair_label, levels = data$pair_label)
  
  # Data for connecting lines
  lines_data <- data %>%
    select(pair_label, pair_label_colored, 
           prevalence1 = !!sym(prevalence_col1), 
           prevalence2 = !!sym(prevalence_col2))
  lines_data$pair_label <- factor(lines_data$pair_label, levels = data$pair_label)
  
  # Create the plot
  pt <- ggplot(long_data, aes(x = prevalence, y = pair_label)) +
    geom_vline(xintercept = median_value, color = "black", size = 1.5) +
    geom_point(size = 2) +
    geom_errorbarh(aes(xmin = CI_lb, xmax = CI_ub, color = species_type), height = 0.5) +
    geom_segment(data = lines_data, 
                 aes(x = prevalence1, xend = prevalence2, 
                     y = pair_label, yend = pair_label), 
                 color = "black", alpha = 0.1) +
    scale_color_manual(values = c("top" = "salmon3", "bottom" = "skyblue3")) +
    scale_y_discrete(labels = setNames(data$pair_label_colored, data$pair_label)) +
    labs(x = title, y = "Candidate Species Contrasts") +
    theme_minimal() +
    theme(axis.text.y = element_markdown(size = 12),
          axis.title.x = element_text(size = 15, margin = margin(t = 20, r = 0, b = 0, l = 0)),
          axis.title.y = element_text(size = 15, margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.text.x = element_text(size = 12),
          legend.position = "none")
  
  return(pt)
}

# Create connected dot plots for malignant and neoplasia prevalence for Wilson and Jeffrey's methods
## Set output directory for plots
outdir_ci <- file.path(resultsDir, "1.Data-exploration/4.CI_overlaps")
createDir(outdir_ci)

## Jeffrey's method
malignant_plot.jeff <- create_connected_dot_plot(malignant_overlap_data.jeff, 
                                           prefix = "malignant_", 
                                           mode = "jeff",
                                           title = "Malignant Prevalence", median(cancer_traits_processed$malignant_prevalence))
# Save the plot
plot_path <- file.path(outdir_ci, "malignant_connected_dot_plot-jeff.png")
ggsave(plot = malignant_plot.jeff, plot_path, width = 10, height = 15, dpi = 320)

neoplasia_plot.jeff <- create_connected_dot_plot(neoplasia_overlap_data.jeff, 
                                           prefix = "neoplasia_", 
                                           mode = "jeff",
                                           title = "Neoplasia Prevalence", median(cancer_traits_processed$neoplasia_prevalence))
# Save the plot
plot_path <- file.path(outdir_ci, "neoplasia_connected_dot_plot-jeff.png")
ggsave(plot = neoplasia_plot.jeff, plot_path, width = 10, height = 15, dpi = 320)

# Print the plots 
# malignant_plot.wil
# neoplasia_plot.wil
malignant_plot.jeff
neoplasia_plot.jeff

# Make a small table accounting for the number of pairs in each dataset
# Create a table with the number of pairs in each dataset, differenciating between malignant and neoplasia, ZIMS and ACE, and Wilson and Jeffrey's methods

pairwise_counts <- data.frame(
  Dataset = c("ZIMS", "ACE"),
  Malignant_Jeffrey = c(nrow(malignant_overlap_data.jeff), nrow(malignant_overlap_data.jeff)),
  Neoplasia_Jeffrey = c(nrow(neoplasia_overlap_data.jeff), nrow(neoplasia_overlap_data.jeff))
)

pairwise_counts

```

## 3. Dealing with the contradictions

### 3.1. Quantile visualization
Here we will visualize the quartiles of malignant and neoplasia prevalence for both ZIMS and ACE datasets, highlighting the contradictions between them. The quartiles will be computed based on the mean prevalence of both datasets for each species.

```{r alt_data_work selection, dev="png", fig.width=10, fig.height=8, dpi=320}

# 3. DECONSTRUCTING THE CONTRADICTIONS  ------------------------------------------------------
## 3.1. Quartile visualization
zims_ace_data <- merge(cancer_traits_ci, alt_dataset_ci, by = "species", all.x = TRUE) %>%
  dplyr::rename(
    malignant_prevalence.ZIMS = malignant_prevalence,
    neoplasia_prevalence.ZIMS = neoplasia_prevalence,
    malignant_prevalence.ACE = MalignancyPrevalence,
    neoplasia_prevalence.ACE = NeoplasiaPrevalence
  ) %>%
  # Rename .x to .ZIMS and .y to .ACE
  rename_with(~ sub("\\.x$", ".ZIMS", .x), ends_with(".x")) %>%
  rename_with(~ sub("\\.y$", ".ACE", .x), ends_with(".y")) %>%
  # Select relevant columns, including Wilson and Jeffrey's CIs (e.g. .wil.ZIMS/.wil.ACE)
  select(species,
         # malignant_prevalence.ZIMS, malignant_CI_lb.wil.ZIMS, malignant_CI_ub.wil.ZIMS,
         # malignant_prevalence.ACE, malignant_CI_lb.wil.ACE, malignant_CI_ub.wil.ACE,
         # neoplasia_prevalence.ZIMS, neoplasia_CI_lb.wil.ZIMS, neoplasia_CI_ub.wil.ZIMS,
         # neoplasia_prevalence.ACE, neoplasia_CI_lb.wil.ACE, neoplasia_CI_ub.wil.ACE,
         malignant_prevalence.ZIMS, malignant_CI_lb.jeff.ZIMS, malignant_CI_ub.jeff.ZIMS,
         malignant_prevalence.ACE, malignant_CI_lb.jeff.ACE, malignant_CI_ub.jeff.ACE,
         neoplasia_prevalence.ZIMS, neoplasia_CI_lb.jeff.ZIMS, neoplasia_CI_ub.jeff.ZIMS,
         neoplasia_prevalence.ACE, neoplasia_CI_lb.jeff.ACE, neoplasia_CI_ub.jeff.ACE) %>%
  # For species present in both datasets, use the mean value to establish quartiles
  mutate(
    isBoth = !is.na(malignant_prevalence.ZIMS) & !is.na(malignant_prevalence.ACE),
    malignant_prevalence.mean = ifelse(!is.na(malignant_prevalence.ZIMS) & !is.na(malignant_prevalence.ACE),
                                  (malignant_prevalence.ZIMS + malignant_prevalence.ACE) / 2,
                                  ifelse(!is.na(malignant_prevalence.ZIMS), malignant_prevalence.ZIMS, malignant_prevalence.ACE)),
    neoplasia_prevalence.mean = ifelse(!is.na(neoplasia_prevalence.ZIMS) & !is.na(neoplasia_prevalence.ACE),
                                  (neoplasia_prevalence.ZIMS + neoplasia_prevalence.ACE) / 2,
                                  ifelse(!is.na(neoplasia_prevalence.ZIMS), neoplasia_prevalence.ZIMS, neoplasia_prevalence.ACE))
  )

# Save RDS object for algorithm run
saveRDS(zims_ace_data, file = file.path(outdir_ci, "zims_ace_data.rds"))

# Compute distribution quartiles
quartiles <- zims_ace_data %>%
  summarise(
    malignant_prevalence.mean = quantile(malignant_prevalence.mean, probs = c(0.25, 0.5, 0.75), na.rm = TRUE),
    neoplasia_prevalence.mean = quantile(neoplasia_prevalence.mean, probs = c(0.25, 0.5, 0.75), na.rm = TRUE)
  )

# Using the quartiles, set species as TOP, BOTTOM or INTERMEDIATE depending on the prevalence data from the ZIMS and ACE datasets.
# Two sets of columns, one for ZIMS and one for ACE. i.e. neoplasia_label.ZIMS, neoplasia_label.ACE, malignant_label.ZIMS, malignant_label.ACE
zims_ace_labeled <- zims_ace_data %>%
  mutate(
    # Malignant prevalence labels
    malignant_label.ZIMS = case_when(
      malignant_prevalence.ZIMS < quartiles$malignant_prevalence.mean[1] ~ "BOTTOM",
      malignant_prevalence.ZIMS >= quartiles$malignant_prevalence.mean[1] & malignant_prevalence.ZIMS < quartiles$malignant_prevalence[2] ~ "INTERMEDIATE",
      malignant_prevalence.ZIMS >= quartiles$malignant_prevalence.mean[2] ~ "TOP"
    ),
    malignant_label.ACE = case_when(
      malignant_prevalence.ACE < quartiles$malignant_prevalence.mean[1] ~ "BOTTOM",
      malignant_prevalence.ACE >= quartiles$malignant_prevalence.mean[1] & malignant_prevalence.ACE < quartiles$malignant_prevalence[2] ~ "INTERMEDIATE",
      malignant_prevalence.ACE >= quartiles$malignant_prevalence.mean[2] ~ "TOP"
    ),
    # Neoplasia prevalence labels
    neoplasia_label.ZIMS = case_when(
      neoplasia_prevalence.ZIMS < quartiles$neoplasia_prevalence.mean[1] ~ "BOTTOM",
      neoplasia_prevalence.ZIMS >= quartiles$neoplasia_prevalence.mean[1] & neoplasia_prevalence.ZIMS < quartiles$neoplasia_prevalence[2] ~ "INTERMEDIATE",
      neoplasia_prevalence.ZIMS >= quartiles$neoplasia_prevalence.mean[2] ~ "TOP"
    ),
    neoplasia_label.ACE = case_when(
      neoplasia_prevalence.ACE < quartiles$neoplasia_prevalence.mean[1] ~ "BOTTOM",
      neoplasia_prevalence.ACE >= quartiles$neoplasia_prevalence.mean[1] & neoplasia_prevalence.ACE < quartiles$neoplasia_prevalence[2] ~ "INTERMEDIATE",
      neoplasia_prevalence.ACE >= quartiles$neoplasia_prevalence.mean[2] ~ "TOP"
    )
  ) %>%
  # Keep only relevant columns
  select(species, malignant_prevalence.ZIMS, malignant_label.ZIMS, malignant_prevalence.ACE, malignant_prevalence.mean, malignant_label.ACE,
         neoplasia_prevalence.ZIMS, neoplasia_label.ZIMS, neoplasia_prevalence.ACE, neoplasia_prevalence.mean,neoplasia_label.ACE)

# Save the labeled data
prune_dir <- file.path(resultsDir, "1.Data-exploration/5.Data-curation_ZIMS-ACE")
createDir(prune_dir)
write.csv(zims_ace_labeled, file.path(prune_dir, "Compared_data_ZIMS-ACE.csv"), row.names = FALSE)

## PROCESSING THE CONTRADICTIONS
# 1. Tag contradictions only where BOTH are non-INTERMEDIATE and disagree
zims_ace_flagged <- zims_ace_labeled %>%
  mutate(
    malignant_contradictory = malignant_label.ZIMS != malignant_label.ACE &
                              !malignant_label.ZIMS %in% "INTERMEDIATE" &
                              !malignant_label.ACE %in% "INTERMEDIATE",
    neoplasia_contradictory = neoplasia_label.ZIMS != neoplasia_label.ACE &
                              !neoplasia_label.ZIMS %in% "INTERMEDIATE" &
                              !neoplasia_label.ACE %in% "INTERMEDIATE"
  )

# 2. Pivot malignant labels long, join flag; pivot neoplasia labels long, join flag; bind
mal_long <- zims_ace_flagged %>%
  select(species, malignant_contradictory,
         malignant_label.ZIMS, malignant_label.ACE, malignant_prevalence.mean) %>%
  pivot_longer(
    cols      = c(malignant_label.ZIMS, malignant_label.ACE),
    names_to  = c("trait", "dataset"),
    names_sep = "\\.",
    values_to = "label"
  ) %>%
  mutate(
    trait        = "Malignant",
    contradictory = malignant_contradictory
  )

neo_long <- zims_ace_flagged %>%
  select(species, neoplasia_contradictory,
         neoplasia_label.ZIMS, neoplasia_label.ACE, neoplasia_prevalence.mean) %>%
  pivot_longer(
    cols      = c(neoplasia_label.ZIMS, neoplasia_label.ACE),
    names_to  = c("trait", "dataset"),
    names_sep = "\\.",
    values_to = "label"
  ) %>%
  mutate(
    trait        = "Neoplasia",
    contradictory = neoplasia_contradictory
  )

long_data <- bind_rows(
  mal_long %>% rename(mean_prevalence = malignant_prevalence.mean),
  neo_long %>% rename(mean_prevalence = neoplasia_prevalence.mean)
) %>%
  mutate(label = factor(label, levels = c("BOTTOM", "INTERMEDIATE", "TOP")))

label_heatmap_data <- bind_rows(mal_long, neo_long) %>%
  mutate(
    dataset = dataset,
    label   = factor(label, levels = c("BOTTOM", "INTERMEDIATE", "TOP"))
  ) %>%
  mutate(
    species_label = case_when(
      contradictory == FALSE ~ species,
      contradictory == TRUE ~ paste0("<span style='color:salmon4'>", species, "</span>"),
      TRUE ~ species    
    )
  )

# Quartile boxplot including the contradictions (highlighted)
  
quartile_plot <- ggplot(label_heatmap_data, aes(x = dataset, y = species_label)) +
  geom_tile(aes(fill = label), color = "white") +
  scale_fill_manual(
    values   = c("BOTTOM" = "darkseagreen4",
                 "INTERMEDIATE" = "goldenrod1",
                 "TOP" = "salmon3"),
    na.value = "grey90"
  ) +
  geom_text(
    data    = filter(label_heatmap_data, contradictory),
    aes(label = "CONTRADICTED"),
    color   = "white",
    fontface = "bold",
    size    = 3
  ) +
  facet_wrap(~ trait, scales = "free_y") +
  theme_minimal() +
  labs(
    title = "Trait Labels Distribution by Dataset (Contradictions Highlighted)",
    x     = "Dataset",
    y     = "Species",
    fill  = "Quartile Label"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text  = element_text(face = "bold"),
    axis.text.y = element_markdown()
  )

# Save the quartile plot
plot_path <- file.path(prune_dir, "Quantile_overview")
createDir(plot_path)
ggsave(plot = quartile_plot, filename = file.path(plot_path, "quartile_plot.png"), width = 10, height = 8, dpi = 320)

quartile_plot

```

### 3.2. XY scatter plot of prevalence
This section creates an XY scatter plot comparing malignant and neoplasia prevalence between ZIMS and ACE datasets. It highlights contradictions in prevalence data, allowing for visual identification of inconsistencies. Takes into account sample sizes from both datasets.

```{r alt_data_work selection2, dev="png", fig.width=15, fig.height=10, dpi=320}

# 3.2. XY scatter plot of prevalence, red points = contradictions
# Prepare data for XY plot
xy_data <- zims_ace_flagged %>%
  select(species,
         malignant_prevalence.ZIMS, malignant_prevalence.ACE, malignant_contradictory,
         neoplasia_prevalence.ZIMS, neoplasia_prevalence.ACE, neoplasia_contradictory) %>%
  pivot_longer(
    cols      = c(malignant_prevalence.ZIMS, malignant_prevalence.ACE,
                  neoplasia_prevalence.ZIMS, neoplasia_prevalence.ACE),
    names_to  = c("trait", "dataset"),
    names_sep = "\\.",
    values_to = "prevalence"
  ) %>%
  pivot_wider(
    names_from  = dataset,
    values_from = prevalence
  ) %>%
  mutate(
    trait         = trait,
    contradicted  = if_else(trait == "malignant_prevalence",
                             malignant_contradictory,
                             neoplasia_contradictory)
  )

# Calculate regression coefficients
xy_contradiction <- ggplot(xy_data, aes(x = ZIMS, y = ACE)) +
  # Diagonal
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey80") +
  # Regression line
  geom_smooth(method = "lm", se = FALSE, color = "black", size = 0.5) +
  geom_point(aes(color = contradicted), size = 3) +
  scale_color_manual(
    values = c("FALSE" = "black", "TRUE" = "red"),
    labels = c("Consistent", "Contradicted"),
    name   = "Label\nConsistency"
  ) +
  geom_text_repel(aes(label = ifelse(contradicted, species, "")),
                  size = 3,
                  box.padding = 0.5,
                  point.padding = 0.5,
                  segment.color = "grey50",
                  show.legend = FALSE) +
  facet_wrap(~ trait, scales = "free") +
  theme_minimal() +
  labs(
    title = "ZIMS vs ACE Prevalence by Trait",
    x     = "ZIMS Prevalence",
    y     = "ACE Prevalence",
    caption = paste("Red points indicate contradictions between datasets.
    Dashed line is the diagonal.
    Full line is the regression line."))

# Save the XY plot
xy_contradiction
ggsave(plot = xy_contradiction, filename = file.path(plot_path, "xy_contradictions.png"), width = 10, height = 8, dpi = 320)

# Merge ZIMS and ACE sample data from the original dataset to the xy_data
zims_ace_sample_data <- merge(
  cancer_traits_processed[, c("species", "adult_necropsy_count")],
  alt_dataset_ci[, c("species", "RecordsWithDenominators")],
  by = "species",
  all.x = TRUE
)

xy_sampled <- merge(
  xy_data,
  zims_ace_sample_data,
  by = "species",
  all.x = TRUE
  ) %>%
  dplyr::rename(
    ZIMS_sample_size = adult_necropsy_count,
    ACE_sample_size = RecordsWithDenominators
  ) %>%
  # Prune contradicted NAs
  filter(!is.na(contradicted) )

# Lets rebuild the xy plot
## Now we will highlight the contradiction by outlining the points
## Coloring will be ACE sample size
## Size will be ZIMS sample size

xy_contradiction_sampled <- ggplot(xy_sampled, aes(x = ZIMS, y = ACE)) +
  geom_point(aes(color = ACE_sample_size, size = ZIMS_sample_size, shape = contradicted)) +
  scale_color_gradient(low = "skyblue", high = "skyblue4") +
  geom_text_repel(aes(label = species), size = 2, hjust = 0, vjust = 0, family = "Inter",
                  segment.size = 0.3, nudge_x = 0.010, nudge_y = 0.01, max.overlaps = Inf,
                  force = 1, max.iter = 10000, label.padding = 2, direction = "both",
                  min.segment.length = 0.06, seed = 1998, show.legend = FALSE) +
  # Diagonal line
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "grey80") +
  # Regression line
  geom_smooth(method = "lm", se = FALSE, color = "black", size = 0.5) +
  facet_wrap(~ trait, scales = "free") +
  theme_minimal() +
  # Adjust side panel size (tweak as needed)
  theme(ggside.panel.scale = 0.2) +
  labs(
    title = "ZIMS vs ACE Prevalence by Trait",
    x     = "ZIMS Prevalence",
    y     = "ACE Prevalence",
    caption = paste("Color gradient represents ACE sample size.\n",
                    "Size of points represents ZIMS sample size.\n",
                    "Dashed line is the diagonal. Full line is the regression line.\n",
                    "Blue density (top) shows all ZIMS values; red density (right) shows all ACE values.")
  )

xy_contradiction_sampled

# Save the sampled XY plot
ggsave(plot = xy_contradiction_sampled, filename = file.path(plot_path, "xy_contradictions_sampled.png"), width = 10, height = 8, dpi = 320)

```

### 3.3. Using the CIs to remove contradictions
#### Helper funcitons
Here we define helper functions to prepare phylogenetic labels, plot heatmaps, and save the results. These functions will be used to visualize the contradictions in the data based on the phylogenetic tree.

```{r setup_helpers, include=FALSE}
# Prepare phylogenetic labels
prepare_labels_phylo <- function(df, tip_order) {
  df %>%
    mutate(
      status   = if_else(contradicted, "Contradict", "Consistent"),
      species1 = factor(species1, levels = tip_order),
      species2 = factor(species2, levels = tip_order)
    )
}

# Plot and save heatmap
heatmap_and_save <- function(label_data, trait, method, results_path, tree) {
  mat <- label_data %>%
    select(species1, species2, status) %>%
    pivot_wider(names_from = species2, values_from = status, values_fill = NA) %>%
    column_to_rownames("species1") %>%
    as.matrix() %>%
    apply(2, function(col) ifelse(col == "Contradict", "Yes", ifelse(col == "Consistent", "No", NA)))
  
  row_tips <- rownames(mat)
  col_tips <- colnames(mat)
  
  tree_rows <- drop.tip(tree, setdiff(tree$tip.label, row_tips))
  tree_cols <- drop.tip(tree, setdiff(tree$tip.label, col_tips))
  
  mat <- mat[tree_rows$tip.label, tree_cols$tip.label]
  
  ht <- Heatmap(
    mat,
    name = paste0(method, "-", trait, "\nIs Contradictory"),
    col = c("No" = "darkseagreen4", "Yes" = "salmon4"),
    na_col = "gray90",
    rect_gp = gpar(col = "gray90", lwd = 1),
    cluster_rows = as.dendrogram.phylo(tree_rows),
    cluster_columns = as.dendrogram.phylo(tree_cols),
    row_dend_side = "left",
    column_dend_side = "top",
    row_dend_width = unit(10, "mm"),
    column_dend_height = unit(10, "mm"),
    show_row_names = TRUE,
    show_column_names = TRUE,
    row_names_gp = gpar(fontsize = 10),
    column_names_gp = gpar(fontsize = 10, hjust = 1),
    column_names_rot = 45
  )
  
  if (!is.null(results_path)) {
    dir.create(results_path, recursive = TRUE, showWarnings = FALSE)
    png(
      filename = file.path(results_path, paste0("Contradiction removal", "_", method, "_phylo_heatmap_", trait, ".png")),
      width = 14, height = 8, units = "in", res = 320
    )
    draw(ht, heatmap_legend_side = "right", annotation_legend_side = "right")
    dev.off()
  }
  return(ht)
}

# Plot and save dotplot
dot_and_save <- function(label_data, trait, method, results_path) {
  # Construct column names
  prevalence_col1.ZIMS <- paste0(trait, "_prevalence1.ZIMS")
  prevalence_col2.ZIMS <- paste0(trait, "_prevalence2.ZIMS")
  ci_lb_col1.ZIMS <- paste0(trait, "_CI_lb.", method, "1.ZIMS")
  ci_ub_col1.ZIMS <- paste0(trait, "_CI_ub.", method, "1.ZIMS")
  ci_lb_col2.ZIMS <- paste0(trait, "_CI_lb.", method, "2.ZIMS")
  ci_ub_col2.ZIMS <- paste0(trait, "_CI_ub.", method, "2.ZIMS")
  
  prevalence_col1.ACE <- paste0(trait, "_prevalence1.ACE")
  prevalence_col2.ACE <- paste0(trait, "_prevalence2.ACE")
  ci_lb_col1.ACE <- paste0(trait, "_CI_lb.", method, "1.ACE")
  ci_ub_col1.ACE <- paste0(trait, "_CI_ub.", method, "1.ACE")
  ci_lb_col2.ACE <- paste0(trait, "_CI_lb.", method, "2.ACE")
  ci_ub_col2.ACE <- paste0(trait, "_CI_ub.", method, "2.ACE")
  
  # Prepare data
  data <- label_data %>%
    mutate(absdiff.ZIMS = abs(!!sym(prevalence_col1.ZIMS) - !!sym(prevalence_col2.ZIMS))) %>%
    mutate(diff.ZIMS = !!sym(prevalence_col1.ZIMS) - !!sym(prevalence_col2.ZIMS)) %>%
    filter(diff.ZIMS >= 0) %>%
    mutate(pair_label = paste(species1, "vs", species2),
           pair_id = row_number(),
           pair_label_colored = paste0("<span style='color:salmon4'>", species1, "</span> vs <span style='color:skyblue4'>", species2, "</span>")) %>%
    arrange(desc(species1), desc(species2))

  # Long format for plotting
  species1_data <- data %>%
    select(pair_id, pair_label, pair_label_colored, species = species1, 
           prevalence.ZIMS = !!sym(prevalence_col1.ZIMS), prevalence.ACE = !!sym(prevalence_col1.ACE),
           CI_lb.ZIMS = !!sym(ci_lb_col1.ZIMS), CI_ub.ZIMS = !!sym(ci_ub_col1.ZIMS),
           CI_lb.ACE = !!sym(ci_lb_col1.ACE), CI_ub.ACE = !!sym(ci_ub_col1.ACE)) %>%
    mutate(species_type = "top")
  
  species2_data <- data %>%
    select(pair_id, pair_label, pair_label_colored, species = species2, 
           prevalence.ZIMS = !!sym(prevalence_col2.ZIMS), prevalence.ACE = !!sym(prevalence_col2.ACE),
           CI_lb.ZIMS = !!sym(ci_lb_col2.ZIMS), CI_ub.ZIMS = !!sym(ci_ub_col2.ZIMS),
           CI_lb.ACE = !!sym(ci_lb_col2.ACE), CI_ub.ACE = !!sym(ci_ub_col2.ACE)) %>%
    mutate(species_type = "bottom")
  
  long_data <- bind_rows(species1_data, species2_data)
  long_data$pair_label <- factor(long_data$pair_label, levels = data$pair_label)

  # Connecting lines
  lines_data.ZIMS <- data %>%
    select(pair_label, pair_label_colored, prevalence1.ZIMS = !!sym(prevalence_col1.ZIMS), prevalence2.ZIMS = !!sym(prevalence_col2.ZIMS))
  lines_data.ACE <- data %>%
    select(pair_label, pair_label_colored, prevalence1.ACE = !!sym(prevalence_col1.ACE), prevalence2.ACE = !!sym(prevalence_col2.ACE))

  # Plot with ACE offset above ZIMS
  pt <- ggplot(long_data, aes(y = pair_label_colored)) +
    # ZIMS: Points, error bars, segments
    geom_point(aes(x = prevalence.ZIMS, color = species_type, shape = species_type), size = 3) +
    geom_errorbarh(aes(xmin = CI_lb.ZIMS, xmax = CI_ub.ZIMS, color = species_type), height = 0.5, size = 0.5) +
    geom_segment(data = lines_data.ZIMS, aes(x = prevalence1.ZIMS, xend = prevalence2.ZIMS, yend = pair_label_colored), 
                 color = "darkseagreen4", size = 0.5, alpha = 0.1) +
    scale_color_manual(values = c("top" = "salmon3", "bottom" = "skyblue3")) +
    scale_shape_manual(values = c("top" = 16, "bottom" = 17)) +
    # Flush for new scale
    new_scale_color() +
    # ACE: Points, error bars, segments (nudged up)
    geom_point(aes(x = prevalence.ACE, color = species_type, shape = species_type), size = 3, position = position_nudge(y = 0.3)) +
    geom_errorbarh(aes(xmin = CI_lb.ACE, xmax = CI_ub.ACE, color = species_type), height = 0.5, size = 0.5, position = position_nudge(y = 0.3)) +
    scale_color_manual(values = c("top" = "orange3", "bottom" = "darkseagreen3")) +
    scale_shape_manual(values = c("top" = 16, "bottom" = 17)) +
    labs(x = paste0(trait, " Prevalence (", method, ")"), y = "Species Pair") +
    theme_minimal() +
    theme(axis.text.y = element_markdown(size = 12),
          axis.title.x = element_text(size = 15),
          axis.title.y = element_text(size = 15),
          axis.text.x = element_text(size = 12),
          legend.position = "none")

  # Save plot
  ggsave(file.path(results_path, paste0("DotPlot_", trait, "_", method, ".png")), pt, width = 8, height = 16)
  return(pt)
}

# Write results to CSV files
write_results <- function(df_all, df_ok, df_contr, trait, method, results_path) {
  if (!is.null(results_path)) {
    write.csv(df_all, file.path(results_path, paste0("Contradiction removal", "_", method, "_", trait, ".csv")), row.names = FALSE)
    write.csv(df_ok, file.path(results_path, paste0("Contradiction removal", "_", method, "_", trait, "_OK.csv")), row.names = FALSE)
    write.csv(df_contr, file.path(results_path, paste0("Contradiction removal", "_", method, "_", trait, "_KO.csv")), row.names = FALSE)
  }
}
```

#### Generalized Approach
This chunk contains contradiction logic. It defines a function to check for contradictions in the prevalence data of malignant and neoplasia traits between ZIMS and ACE datasets. It also includes a generalized approach to process both traits, create pairwise data, and visualize results using heatmaps and dot plots.

```{r generalized_approach, dev="png", fig.width=16, fig.height=8, dpi=320}

## 3.3. Using the CIs to remove contradictions
# Contradiction logic
contradiction_func <- function(df, trait, method) {
  df %>%
    rowwise() %>%
    mutate(
      s1ACE_notov = if (s1_in_ACE) {
        .data[[paste0(trait, "_prevalence1.ACE")]] <= .data[[paste0(trait, "_CI_lb.", method, "1.ZIMS")]] |
        .data[[paste0(trait, "_prevalence1.ACE")]] >= .data[[paste0(trait, "_CI_ub.", method, "1.ZIMS")]]
      } else FALSE,
      s2ACE_notov = if (s2_in_ACE) {
        .data[[paste0(trait, "_prevalence2.ACE")]] <= .data[[paste0(trait, "_CI_lb.", method, "2.ZIMS")]] |
        .data[[paste0(trait, "_prevalence2.ACE")]] >= .data[[paste0(trait, "_CI_ub.", method, "2.ZIMS")]]
      } else FALSE,
      contradicted = s1ACE_notov | s2ACE_notov
    ) %>%
    ungroup()
}

# Generalized function for both approaches
general_approach <- function(zims_ace_data, method = "jeff", results_path = NULL, tree) {
  tip_order <- tree$tip.label
  
  # Build pairwise data
  pairwise_data <- zims_ace_data %>%
    rename_with(~ sub("\\.ZIMS$", "1.ZIMS", .x), ends_with(".ZIMS")) %>%
    rename_with(~ sub("\\.ACE$", "1.ACE", .x), ends_with(".ACE")) %>%
    inner_join(
      ., 
      rename_with(., ~ sub("1\\.", "2\\.", .x)),
      by = character(),
      suffix = c("1", "2")
    )
  
  # Process traits
  traits <- c("malignant", "neoplasia")
  results <- list()
  for (trait in traits) {
    df <- pairwise_data %>%
      mutate(
        diff = .data[[paste0(trait, "_prevalence1.ZIMS")]] - .data[[paste0(trait, "_prevalence2.ZIMS")]],
        ov_ZIMS = (
          .data[[paste0(trait, "_CI_lb.", method, "1.ZIMS")]] <= .data[[paste0(trait, "_CI_ub.", method, "2.ZIMS")]] &
          .data[[paste0(trait, "_CI_lb.", method, "2.ZIMS")]] <= .data[[paste0(trait, "_CI_ub.", method, "1.ZIMS")]]
        )
      ) %>%
      filter(!ov_ZIMS, diff >= 0) %>%
      mutate(absdiff = abs(diff))
    results[[trait]] <- df
  }
  
  for (trait in traits) {
    results[[trait]] <- results[[trait]] %>%
      mutate(
        s1_in_ACE = !is.na(.data[[paste0(trait, "_prevalence1.ACE")]]),
        s2_in_ACE = !is.na(.data[[paste0(trait, "_prevalence2.ACE")]])
      ) %>%
      contradiction_func(trait, method)
  }
  
  # Extract results
  MP <- results$malignant
  NP <- results$neoplasia
  MP_def <- MP %>% filter(!contradicted)
  NP_def <- NP %>% filter(!contradicted)
  MP_contr <- MP %>% filter(contradicted)
  NP_contr <- NP %>% filter(contradicted)
  
  # Prepare labels and plot
  label_MP <- prepare_labels_phylo(MP, tip_order)
  label_NP <- prepare_labels_phylo(NP, tip_order)
  ht_MP <- heatmap_and_save(label_MP, "malignant", method, results_path, tree)
  ht_NP <- heatmap_and_save(label_NP, "neoplasia", method, results_path, tree)
  dot_MP <- dot_and_save(label_MP, "malignant", method, results_path)
  dot_NP <- dot_and_save(label_NP, "neoplasia", method, results_path)
  
  # Write results
  write_results(MP, MP_def, MP_contr, "malignant", method, results_path)
  write_results(NP, NP_def, NP_contr, "neoplasia", method, results_path)
  
  # Return results
  list(
    pairwise = pairwise_data,
    MP_all = MP,
    NP_all = NP,
    malignant_OK = MP_def,
    neoplasia_OK = NP_def,
    malignant_X = MP_contr,
    neoplasia_X = NP_contr,
    label_MP = label_MP,
    label_NP = label_NP,
    plot_MP = ht_MP,
    plot_NP = ht_NP,
    dot_MP = dot_MP,
    dot_NP = dot_NP
  )
}

# conflicts_wil <- general_approach(zims_ace_data, method = "wil", 
#                               results_path = file.path(resultsDir, "1.Data-exploration/5.Data-curation_ZIMS-ACE/Wilson"), tree)

conflicts_jeff <- general_approach(zims_ace_data, method = "jeff", 
                              results_path = file.path(prune_dir, "Jeffrey"), tree)

# Save RDS object for algorithm run
saveRDS(conflicts_jeff, file = file.path(prune_dir, "Jeffrey/conflicts_jeff.rds"))

print("Contradiction Removal - Jeffrey's CI")
conflicts_jeff$plot_MP
conflicts_jeff$plot_NP

```

#### Dot Plots for CI visualization
This section generates dot plots to visualize the confidence intervals (CIs) for malignant and neoplasia traits between ZIMS and ACE datasets. It highlights the consistency of intervals across both datasets.

```{r generalized_approach2, dev="png", fig.width=8, fig.height=16, dpi=320}

#### Dot Plots for CI visualization. This is separated from the previous chunk because of figure sizing.
print("Interval consistence between ZIMS and ACE")
conflicts_jeff$dot_MP
conflicts_jeff$dot_NP

```

### Summary of Trait Differences
This section summarizes the differences in prevalence of malignant and neoplasia traits between ZIMS and ACE datasets, focusing on pairs where ZIMS prevalence is greater than or equal to ACE prevalence. It counts the number of such pairs for each trait and method.

```{r pheno_diff_summary}

# Summary of Trait Differences
ok_pairs <- function(my_trait, df) {
  trait_col1 <- paste0(my_trait, "_prevalence1.ZIMS")
  trait_col2 <- paste0(my_trait, "_prevalence2.ZIMS")
  
  df %>%
    mutate(
      diff = !!sym(trait_col1) - !!sym(trait_col2),
      absdiff = abs(!!sym(trait_col1) - !!sym(trait_col2))
    ) %>%
    filter(diff >= 0) %>%
    select(species1, species2, diff, absdiff)
}

mp_ok_jeff <- ok_pairs("malignant", conflicts_jeff$malignant_OK)
np_ok_jeff <- ok_pairs("neoplasia", conflicts_jeff$neoplasia_OK)

trait_method_counts <- tibble::tibble(
  trait = c("malignant", "neoplasia"),
  method = c("jeff", "jeff"),
  count = c(
    nrow(mp_ok_jeff), nrow(np_ok_jeff)
  )
)

print(trait_method_counts)

```

