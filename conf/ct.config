/*
 * CAASTOOLS (CT) configuration
 */
params {
    // CT general option
    ct_tool                     = ct_tool                   ?: "" // Options: "discovery", "resample", "bootstrap", "all"

    // Common DISCOVERY and BOOTSTRAP options
    alignment                   = alignment                 ?: "$baseDir/Data/protein_alignments/**/*" // Path to alignments directory
    caas_config                 = caas_config               ?: "$baseDir/Data/CAAS_traitfiles/traitfile.tab" // Path to CAASTOOLS configuration file
    ali_format                  = ali_format                ?: "phylip-relaxed" // Alignment file format
    patterns                    = patterns                  ?: "1,2,3" // CAAS patterns to search for, comma-separated

    // Check CAASTOOLS documentation for description of these parameters
    // For missing and gap thresholds, "NO" means no threshold applied
    maxbggaps                   = maxbggaps                 ?: "0" // Maximum background gaps allowed
    maxfggaps                   = maxfggaps                 ?: "0" // Maximum foreground gaps allowed
    maxgaps                     = maxgaps                   ?: "NO" // Maximum total gaps allowed
    maxgapsperposition          = maxgapsperposition        ?: "0.5" // Maximum gaps per position allowed
    maxbgmiss                   = maxbgmiss                 ?: "0" // Maximum background missing allowed
    maxfgmiss                   = maxfgmiss                 ?: "0" // Maximum foreground missing allowed
    maxmiss                     = maxmiss                   ?: "NO" // Maximum total missing allowed
    paired_mode                 = paired_mode               ?: true // Whether to use paired mode (3 column traitfile required)
    miss_pair                   = miss_pair                 ?: false // Enforce missing pairs in paired mode (when fg/bg miss is the same)
    max_conserved               = max_conserved             ?: "1" // Maximum number of conserved amino acids between fg and bg
    caap_mode                   = caap_mode                 ?: true // Whether to use CAAP mode (properties-based)

    // RESAMPLE options
    tree                        = tree                      ?: "$baseDir/Data/5.Phylogeny/science.abn7829_data_s4.nex.tree" // Path to species tree file (newick)
    strategy                    = strategy                  ?: "BM" // Resampling strategy: "BM" (Brownian Motion) or "random"
    fgsize                      = fgsize                    ?: "6" // Foreground size (for strategy random)
    bgsize                      = bgsize                    ?: "6" // Background size (for strategy random)
    perm_strategy               = perm_strategy             ?: "BM" // Permutation strategy: "FGBG" | "BM"
    traitvalues                 = traitvalues               ?: "TBD" // Path to trait values file (for strategy BM)
    cycles                      = cycles                    ?: "1000" // Number of resampling cycles
    chunk_size                  = chunk_size                ?: "500" // Max number of resampled groups per output file
    include_b0                  = include_b0                ?: false // Whether to include the main hypothesis (b0) in the analysis

    // BOOTSTRAP options
    resample_out               = resample_out               ?: null // Path to resample output from previous CT RESAMPLE run
    progress_log               = progress_log               ?: "none" // Path to progress log file
    discovery_out              = discovery_out              ?: "none" // Path to discovery output directory from previous CT DISCOVERY run
    //// Do not run these debug options unless needed and always check with very small number of cycles ////
    export_groups              = export_groups              ?: "none" // Path to export groups file (DEBUG)
    export_perm_discovery      = export_perm_discovery      ?: "none" // Path to export permuted discovery file (DEBUG)
}

process {
    withName: 'DISCOVERY' {
        ext.args = """--patterns ${params.patterns}
        --max_bg_gaps ${params.maxbggaps}
        --max_fg_gaps ${params.maxfggaps}
        --max_gaps ${params.maxgaps}
        --max_gaps_per_position ${params.maxgapsperposition}
        --max_bg_miss ${params.maxbgmiss}
        --max_fg_miss ${params.maxfgmiss}
        --max_miss ${params.maxmiss}
        ${params.paired_mode ? '--paired_mode' : ''}
        ${params.miss_pair ? '--miss_pair' : ''}
        --max_conserved ${params.max_conserved}
        ${params.caap_mode ? '--caap_mode' : ''}"""
        publishDir = [
            path: { "${params.outdir}/discovery" },
            mode: 'copy',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'RESAMPLE' {
        ext.args = "--cycles ${params.cycles} --chunk_size ${params.chunk_size}"
        publishDir = [
            path: { "${params.outdir}/resample" },
            mode: 'copy',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'BOOTSTRAP' {
        ext.args = """--patterns ${params.patterns}
        --max_bg_gaps ${params.maxbggaps}
        --max_fg_gaps ${params.maxfggaps}
        --max_gaps ${params.maxgaps}
        --max_gaps_per_position ${params.maxgapsperposition}
        --max_bg_miss ${params.maxbgmiss}
        --max_fg_miss ${params.maxfgmiss}
        --max_miss ${params.maxmiss}
        ${params.paired_mode ? '--paired_mode' : ''}
        ${params.miss_pair ? '--miss_pair' : ''}
        --max_conserved ${params.max_conserved}
        ${params.caap_mode ? '--caap_mode' : ''}"""
        publishDir = [
            path: { "${params.outdir}/bootstrap" },
            mode: 'copy',
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}
