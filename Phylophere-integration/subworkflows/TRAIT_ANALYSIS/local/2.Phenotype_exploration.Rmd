---
title: "Exploring the phenotype"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r header}

#  ██████╗ ██╗  ██╗██╗   ██╗██╗      ██████╗ ██████╗ ██╗  ██╗███████╗██████╗ ███████╗
#  ██╔══██╗██║  ██║╚██╗ ██╔╝██║     ██╔═══██╗██╔══██╗██║  ██║██╔════╝██╔══██╗██╔════╝
#  ██████╔╝███████║ ╚████╔╝ ██║     ██║   ██║██████╔╝███████║█████╗  ██████╔╝█████╗
#  ██╔═══╝ ██╔══██║  ╚██╔╝  ██║     ██║   ██║██╔═══╝ ██╔══██║██╔══╝  ██╔══██╗██╔══╝
#  ██║     ██║  ██║   ██║   ███████╗╚██████╔╝██║     ██║  ██║███████╗██║  ██║███████╗
#  ╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝ ╚═════╝ ╚═╝     ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝

## PHYLOPHERE: A Nextflow pipeline including a complete set
## of phylogenetic comparative tools and analyses for Phenome-Genome studies

### Github: https://github.com/nozerorma/caastools/nf-phylophere
### Author: Miguel Ramon (miguel.ramon@upf.edu)

#### File: phenotype_exploration.Rmd

```

# Phenotype Exploration
This script allows for the visualization of trait distributions and phylogenetic patterns. The script includes contrast plots and phylogenetic trees to assess trait relationships.

## Setup and Directory Configuration
This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}
# Call the setup function from commons.R
source("./obj/commons.R")
setup_rmd()

# Load necessary libraries
library(dplyr)
library(ggplot2)
library(readr)
library(reshape2)
library(ggrepel)
library(ggtree)
library(ggnewscale)
library(ggstar)
library(colorspace)
library(treeio)
library(tidytree)
library(phylolm)
library(ggtreeExtra)
library(geiger)

# Create directories for outputs
createDir(extreme_plots_dir)

```

## 1. Data Import
This section imports trait summary data from the dataset exploration stage.

```{r trait_import}
# Load summary stats from Dataset Exploration
stats_path <- file.path(species_distribution_dir, "trait_stats.csv")
if (!file.exists(stats_path)) {
  stop("Missing trait stats file: ", stats_path)
}
stats_df <- read.csv(stats_path, stringsAsFactors = FALSE)
```

## 1. Load Melted Trait Data
This section loads pre-processed trait data in a long (melted) format and adds common names for species.

```{r, stat_visualization, fig.width=10, fig.height=5, dev="png"}

# 1. LOAD STATS ------------------------------------------------------
# Excerpt of the trait stats data
head(stats_df)

```

# 3. Contrast Plots
This section generates contrast plots to visualize the trait across taxa, highlighting extreme values and outliers.

```{r phenoplot, fig.height=10, fig.width=15, message=FALSE, warning=FALSE, dev='png'}

# Objects
color_palette <- paste0(clade_name, "_palette") # Color palette for the clade
capitalized_taxon <- tools::toTitleCase(taxon_of_interest) # Capitalized taxon name
capitalized_trait <- tools::toTitleCase(gsub("_", " ", trait)) # Capitalized and deconvoluted trait name
color.sym <- rlang::sym(color_palette) # Symbol for the color palette
taxa.sym <- rlang::sym(taxon_of_interest) # Symbol for the taxon of interest
trait.sym <- rlang::sym(trait) # Symbol for the trait of interest

# 3. CONTRAST PLOTS  ------------------------------------------------------
# Function to generate contrast plots
# Generate and save contrast plot
contrast_graph <- contrast_plot.f(stats_df)
ggplot2::ggsave(
  file.path(extreme_plots_dir, paste0(trait, "_contrast_plot.png")),
  contrast_graph, device = "png", width = 15, height = 10, dpi = "retina"
)

# Display plots
contrast_graph

```

## Session Information

```{r session_info}
sessionInfo()
```