---
title: "Data Visualization for trait analysis"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r header}

#  ██████╗ ██╗  ██╗██╗   ██╗██╗      ██████╗ ██████╗ ██╗  ██╗███████╗██████╗ ███████╗
#  ██╔══██╗██║  ██║╚██╗ ██╔╝██║     ██╔═══██╗██╔══██╗██║  ██║██╔════╝██╔══██╗██╔════╝
#  ██████╔╝███████║ ╚████╔╝ ██║     ██║   ██║██████╔╝███████║█████╗  ██████╔╝█████╗
#  ██╔═══╝ ██╔══██║  ╚██╔╝  ██║     ██║   ██║██╔═══╝ ██╔══██║██╔══╝  ██╔══██╗██╔══╝
#  ██║     ██║  ██║   ██║   ███████╗╚██████╔╝██║     ██║  ██║███████╗██║  ██║███████╗
#  ╚═╝     ╚═╝  ╚═╝   ╚═╝   ╚══════╝ ╚═════╝ ╚═╝     ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝

## PHYLOPHERE: A Nextflow pipeline including a complete set
## of phylogenetic comparative tools and analyses for Phenome-Genome studies

### Github: https://github.com/nozerorma/caastools/nf-phylophere
### Author: Miguel Ramon (miguel.ramon@upf.edu)

#### File: dataset_exploration.Rmd

```

# Data Visualization and Processing

Script to visualize and process data. It generates family distribution plots, summary tables, and a processed dataset.

---

## Setup and Directory Configuration
This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}
# Call the setup function from commons.R
source("./obj/commons.R")
setup_rmd()

# Load necessary libraries
library(dplyr)
library(ggplot2)
library(readr)
library(reshape2)

# Create directories for outputs
createDir(species_distribution_dir)

```

## 1. Dataset Visualization
This section visualizes the distribution of species across families to provide an overview of the dataset.

```{r dataset_visualization, fig.height=7, fig.width=7, dev='png', dpi=320}

# Objects
color_palette <- paste0(clade_name, "_palette") # Color palette for the clade
capitalized_taxon <- tools::toTitleCase(taxon_of_interest) # Capitalized taxon name
capitalized_trait <- tools::toTitleCase(gsub("_", " ", trait)) # Capitalized and deconvoluted trait name
color.sym <- rlang::sym(color_palette) # Symbol for the color palette
taxa.sym <- rlang::sym(taxon_of_interest) # Symbol for the taxon of interest
trait.sym <- rlang::sym(trait) # Symbol for the trait of interest

# 1. DATA VISUALIZATION  ------------------------------------------------------
# Calculate species count per taxon_of_interest
taxa_distribution <- trait_df %>%
  dplyr::group_by(!!taxa.sym) %>%
  dplyr::summarise(count = n())

# Create bar plot for taxa distribution
p1 <- taxa_plot.f(taxa_distribution)

# Save the plot to the results directory
ggplot2::ggsave(file.path(species_distribution_dir, paste0(clade_name, "_", taxon_of_interest, "_distribution.png")), p1, 
                device = "png", width = 10, height = 10, dpi = "retina")

# Display the plot
p1

```

## 2. Data Processing and statistical overview

```{r stats_overview}

# Apply stats.f to trait_df
stats_df <- stats.f(trait_df)

# Save the melted dataframe
save_path <- file.path(species_distribution_dir, "trait_stats.csv")
if (!is.null(stats_df)) {
  write.csv(stats_df, save_path, row.names = FALSE)
}

# Print an excerpt
if (!is.null(stats_df)) {
  print(head(stats_df))
}

```

## Session Information

```{r session_info}
sessionInfo()
```