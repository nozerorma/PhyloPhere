---
title: "Rand analysis"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
citations:  
  output: 
  html_document: default
pdf_document: default
---

# Randomization analysis
This document processes randomization results for malignant and neoplasia prevalence in primates, aggregates results across subanalyses, and extracts significant genes based on p-value criteria. It also saves the aggregated results and significant gene lists for further analysis.

It is the same analysis, restricted to only genes in which changes have been observed in all three hypothesis.

## Setup and Directory Configuration

This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)

```

```{r dirdef, message=FALSE, warning=FALSE}

# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.

```

## Seed and library loading

```{r message=FALSE, warning=FALSE, r,warning=FALSE}

library(dplyr)
library(stats)  # For norm.sf

```

## 1. Load the randomization dataframes
Here we will load the randomization results for malignant and neoplasia prevalence, process them by approach and pattern type, and aggregate the results across subanalyses. The final output will include aggregated results and significant gene lists based on p-value criteria.

```{r rand_analysis, message=FALSE, warning=FALSE}

rand_dir <- file.path(resultsDir, "2.CAAS/5.Randomizations")

# List files for malignant_prevalence and neoplasia_prevalence
mp_rand_files <- list.files(
  path = file.path(rand_dir, "malignant_prevalence"), 
  pattern = "_aggregated_results.csv", 
  full.names = TRUE, 
  recursive = TRUE
)

np_rand_files <- list.files(
  path = file.path(rand_dir, "neoplasia_prevalence"), 
  pattern = "_aggregated_results.csv", 
  full.names = TRUE, 
  recursive = TRUE
)

# Process files by approach and pattern type
process_files_by_approach_and_pattern <- function(file_list, rand_dir, caas_dir) {
  approach_data <- list()
  
  for (x in file_list) {
    # Extract approach and contrast number from file path
    subdir_full <- gsub(paste0(rand_dir, "/"), "", x)
    parts <- strsplit(subdir_full, "/")[[1]]
    trait <- parts[1]  # e.g., "malignant_prevalence"
    approach <- parts[3]  # e.g., "naive"
    contrast_dir <- parts[4]  # e.g., "results_1"
    # Extract contrast number (if name results_1, get 1)
    contrast_number <- gsub("results_", "", contrast_dir)
    # Filename
    filename <- parts[5]  # e.g., "results_1_*_aggregated_results.csv" where * can be multiple things
    # Determine subset type from filename (the * part)
    subset_type <- sub("results_\\d+_(.*?)_aggregated_results\\.csv", "\\1", filename)
    
    # Print parts
    print(paste("Trait:", trait, "Approach:", approach, "Contrast number:", contrast_number, "Subset type:", subset_type,
                "Filename:", filename))

    # Read randomization results
    data <- read.csv(x, stringsAsFactors = FALSE)

    # Store data
    approach_data[[approach]][[paste0("contrast_", contrast_number)]][[subset_type]] <- data
  }
    return(approach_data)
}

# Process files
mp_rand_processed <- process_files_by_approach_and_pattern(mp_rand_files, rand_dir)
np_rand_processed <- process_files_by_approach_and_pattern(np_rand_files, rand_dir)

combine_stats <- function(sublist, subset_type) {
  combined_df <- do.call(rbind, sublist)

  # Column names depend on subset_type suffix
  col_actual <- paste0("ActualCount_", subset_type)
  col_above  <- paste0("RandsAbove_", subset_type)
  col_numr   <- paste0("NumRands_", subset_type)
  col_pval   <- paste0("PValueEmpirical_", subset_type)

  aggregated <- combined_df %>%
    group_by(Gene) %>%
    summarise(
      ActualCount_Total = sum(.data[[col_actual]], na.rm = TRUE),
      RandsAbove_Total  = sum(.data[[col_above]],  na.rm = TRUE),
      NumRands_Total    = sum(.data[[col_numr]],   na.rm = TRUE),
      NumPairs          = n(),
      Pvalue_simple     = (RandsAbove_Total + 1) / (NumRands_Total + 1),
      PValueEmpirical_Combined = {
        chi_sq <- -2 * sum(log(.data[[col_pval]]), na.rm = TRUE)
        pchisq(chi_sq, df = 2 * NumPairs, lower.tail = FALSE)
      }
    ) %>%
    mutate(
      PValue_simple_BH   = p.adjust(Pvalue_simple, method = "BH"),
      PValueEmpirical_BH = p.adjust(PValueEmpirical_Combined, method = "BH")
    ) %>%
    arrange(PValueEmpirical_Combined)

  return(aggregated)
}

aggregate_data <- function(processed_data) {
  aggregated_data <- list()

  for (approach in names(processed_data)) {
    subset_types <- unique(unlist(lapply(processed_data[[approach]], names)))
    aggregated_results <- list()
    
    for (subset_type in subset_types) {
      sublist <- lapply(processed_data[[approach]], function(x) x[[subset_type]])
      sublist <- Filter(Negate(is.null), sublist)

      if (length(sublist) > 0) {
        aggregated_df <- combine_stats(sublist, subset_type)
        aggregated_results[[subset_type]] <- aggregated_df
      }
    }

    aggregated_data[[approach]] <- aggregated_results
  }

  return(aggregated_data)
}


# Aggregate data
mp_aggregated_files <- aggregate_data(mp_rand_processed)
np_aggregated_files <- aggregate_data(np_rand_processed)
  
  
  
  
# Save aggregated data
output_dir <- file.path(resultsDir, "2.CAAS/4.5.Rand_results")
createDir(output_dir)

# Malignant prevalence
for (approach in names(mp_aggregated_files)) {
  print(paste("Saving results for approach:", approach))
  path <- file.path(output_dir, "malignant_prevalence", approach)
  createDir(path)
  for (df_name in names(mp_aggregated_files[[approach]])) {
    print(paste("Dataframe name:", df_name))
    output_file <- file.path(path, paste0(df_name, "_aggregated_results.csv"))
    write.csv(mp_aggregated_files[[approach]][[df_name]], file = output_file, row.names = FALSE)
  }
}

# Neoplasia prevalence
for (approach in names(np_aggregated_files)) {
  print(paste("Saving results for approach:", approach))
  path <- file.path(output_dir, "neoplasia_prevalence", approach)
  createDir(path)
  for (df_name in names(np_aggregated_files[[approach]])) {
    print(paste("Dataframe name:", df_name))
    output_file <- file.path(path, paste0(df_name, "_aggregated_results.csv"))
    write.csv(np_aggregated_files[[approach]][[df_name]], file = output_file, row.names = FALSE)
  }
}

# Function to extract gene lists based on p-value criteria
extract_significant_genes <- function(df, criteria, out_dir, prefix) {
  for (crit in criteria) {
    sig_genes <- df %>% filter(.data[[crit]] <= 0.05) %>% pull(Gene) %>% unique()
    writeLines(sig_genes, con = file.path(out_dir, paste0(prefix, "_", crit, "_genes.txt")))
  }
}

# Define p-value criteria
pvalue_criteria <- c("Pvalue_simple", "PValueEmpirical_Combined", 
                     "PValue_simple_BH", "PValueEmpirical_BH")

# Output directory for gene lists
gene_list_dir <- file.path(resultsDir, "2.CAAS/4.5.Rand_results/GeneLists")
createDir(gene_list_dir)

# Process malignant and neoplasia separately
for (trait in c("malignant_prevalence", "neoplasia_prevalence")) {
  for (approach in names(if (trait == "malignant_prevalence") mp_aggregated_files else np_aggregated_files)) {
    for (pattern_type in names(if (trait == "malignant_prevalence") mp_aggregated_files[[approach]] else np_aggregated_files[[approach]])) {
      df <- if (trait == "malignant_prevalence") {
        mp_aggregated_files[[approach]][[pattern_type]]
      } else {
        np_aggregated_files[[approach]][[pattern_type]]
      }
      out_dir <- file.path(gene_list_dir, trait, pattern_type)
      createDir(out_dir)
      prefix <- paste(approach, trait, pattern_type, sep = "_")
      extract_significant_genes(df, pvalue_criteria, out_dir, prefix)
    }
  }
}

# Function to extract gene lists based on p-value criteria
extract_significant_genes <- function(df, criteria, out_dir, prefix) {
  for (crit in criteria) {
    sig_genes <- df %>% filter(.data[[crit]] <= 0.1) %>% pull(Gene) %>% unique()
    writeLines(sig_genes, con = file.path(out_dir, paste0(prefix, "_", crit, "_genes.txt")))
  }
}

# Output directory for gene lists
gene_list_dir <- file.path(resultsDir, "2.CAAS/4.5.Rand_results/GeneLists.01")
createDir(gene_list_dir)


# Process malignant and neoplasia separately
for (trait in c("malignant_prevalence", "neoplasia_prevalence")) {
  for (approach in names(if (trait == "malignant_prevalence") mp_aggregated_files else np_aggregated_files)) {
    for (pattern_type in names(if (trait == "malignant_prevalence") mp_aggregated_files[[approach]] else np_aggregated_files[[approach]])) {
      df <- if (trait == "malignant_prevalence") {
        mp_aggregated_files[[approach]][[pattern_type]]
      } else {
        np_aggregated_files[[approach]][[pattern_type]]
      }
      out_dir <- file.path(gene_list_dir, trait, pattern_type)
      createDir(out_dir)
      prefix <- paste(approach, trait, pattern_type, sep = "_")
      extract_significant_genes(df, pvalue_criteria, out_dir, prefix)
    }
  }
}

```