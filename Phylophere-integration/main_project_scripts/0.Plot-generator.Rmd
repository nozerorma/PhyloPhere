---
title: "plotter"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
output:
html_document: default
pdf_document: default
---

################################## 

# PLOTTER

### PRIMATES' NEOPLASY PROJECT

### MIGUEL RAMON ALONSO

################################## 

## Setup and Directory Configuration
This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)

```


```{r dirdef, message=FALSE, warning=FALSE}

# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.

```

# THIS SCRIPT IS A PLOTTER FOR THE NEOPLASY PROJECT

## 1. Dataset exploratory plots

```{r data_exp, fig.height=7, fig.width=7, message=FALSE, warning=FALSE, dev='png', dpi=320}

# Compare species number and in-family distributions
family_distribution <- traits %>%
  group_by(family) %>%
  summarise(count = n())

# Family plot
family_plot <- ggplot(family_distribution, aes(x = family, y = count, fill = family)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=count), vjust=0.5, hjust = -1, color="black", fontface = "bold", size=6) +
  labs(x = "Family", y = "Count", title = "Family Distribution") +
  theme_minimal() +
  scale_fill_manual(values = primate_family_colors, breaks = 0) +
  # Increase y axis up to 15
  scale_y_continuous(limits = c(0, 15), expand = c(0, 0)) +
  theme(
    axis.text.y = element_text(hjust = 1, size = 18, face = "bold", color = "black"),
    axis.text.x = element_blank(),
    plot.title = element_blank(),
    axis.title.x = element_text(size = 18, hjust = 0.5, margin = margin(t = 20), face = "bold", color = "black"),
    axis.title.y = element_blank(),
    legend.position = "none"
  ) +
  coord_flip()

family_plot

# # Save the family distribution plot
# compare_plot_path <- file.path(resultsDir, "1.Data-exploration/1.Species_distribution")
# createDir(compare_plot_path)
# ggsave(file.path(compare_plot_path, "family_distribution.png"), family_plot, device = "png", width = 10, height = 10, dpi = "retina")


```


```{r data_prep_plots, fig.height=12, fig.width=15, message=FALSE, warning=FALSE, dev='png', dpi=320}
# Data
cancer_dir <- file.path(dataDir, "1.Cancer_data/Neoplasia_species360/CIs")
pairwise_data.end <- read.csv(file.path(cancer_dir, "pairwise_data-jeff.csv"), header=TRUE, sep=",")
my_labels_colored <- read.csv(file.path(cancer_dir, "my_labels_colored.csv"), header=TRUE, sep=",")

p <- ggplot(pairwise_data.end, aes(x = species2, y = species1, fill = abs(diff_value))) +
  geom_tile(color = "black", size = 0.25) +
  geom_tile(data = filter(pairwise_data.end, !overlap_use),
            fill = NA, color = "black", size = 1.5) +
  geom_text(aes(label = sprintf("%.2f", abs(diff_value))), size = 3) +
  scale_fill_gradient(low = "white", high = "salmon3", name = "Difference") +
  scale_x_discrete(labels = my_labels_colored) +  # apply custom labels
  scale_y_discrete(labels = my_labels_colored) +  # apply custom labels
  theme_minimal() +
  labs(x = "Species",
     y = "Species",
     title = "Pairwise Differences in Prevalence with non-overlapping CIs",
     caption = "Upper left triangle: malignant prevalence differences.\nLower right triangle: neoplasia prevalence differences.\nBold border indicates cells where CIs do NOT overlap.\nColor key for labels:\n- Salmon3: Species are top for both malignant and neoplasia prevalence.\n- Forestgreen: Species are bottom for both malignant and neoplasia prevalence.\n- Darkred: Species are top for malignant prevalence only.\n- Darkgreen2: Species are bottom for malignant prevalence only.\n- Darkorange: Species are top for neoplasia prevalence only.\n- Darkblue: Species are bottom for neoplasia prevalence only.") +
  theme(axis.text.x = element_markdown(angle = 45, hjust = 1),  # use element_markdown here
        axis.text.y = element_markdown(angle = 0),  # use element_markdown here
        panel.grid = element_blank())

p

#ggsave("visual_matrix.png", p, width = 12, height = 15, dpi = "retina")

```

## 2. Evolutionary model analysis
```{r new_ranking_plots, message=FALSE, warning=FALSE, fig.height=10, fig.width=15, dev='png', dpi=320, paged.print=TRUE}

library(phylogram)         # For tree to dendrogram conversion
library(ape)               # For phylogenetic tree handling
library(ComplexHeatmap)    # For integrated heatmaps and annotations
library(circlize)          # For color mapping
library(grid)              # For custom drawing (cell_fun)

model_dir <- file.path(resultsDir, "1.Data-exploration", "9.Model-exploration")

# Load RDS files
obs_diff_matrix <- readRDS(file = file.path(model_dir, "obs_diff_matrix.rds"))
BM_sig_mat <- readRDS(file = file.path(model_dir, "BM_sig_mat.rds"))
BM_bound_sig_mat_lower <- readRDS(file = file.path(model_dir, "BM_bound_sig_mat_lower.rds"))
OU_sig_mat_lower <- readRDS(file = file.path(model_dir, "OU_sig_mat_lower.rds"))

# Convert the phylogenetic tree to a dendrogram for heatmap clustering.
library(phylogram)         # For tree to dendrogram conversion
dend <- as.dendrogram(tree)
ordered_species <- labels(dend)
obs_diff_matrix <- obs_diff_matrix[ordered_species, ordered_species]

# Create barplot annotations for malignant prevalence (for heatmaps).
top_annotation <- HeatmapAnnotation(
  show_annotation_name = FALSE,
  malignant = anno_barplot(as.numeric(cancer_traits_filt$malignant_prevalence),
                           gp = gpar(fill = "grey70"), gap = unit(2, "points"),
                           border = FALSE, bar_width = 1,
                           axis_param = list(title = NULL))
)

left_annotation <- rowAnnotation(
  show_annotation_name = FALSE,
  malignant = anno_barplot(as.numeric(cancer_traits_filt$malignant_prevalence),
                           gp = gpar(fill = "grey70"), gap = unit(2, "points"),
                           border = FALSE, bar_width = 1,
                           axis_param = list(direction = "reverse"))
)

# Function to create integrated heatmap with significance markers.
create_integrated_heatmap <- function(obs_mat, BM_sig, alt_sig, title) {
  Heatmap(obs_mat,
          name = "AbsDiff",
          col = colorRamp2(c(min(obs_mat), 0, max(obs_mat)), c("white", "white", "salmon3")),
          cluster_rows = dend,
          cluster_columns = dend,
          show_row_names = TRUE,
          show_column_names = TRUE,
          top_annotation = top_annotation,
          left_annotation = left_annotation,
          heatmap_width = unit(1, "npc"),
          heatmap_height = unit(1, "npc"),
          cell_fun = function(j, i, x, y, width, height, fill) {
            if(i < j && BM_sig[i, j]){
              grid.rect(x, y, width, height, gp = gpar(col = "skyblue3", fill = NA, lwd = 5))
            }
            if(i > j && alt_sig[i, j]){
              grid.rect(x, y, width, height, gp = gpar(col = "darkseagreen4", fill = NA, lwd = 5))
            }
          },
          heatmap_legend_param = list(title = title)
  )
}

# Create two integrated heatmaps:
ht_BM_vs_BMbound <- create_integrated_heatmap(obs_diff_matrix, BM_sig_mat, BM_bound_sig_mat_lower,
                                              title = "BM (upper) vs. BM_bounded (lower)")
ht_BM_vs_OU <- create_integrated_heatmap(obs_diff_matrix, BM_sig_mat, OU_sig_mat_lower,
                                         title = "BM (upper) vs. OU (lower)")

# Draw heatmaps sequentially.
draw(ht_BM_vs_BMbound, heatmap_legend_side = "right")
draw(ht_BM_vs_OU, newpage = TRUE, heatmap_legend_side = "right")

# Save the heatmap plots as high-resolution PNGs.

png(file.path(model_dir, "ht_BM_vs_BMbound.png"), width = 15, height = 12, units = "in", res = 320)
draw(ht_BM_vs_BMbound, heatmap_legend_side = "right")
dev.off()

png(file.path(model_dir, "ht_BM_vs_OU.png"), width = 15, height = 12, units = "in", res = 320)
draw(ht_BM_vs_OU, heatmap_legend_side = "right")
dev.off()

```

```{r models_heatmaps, fig.height=10, fig.width=15, message=FALSE, warning=FALSE, dev='png', dpi=320, paged.print=TRUE}
# Initialize matrices to store common significance categories.
n <- length(ordered_species)
common_BM_bound <- matrix(NA, n, n, dimnames = list(ordered_species, ordered_species))
common_BM_OU <- matrix(NA, n, n, dimnames = list(ordered_species, ordered_species))

# Loop over the upper triangle and fill the lower triangle with categories.
for(i in 1:(n-1)) {
  for(j in (i+1):n) {
    # BM vs BM_bounded comparison.
    if(BM_sig_mat[i, j] && BM_bound_sig_mat_lower[j, i]) {
      common_BM_bound[j, i] <- "Common"
    } else if(BM_sig_mat[i, j]) {
      common_BM_bound[j, i] <- "BM"
    } else if(BM_bound_sig_mat_lower[j, i]) {
      common_BM_bound[j, i] <- "BM_bounded"
    }
    
    # BM vs OU comparison.
    if(BM_sig_mat[i, j] && OU_sig_mat_lower[j, i]) {
      common_BM_OU[j, i] <- "Common"
    } else if(BM_sig_mat[i, j]) {
      common_BM_OU[j, i] <- "BM"
    } else if(OU_sig_mat_lower[j, i]) {
      common_BM_OU[j, i] <- "OU"
    }
  }
}

# Define color mapping for the categories.
cat_colors <- list("Common" = "salmon3", "BM" = "skyblue3",
                   "BM_bounded" = "darkseagreen4", "OU" = "darkseagreen4")

# Create a heatmap for BM vs BM_bounded (lower triangle only).
ht_common_BM_bound <- Heatmap(common_BM_bound,
  name = "Common",
  col = cat_colors,
  cluster_rows = dend,
  cluster_columns = dend,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 90,
  cell_fun = function(j, i, x, y, width, height, fill) {
    if(i <= j) {
      grid.rect(x, y, width, height, gp = gpar(fill = "white", col = NA))
    }
    if(i > j && !is.na(common_BM_bound[i, j])) {
      grid.rect(x, y, width, height, gp = gpar(fill = cat_colors[[ common_BM_bound[i, j] ]], col = NA))
    }
  },
  heatmap_legend_param = list(title = "BM vs BM_bounded")
)

# Create a heatmap for BM vs OU (lower triangle only).
ht_common_BM_OU <- Heatmap(common_BM_OU,
  name = "Common",
  col = cat_colors,
  cluster_rows = dend,
  cluster_columns = dend,
  show_row_names = TRUE,
  show_column_names = TRUE,
  column_names_rot = 90,
  cell_fun = function(j, i, x, y, width, height, fill) {
    if(i <= j) {
      grid.rect(x, y, width, height, gp = gpar(fill = "white", col = NA))
    }
    if(i > j && !is.na(common_BM_OU[i, j])) {
      grid.rect(x, y, width, height, gp = gpar(fill = cat_colors[[ common_BM_OU[i, j] ]], col = NA))
    }
  },
  heatmap_legend_param = list(title = "BM vs OU")
)

# Draw and save the collapsed heatmaps.
draw(ht_common_BM_bound, heatmap_legend_side = "right")
png(file.path(model_dir, "ht_common_BM_bound.png"), width = 15, height = 12, units = "in", res = 320)
draw(ht_common_BM_bound, heatmap_legend_side = "right")
dev.off()

draw(ht_common_BM_OU, newpage = TRUE, heatmap_legend_side = "right")
png(file.path(model_dir, "ht_common_BM_OU.png"), width = 15, height = 12, units = "in", res = 320)
draw(ht_common_BM_OU, heatmap_legend_side = "right")
dev.off()

# Save collapsed heatmap objects for later use.
saveRDS(ht_common_BM_bound, file = file.path(model_dir, "ht_common_BM_bound.rds"))
saveRDS(ht_common_BM_OU, file = file.path(model_dir, "ht_common_BM_OU.rds"))
```


```{r models_comparison, fig.height=10, fig.width=15, message=FALSE, warning=FALSE, dev='png', dpi=320, paged.print=TRUE}
# Load model fits
fitBM <- readRDS(file = file.path(model_dir, "fitBM.rds"))
fitOU <- readRDS(file = file.path(model_dir, "fitOU.rds"))
fitEB <- readRDS(file = file.path(model_dir, "fitEB.rds"))
fit_lambda <- readRDS(file = file.path(model_dir, "fit_lambda.rds"))
fit_delta <- readRDS(file = file.path(model_dir, "fit_delta.rds"))

# BM simulation.
simBM <- fastBM(tree, a = 0, sig2 = fitBM$opt$sigsq)
png(file.path(model_dir, "BM_simulation.png"), width = 10, height = 8, units = "in", res = 320)
phenogram(tree, simBM, col = "skyblue3", main = "BM Simulation")
dev.off()


# BM_bounded simulation.
simBM_bounded <- fastBM(tree, a = 0, sig2 = fitBM$opt$sigsq, bounds = c(0, 1))
png(file.path(model_dir, "BM_bounded_simulation.png"), width = 10, height = 8, units = "in", res = 320)
phenogram(tree, simBM_bounded, col = "skyblue3", main = "BM_bounded Simulation")
dev.off()

# OU simulation.
alpha_val <- fitOU$opt$alpha
theta_val <- 0.08570421
simOU <- fastBM(tree, a = 0, sig2 = fitOU$opt$sigsq, alpha = alpha_val, theta = theta_val)
png(file.path(model_dir, "OU_simulation.png"), width = 10, height = 8, units = "in", res = 320)
phenogram(tree, simOU, col = "skyblue3", main = "OU Simulation")
dev.off()

# Lambda simulation (simulate BM on a lambda-transformed tree).
lambda_val <- fit_lambda$opt$lambda
tree_lambda <- rescale(tree, model = "lambda", lambda = lambda_val)
simLambda <- fastBM(tree_lambda, a = 0, sig2 = fit_lambda$opt$sigsq)
png(file.path(model_dir, "Lambda_simulation.png"), width = 10, height = 8, units = "in", res = 320)
phenogram(tree, simLambda, col = "skyblue3", main = "Lambda Simulation")
dev.off()

# Show the phenograms in the knitted document.
phenogram(tree, simBM, col = "skyblue3", main = "BM Simulation")
phenogram(tree, simBM_bounded, col = "skyblue3", main = "BM_bounded Simulation")
phenogram(tree, simOU, col = "skyblue3", main = "OU Simulation")
phenogram(tree, simLambda, col = "skyblue3", main = "Lambda Simulation")

# 2. Simulation Study with Replication ----------------------------------------
results <- readRDS(file = file.path(model_dir, "simulation_results.rds"))

# Extract sig2 estimates.
BM_sig2 <- sapply(results$BM, function(x) x$sigsq)
BM_bounded_sig2 <- sapply(results$BM_bounded, function(x) x$sigsq)
OU_sig2 <- sapply(results$OU, function(x) x$sigsq)
Lambda_sig2 <- sapply(results$Lambda, function(x) x$sigsq)

# Plot histograms for sig2 estimates.
png(file.path(model_dir, "sig2_estimates.png"), width = 10, height = 8, units = "in", res = 320)
par(mfrow = c(2, 2))
hist(BM_sig2, main = "BM Model: sig² Estimates", xlab = "sig²", col = "skyblue3", border = "white")
hist(BM_bounded_sig2, main = "BM_bounded Model: sig² Estimates", xlab = "sig²", col = "darkseagreen3", border = "white")
hist(OU_sig2, main = "OU Model: sig² Estimates", xlab = "sig²", col = "salmon3", border = "white")
hist(Lambda_sig2, main = "Lambda Model: sig² Estimates", xlab = "sig²", col = "lightgoldenrod3", border = "white")
dev.off()

# Extract and plot AIC estimates.
BM_aic <- sapply(results$BM, function(x) x$aic)
BM_bounded_aic <- sapply(results$BM_bounded, function(x) x$aic)
OU_aic <- sapply(results$OU, function(x) x$aic)
Lambda_aic <- sapply(results$Lambda, function(x) x$aic)

png(file.path(model_dir, "aic_estimates.png"), width = 10, height = 8, units = "in", res = 320)
par(mfrow = c(2, 2))
hist(BM_aic, main = "BM Model: AIC Estimates", xlab = "AIC", col = "skyblue3", border = "white")
hist(BM_bounded_aic, main = "BM_bounded Model: AIC Estimates", xlab = "AIC", col = "darkseagreen3", border = "white")
hist(OU_aic, main = "OU Model: AIC Estimates", xlab = "AIC", col = "salmon3", border = "white")
hist(Lambda_aic, main = "Lambda Model: AIC Estimates", xlab = "AIC", col = "lightgoldenrod3", border = "white")
dev.off()

# Again, show in the knitted doc
par(mfrow = c(2, 2))
hist(BM_sig2, main = "BM Model: sig² Estimates", xlab = "sig²", col = "skyblue3", border = "white")
hist(BM_bounded_sig2, main = "BM_bounded Model: sig² Estimates", xlab = "sig²", col = "darkseagreen3", border = "white")
hist(OU_sig2, main = "OU Model: sig² Estimates", xlab = "sig²", col = "salmon3", border = "white")
hist(Lambda_sig2, main = "Lambda Model: sig² Estimates", xlab = "sig²", col = "lightgoldenrod3", border = "white")

par(mfrow = c(2, 2))
hist(BM_aic, main = "BM Model: AIC Estimates", xlab = "AIC", col = "skyblue3", border = "white")
hist(BM_bounded_aic, main = "BM_bounded Model: AIC Estimates", xlab = "AIC", col = "darkseagreen3", border = "white")
hist(OU_aic, main = "OU Model: AIC Estimates", xlab = "AIC", col = "salmon3", border = "white")
hist(Lambda_aic, main = "Lambda Model: AIC Estimates", xlab = "AIC", col = "lightgoldenrod3", border = "white")

```

## 3.Phylogenetic ranking strategy 

