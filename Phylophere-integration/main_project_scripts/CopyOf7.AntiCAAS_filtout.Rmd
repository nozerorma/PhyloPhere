---
title: "AntiCAAS filtout"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
citations:   
output:
  html_document: default
  pdf_document: default
---

# Overview
  
This document is used to filter out the AntiCAAS results and prepare the data for the next steps. The data is filtered by bootstrap p-value and pattern, and the significant results are extracted. The data is then summarized and saved to files.

## 1. Setup & Directory Definition

This section sets the working directory, loads common functions, and defines data and results folders.

```{r setup}

knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
getwd()

```

```{r dirdef, message=FALSE, warning=FALSE}

workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir,"Malignancy_Primates/Out/")

# Load common objects, functions and libraries
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/dunn_modified.R"))

```

## 2. Load Libraries

```{r,warning=FALSE,message=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(VennDiagram)
library(grid)

```

## 3. Define Processing Function

This function processes data for a given trait (malignancy or neoplasia), performing all necessary steps.

```{r venns, message=FALSE, warning=FALSE, fig.height=10, fig.width=10, dev='png', dpi=320}
process_trait <- function(trait) {
  # Define directories
  data_dir <- file.path(resultsDir, "2.CAAS/4.Randomizations/", trait)
  output_base_dir <- file.path(resultsDir, "2.CAAS/5.AntiCAAS_filtout/", trait)
  createDir(output_base_dir)
  
  # Load antiCAAS data
  aggCAAS_files <- list.files(data_dir, pattern = "\\_caas.csv$", full.names = TRUE)
  aggCAAS_dfs <- lapply(aggCAAS_files, read_csv)
  aggCAAS_df <- bind_rows(aggCAAS_dfs) %>% distinct()
  
  # Define groups and subsets
  all_main <- aggCAAS_df
  all_sign <- all_main %>% filter(isSignificant == TRUE)
  all_non_sign <- all_main %>% filter(isSignificant == FALSE)
  all_pat1 <- all_main %>% filter(pattern == "pattern1")
  all_sign_pat1 <- all_sign %>% filter(pattern == "pattern1")
  all_non_sign_pat1 <- all_non_sign %>% filter(pattern == "pattern1")
  
  true_main <- aggCAAS_df %>% filter(isAntiCAAS == FALSE)
  true_sign <- true_main %>% filter(isSignificant == TRUE)
  true_non_sign <- true_main %>% filter(isSignificant == FALSE)
  true_pat1 <- true_main %>% filter(pattern == "pattern1")
  true_sign_pat1 <- true_sign %>% filter(pattern == "pattern1")
  true_non_sign_pat1 <- true_non_sign %>% filter(pattern == "pattern1")
  
  conserved_main <- aggCAAS_df %>% filter(isAntiCAAS == "CONS_ANTICAAS")
  conserved_sign <- conserved_main %>% filter(isSignificant == TRUE)
  conserved_non_sign <- conserved_main %>% filter(isSignificant == FALSE)
  conserved_pat1 <- conserved_main %>% filter(pattern == "pattern1")
  conserved_sign_pat1 <- conserved_sign %>% filter(pattern == "pattern1")
  conserved_non_sign_pat1 <- conserved_non_sign %>% filter(pattern == "pattern1")
  
  valid_main <- bind_rows(true_main, conserved_main)
  valid_sign <- valid_main %>% filter(isSignificant == TRUE)
  valid_non_sign <- valid_main %>% filter(isSignificant == FALSE)
  valid_pat1 <- valid_main %>% filter(pattern == "pattern1")
  valid_sign_pat1 <- valid_sign %>% filter(pattern == "pattern1")
  valid_non_sign_pat1 <- valid_non_sign %>% filter(pattern == "pattern1")
  
  anticaas_main <- aggCAAS_df %>% filter(isAntiCAAS == TRUE)
  anticaas_sign <- anticaas_main %>% filter(isSignificant == TRUE)
  anticaas_non_sign <- anticaas_main %>% filter(isSignificant == FALSE)
  anticaas_pat1 <- anticaas_main %>% filter(pattern == "pattern1")
  anticaas_sign_pat1 <- anticaas_sign %>% filter(pattern == "pattern1")
  anticaas_non_sign_pat1 <- anticaas_non_sign %>% filter(pattern == "pattern1")
  
  # Save objects
  save_group_objects <- function(group_dir, main_df, sign_df, non_sign_df, sign_pat1_df, non_sign_pat1_df) {
    createDir(group_dir)
    write_csv(main_df, file.path(group_dir, "main.csv"))
    write_csv(sign_df, file.path(group_dir, "sign.csv"))
    write_csv(non_sign_df, file.path(group_dir, "non_sign.csv"))
    write_csv(bind_rows(sign_pat1_df, non_sign_pat1_df), file.path(group_dir, "pat1.csv"))
    write.table(unique(main_df$gene), file = file.path(group_dir, "main.genes"), sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
    write.table(unique(sign_df$gene), file = file.path(group_dir, "sign.genes"), sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
    write.table(unique(non_sign_df$gene), file = file.path(group_dir, "non_sign.genes"), sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
    write.table(unique(c(sign_pat1_df$gene, non_sign_pat1_df$gene)), file = file.path(group_dir, "pat1.genes"), sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
    write.table(unique(sign_pat1_df$gene), file = file.path(group_dir, "sig_pat1.genes"), sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
    write.table(unique(non_sign_pat1_df$gene), file = file.path(group_dir, "non_sig_pat1.genes"), sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
  }
  
  save_group_objects(file.path(output_base_dir, "all"), all_main, all_sign, all_non_sign, all_sign_pat1, all_non_sign_pat1)
  save_group_objects(file.path(output_base_dir, "true"), true_main, true_sign, true_non_sign, true_sign_pat1, true_non_sign_pat1)
  save_group_objects(file.path(output_base_dir, "conserved"), conserved_main, conserved_sign, conserved_non_sign, conserved_sign_pat1, conserved_non_sign_pat1)
  save_group_objects(file.path(output_base_dir, "valid"), valid_main, valid_sign, valid_non_sign, valid_sign_pat1, valid_non_sign_pat1)
  save_group_objects(file.path(output_base_dir, "anticaas"), anticaas_main, anticaas_sign, anticaas_non_sign, anticaas_sign_pat1, anticaas_non_sign_pat1)
  
  # Create summary table
  summary_table <- tribble(
    ~Group_Type, ~Count, ~Unique_Genes,
    "ALL - main", nrow(all_main), length(unique(all_main$gene)),
    "ALL - sign", nrow(all_sign), length(unique(all_sign$gene)),
    "ALL - non_sign", nrow(all_non_sign), length(unique(all_non_sign$gene)),
    "ALL - pat1", nrow(all_pat1), length(unique(all_pat1$gene)),
    "ALL - sign_pat1", nrow(all_sign_pat1), length(unique(all_sign_pat1$gene)),
    "ALL - non_sign_pat1", nrow(all_non_sign_pat1), length(unique(all_non_sign_pat1$gene)),
    "TRUE - main", nrow(true_main), length(unique(true_main$gene)),
    "TRUE - sign", nrow(true_sign), length(unique(true_sign$gene)),
    "TRUE - non_sign", nrow(true_non_sign), length(unique(true_non_sign$gene)),
    "TRUE - pat1", nrow(true_pat1), length(unique(true_pat1$gene)),
    "TRUE - sign_pat1", nrow(true_sign_pat1), length(unique(true_sign_pat1$gene)),
    "TRUE - non_sign_pat1", nrow(true_non_sign_pat1), length(unique(true_non_sign_pat1$gene)),
    "CONSERVED - main", nrow(conserved_main), length(unique(conserved_main$gene)),
    "CONSERVED - sign", nrow(conserved_sign), length(unique(conserved_sign$gene)),
    "CONSERVED - non_sign", nrow(conserved_non_sign), length(unique(conserved_non_sign$gene)),
    "CONSERVED - pat1", nrow(conserved_pat1), length(unique(conserved_pat1$gene)),
    "CONSERVED - sign_pat1", nrow(conserved_sign_pat1), length(unique(conserved_sign_pat1$gene)),
    "CONSERVED - non_sign_pat1", nrow(conserved_non_sign_pat1), length(unique(conserved_non_sign_pat1$gene)),
    "VALID - main", nrow(valid_main), length(unique(valid_main$gene)),
    "VALID - sign", nrow(valid_sign), length(unique(valid_sign$gene)),
    "VALID - non_sign", nrow(valid_non_sign), length(unique(valid_non_sign$gene)),
    "VALID - pat1", nrow(valid_pat1), length(unique(valid_pat1$gene)),
    "VALID - sign_pat1", nrow(valid_sign_pat1), length(unique(valid_sign_pat1$gene)),
    "VALID - non_sign_pat1", nrow(valid_non_sign_pat1), length(unique(valid_non_sign_pat1$gene)),
    "ANTICAAS - main", nrow(anticaas_main), length(unique(anticaas_main$gene)),
    "ANTICAAS - sign", nrow(anticaas_sign), length(unique(anticaas_sign$gene)),
    "ANTICAAS - non_sign", nrow(anticaas_non_sign), length(unique(anticaas_non_sign$gene)),
    "ANTICAAS - pat1", nrow(anticaas_pat1), length(unique(anticaas_pat1$gene)),
    "ANTICAAS - sign_pat1", nrow(anticaas_sign_pat1), length(unique(anticaas_sign_pat1$gene)),
    "ANTICAAS - non_sign_pat1", nrow(anticaas_non_sign_pat1), length(unique(anticaas_non_sign_pat1$gene))
  )
  
  write_csv(summary_table, file.path(output_base_dir, "summary_table.csv"))
  
  # Plot histogram
  order_levels <- c(
    "ALL - main", "ALL - sign", "ALL - non_sign", "ALL - pat1", "ALL - sign_pat1", "ALL - non_sign_pat1",
    "VALID - main", "VALID - sign", "VALID - non_sign", "VALID - pat1", "VALID - sign_pat1", "VALID - non_sign_pat1",
    "TRUE - main", "TRUE - sign", "TRUE - non_sign", "TRUE - pat1", "TRUE - sign_pat1", "TRUE - non_sign_pat1",
    "CONSERVED - main", "CONSERVED - sign", "CONSERVED - non_sign", "CONSERVED - pat1", "CONSERVED - sign_pat1", "CONSERVED - non_sign_pat1",
    "ANTICAAS - main", "ANTICAAS - sign", "ANTICAAS - non_sign", "ANTICAAS - pat1", "ANTICAAS - sign_pat1", "ANTICAAS - non_sign_pat1"
  )
  summary_table$Group_Type <- factor(summary_table$Group_Type, levels = order_levels)
  hist_plot <- ggplot(summary_table, aes(x = Group_Type, y = Count, fill = Group_Type)) +
    geom_bar(stat = "identity", show.legend = FALSE) +
    labs(title = paste("Summary of Gene Counts by Group and Type -", trait),
         x = "Group and Type",
         y = "Number of Rows / Genes") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  ggsave(filename = file.path(output_base_dir, "gene_count_histogram.png"), plot = hist_plot, width = 12, height = 8)
  
  # Overlap analysis
  cancer_driver_df <- read.csv(file.path(dataDir, "Intogen/Compendium_Cancer_Genes.tsv"), sep = "\t") %>%
    dplyr::select(SYMBOL) %>%
    dplyr::rename(gene = SYMBOL) %>%
    dplyr::distinct()
  
  bg_path <- file.path(resultsDir, "2.CAAS/1.Discovery/1.Traitfiles/", trait, paste0(trait, "_paired_species/global_background_no_duplicates.txt"))
  gene_bg <- readLines(bg_path)
  
  # Overlap for ALL - main
  all_overlap <- all_main %>%
    dplyr::filter(gene %in% cancer_driver_df$gene) %>%
    dplyr::select(gene) %>%
    dplyr::distinct()
  
  all_overlap_test <- phyper(
    q = length(unique(all_overlap$gene)) - 1, #white balls drawn without replacement
    m = length(unique(cancer_driver_df$gene)), #white balls in urn, cancer_drivers
    n = length(gene_bg) - length(unique(cancer_driver_df$gene)), #black balls in urn, background - cancer_drivers
    k = length(unique(all_main$gene)), #number of balls drawn, discovered CAAS (ALL)
    lower.tail = FALSE
  )
  
  # Overlap for VALID - sign
  valid_sign_overlap <- valid_sign %>%
    dplyr::filter(gene %in% cancer_driver_df$gene) %>%
    dplyr::select(gene) %>%
    dplyr::distinct()
  valid_sign_overlap_test <- phyper(
    q = length(unique(valid_sign_overlap$gene)) - 1,
    m = length(unique(cancer_driver_df$gene)),
    n = length(gene_bg) - length(unique(cancer_driver_df$gene)),
    k = length(unique(valid_sign$gene)),
    lower.tail = FALSE
  )
  
  # Overlap for VALID - sign_pat1
  valid_sign_pat1_overlap <- valid_sign_pat1 %>%
    dplyr::filter(gene %in% cancer_driver_df$gene) %>%
    dplyr::select(gene) %>%
    dplyr::distinct()
  valid_sign_pat1_overlap_test <- phyper(
    q = length(unique(valid_sign_pat1_overlap$gene)) - 1,
    m = length(unique(cancer_driver_df$gene)),
    n = length(gene_bg) - length(unique(cancer_driver_df$gene)),
    k = length(unique(valid_sign_pat1$gene)),
    lower.tail = FALSE
  )
  
  # Venn diagrams
  venn_two <- function(set_size, driver_size, overlap_size, title, pval, output_file) {
    png(output_file, width = 500, height = 900)
    draw.pairwise.venn(
      area1 = set_size,
      area2 = driver_size,
      cross.area = overlap_size,
      category = c(title, "Cancer\ndrivers"),
      fill = c("skyblue2", "salmon2"),
      alpha = c(0.8, 0.8),
      lty = "blank",
      cex = 2.5, rotation.degree = 90, ext.text = FALSE,
      cat.cex = 2,
      cat.pos = c(120, 60),
      cat.just = list(c(0, 0.5), c(-0.25, 0.5)),
      cat.col = c("skyblue4", "salmon4"),
      fontfamily = "Inter",
      fontface = "bold",
      cat.fontfamily = "Inter",
      cat.fontface = "bold"
    )
    grid.text(
      label = sprintf("Overlap = %d; hypergeo p = %.3g", overlap_size, pval),
      hjust = 0.9,
      vjust = -11.3, rot = 90,
      gp = gpar(fontsize = 25, fontfamily = "Inter", fontface = "bold")
    )
    dev.off()
  }
  
  venn_two(
    set_size = length(unique(all_main$gene)),
    driver_size = length(unique(cancer_driver_df$gene)),
    overlap_size = length(unique(all_overlap$gene)),
    title = "ALL",
    pval = all_overlap_test,
    output_file = file.path(output_base_dir, "venn_all_vs_drivers.png")
  )
  
  venn_two(
    set_size = length(unique(valid_sign$gene)),
    driver_size = length(unique(cancer_driver_df$gene)),
    overlap_size = length(unique(valid_sign_overlap$gene)),
    title = "SC",
    pval = valid_sign_overlap_test,
    output_file = file.path(output_base_dir, "venn_valid_sign_vs_drivers.png")
  )
  
  venn_two(
    set_size = length(unique(valid_sign_pat1$gene)),
    driver_size = length(unique(cancer_driver_df$gene)),
    overlap_size = length(unique(valid_sign_pat1_overlap$gene)),
    title = "SC\nPat1",
    pval = valid_sign_pat1_overlap_test,
    output_file = file.path(output_base_dir, "venn_valid_sign_pat1_vs_drivers.png")
  )
}

process_trait("malignant_prevalence")
process_trait("neoplasia_prevalence")
```