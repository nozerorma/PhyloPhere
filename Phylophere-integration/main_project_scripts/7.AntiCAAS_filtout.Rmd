---
title: "AntiCAAS filtout"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
citations:   
output:
  html_document: default
  pdf_document: default
---

# AntiCAAS filtout
  
This document is used to filter out the AntiCAAS results and prepare the data for the next steps. The data is filtered by bootstrap p-value and pattern, and the significant results are extracted. The data is then summarized and saved to files.

## Setup and Directory Configuration

This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)

```

```{r dirdef, message=FALSE, warning=FALSE}

# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.ç

```

## 1. Loading raw CAAS and bootstrap significant data (commons)

```{r caas_anticaas data, fig.width=10, fig.height=6, dev="png", dpi=320}
# ================================
# 1. Load Aggregated CAAS Data
# ================================

trait <- "malignant_prevalence" # Change this to the trait you want to analyze

aggCAAS_files <- list.files(
  file.path(resultsDir, paste0("2.CAAS/5.Randomizations/", trait)),
  pattern = "\\_caas.csv$",
  full.names = TRUE
)

global_files <- list.files(
  file.path(resultsDir, paste0("2.CAAS/5.Randomizations/", trait)),
  pattern = "\\_global.csv$",
  full.names = TRUE
)

aggCAAS_df <- aggCAAS_files %>%
  lapply(read_csv)%>%
  # Add df name as a column
  map2(
    ~ mutate(.x, source_file = str_remove(basename(.y), "_caas\\.csv$")),
    .y = aggCAAS_files
  ) %>%
  bind_rows() %>%
  distinct() %>%
  mutate(GenePos = paste0(gene, "_", msa_pos))

# Load global data
global_df <- read_csv(global_files)

# Global duplicates
global_dups <- global_df %>%
  group_by(gene, msa_pos) %>%
  filter(n() > 1) %>%
  ungroup()

# Dedup
global_df <- global_df %>%
  distinct(gene, msa_pos, .keep_all = TRUE)

# # Save as rds
# aggCAAS_rds <- file.path(resultsDir, paste0("2.CAAS/4.Randomizations/new/", trait, "/aggCAAS.rds"))
# if (!file.exists(aggCAAS_rds)) {
#   write_rds(aggCAAS_df, aggCAAS_rds)
# } else {
#   aggCAAS_df <- read_rds(aggCAAS_rds)
# }
# # 
# global_rds <- file.path(resultsDir, paste0("2.CAAS/4.Randomizations/new/", trait, "/global.rds"))
# if (!file.exists(global_rds)) {
#   write_rds(global_df, global_rds)
# } else {
#   global_df <- read_rds(global_rds)
# }

# ================================
# 2. Conservation Index Histogram
# ================================

# Left join global into aggCAAS_df to get global cons_idx for each position
aggCAAS_df <- aggCAAS_df %>%
  left_join(global_df %>% select(gene, msa_pos, cons_idx = cons_idx),
            by = c("gene", "msa_pos"))

hist_plot_caas <- ggplot(aggCAAS_df, aes(x = cons_idx)) +
  geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
  # Compute decile cuts
  geom_vline(xintercept = quantile(aggCAAS_df$cons_idx, probs = seq(0.1, 0.9, 0.1), na.rm = TRUE), 
             linetype = "dashed", color = "salmon3", linewidth = 1) +
  scale_x_continuous(breaks = pretty(aggCAAS_df$cons_idx, n = 15)) +
  labs(
    x = "Conservation Index (per site)",
    y = "Number of CAAS"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

hist_plot_sign.perm <- ggplot(
  data = aggCAAS_df %>% filter(isSignificant == TRUE),
  mapping = aes(x = cons_idx)) +
  geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
  geom_vline(xintercept = quantile(aggCAAS_df %>% filter(isSignificant == TRUE) %>% pull(cons_idx), probs = seq(0.1, 0.9, 0.1), na.rm = TRUE),
             linetype = "dashed", color = "salmon3", linewidth = 1) +
  scale_x_continuous(breaks = pretty(aggCAAS_df %>% filter(isSignificant == TRUE) %>% pull(cons_idx), n = 15)) +
  labs(
    x = "Conservation Index (per site)",
    y = "Number of CAAS (Significant by Permutations)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

hist_plot_sign.hyp <- ggplot(
  data = aggCAAS_df %>% filter(pvalue <= 0.05),
  mapping = aes(x = cons_idx)) +
  geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
  geom_vline(xintercept = decile_cuts <- quantile(aggCAAS_df %>% filter(pvalue <= 0.05 )%>% pull(cons_idx), probs = seq(0.1, 0.9, 0.1), na.rm = TRUE),
             linetype = "dashed", color = "salmon3", linewidth = 1) +
  scale_x_continuous(breaks = pretty(aggCAAS_df %>% filter(pvalue <= 0.05 )%>% pull(cons_idx), n = 15)) +
  labs(
    x = "Conservation Index (per site)",
    y = "Number of CAAS (Significant by Hypergeometric Test)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

hist_plot_sign.both <- ggplot(
  data = aggCAAS_df %>% filter(isSignificant == TRUE & pvalue <= 0.05),
  mapping = aes(x = cons_idx)) +
  geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
  geom_vline(xintercept = quantile(aggCAAS_df %>% filter(isSignificant == TRUE & pvalue <= 0.05) %>% pull(cons_idx), probs = seq(0.1, 0.9, 0.1), na.rm = TRUE),
             linetype = "dashed", color = "salmon3", linewidth = 1) +
  scale_x_continuous(breaks = pretty(aggCAAS_df %>% filter(isSignificant == TRUE & pvalue <= 0.05) %>% pull(cons_idx), n = 15)) +
  labs(
    x = "Conservation Index (per site)",
    y = "Number of CAAS (Significant by Both Tests)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )


hist_plot_global <- ggplot(global_df, aes(x = cons_idx)) +
  geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
  geom_vline(xintercept = global_decile_cuts <- quantile(global_df$cons_idx, probs = seq(0.1, 0.9, 0.1), na.rm = TRUE), 
             linetype = "dashed", color = "salmon3", linewidth = 1) +
  scale_x_continuous(breaks = pretty(global_df$cons_idx, n = 15)) +
  labs(
    x = "Conservation Index (per site)",
    y = "Number of Positions"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

print(hist_plot_caas)
print(hist_plot_global)
print(hist_plot_sign.perm)
print(hist_plot_sign.hyp)
print(hist_plot_sign.both)

# Save the histogram plot
outdir <- file.path(resultsDir, paste0("2.CAAS/5.Randomizations/", trait))
createDir(outdir)
ggsave(
  filename = file.path(outdir, "conservation_index_histogram.png"),
  plot = hist_plot_caas,
  width = 10, height = 6, dpi = 320
)

ggsave(
  filename = file.path(outdir, "conservation_index_histogram_sign_perm.png"),
  plot = hist_plot_sign.perm,
  width = 10, height = 6, dpi = 320)

ggsave(
  filename = file.path(outdir, "conservation_index_histogram_sign_hyp.png"),
  plot = hist_plot_sign.hyp,
  width = 10, height = 6, dpi = 320)

ggsave(
  filename = file.path(outdir, "conservation_index_histogram_sign_both.png"),
  plot = hist_plot_sign.both,
  width = 10, height = 6, dpi = 320)

ggsave(
  filename = file.path(outdir, "conservation_index_histogram_global.png"),
  plot = hist_plot_global,
  width = 10, height = 6, dpi = 320)

```

## 2. Define Groups and Subsets. Filter out AntiCAAS.

```{r caas_anticaas_filt, fig.width=10, fig.height=10, dev="png", dpi=320}
# ================================
# 2. Define Groups and Subsets
# ================================

# Helper: Generate subsets from a main df
generate_subsets <- function(df) {
  list(
    main            = df,
    sign            = df %>% filter(isSignificant == TRUE, pvalue <= 0.05),
    non_sign        = df %>% filter(isSignificant == FALSE | pvalue > 0.05),
    pat1            = df %>% filter(pattern == "pattern1"),
    sign_pat1       = df %>% filter(isSignificant == TRUE, pvalue <= 0.05, pattern == "pattern1"),
    non_sign_pat1   = df %>% filter((isSignificant == FALSE | pvalue > 0.05), pattern == "pattern1"),
    new_pat1       = df %>% filter(new_pattern == "pattern1"),
    new_sign_pat1   = df %>% filter(isSignificant == TRUE, pvalue <= 0.05, new_pattern == "pattern1"),
    top_bottom       = df %>% filter(new_direction == "TOP→BOTTOM"),
    sign_top_bottom = df %>% filter(isSignificant == TRUE, pvalue <= 0.05, new_direction == "TOP→BOTTOM"),
    bottom_top      = df %>% filter(new_direction == "BOTTOM→TOP"),
    sign_bottom_top = df %>% filter(isSignificant == TRUE, pvalue <= 0.05, new_direction == "BOTTOM→TOP")
  )
}

# Define groupings
groups <- list(
  ALL        = generate_subsets(aggCAAS_df),
  TRUE_CAAS  = generate_subsets(aggCAAS_df %>% filter(isAntiCAAS == FALSE)),
  CONS_CAAS  = generate_subsets(aggCAAS_df %>% filter(isAntiCAAS == "CONS_ANTICAAS")),
  FINAL_CAAS    = generate_subsets(aggCAAS_df 
                                   %>% filter(isAntiCAAS %in% c(FALSE, "CONS_ANTICAAS"))
                                   %>% filter(cons_idx >= 0.8)),
  ANTICAAS   = generate_subsets(aggCAAS_df %>% filter(isAntiCAAS == TRUE))
)

# ================================
# 3. Save Objects in Subdirectories
# ================================

base_dir <- file.path(resultsDir, "2.CAAS/5.AntiCAAS_filtout", trait)
createDir(file.path(base_dir))

save_group_objects <- function(group_dir, subsets) {
  createDir(group_dir)

  # Save data frames
  write_csv(subsets$main, file.path(group_dir, "main.csv"))
  write_csv(subsets$sign, file.path(group_dir, "sign.csv"))
  write_csv(subsets$non_sign, file.path(group_dir, "non_sign.csv"))
  write_csv(subsets$sign_pat1, file.path(group_dir, "sign_pat1.csv"))
  write_csv(subsets$new_sign_pat1, file.path(group_dir, "new_sign_pat1.csv"))
  write_csv(subsets$sign_top_bottom, file.path(group_dir, "sign_top_bottom.csv"))
  write_csv(subsets$sign_bottom_top, file.path(group_dir, "sign_bottom_top.csv"))

  # Save gene lists
  gene_writer <- function(data, fname) {
    write.table(unique(data$gene), file = file.path(group_dir, fname),
                sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
  }

  gene_writer(subsets$main,           "main.genes")
  gene_writer(subsets$sign,           "sign.genes")
  gene_writer(subsets$non_sign,       "non_sign.genes")
  gene_writer(subsets$sign_pat1,      "sig_pat1.genes")
  gene_writer(subsets$new_sign_pat1,  "new_sig_pat1.genes")
  gene_writer(subsets$sign_top_bottom, "sig_top_bottom.genes")
  gene_writer(subsets$sign_bottom_top, "sig_bottom_top.genes")

  # Generate histrograms such as the one above
  hist_plot <- ggplot(subsets$main, aes(x = cons_idx)) +
    geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
    labs(
      x = "Conservation Index (per site)",
      y = "Number of CAAS"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      axis.text.x = element_text(angle = 0, hjust = 0.5)
    )
  
  ggsave(
    filename = file.path(group_dir, "conservation_index_histogram.png"),
    plot = hist_plot,
    width = 10, height = 6, dpi = 320
  )
  
  hist_plot2 <- ggplot(subsets$sign, aes(x = cons_idx)) +
    geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
    labs(
      x = "Conservation Index (per site)",
      y = "Number of Significant CAAS"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      axis.text.x = element_text(angle = 0, hjust = 0.5)
    )
  
  ggsave(
    filename = file.path(group_dir, "conservation_index_histogram_sign.png"),
    plot = hist_plot2,
    width = 10, height = 6, dpi = 320
  )
  
  hist_plot4 <- ggplot(bind_rows(subsets$sign_pat1, subsets$non_sign_pat1), aes(x = cons_idx)) +
    geom_histogram(bins = 50, fill = "skyblue4", alpha = 0.7, color = "black", linewidth = 0.5) +
    labs(
      x = "Conservation Index (per site)",
      y = "Number of CAAS in Pattern 1"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      axis.text.x = element_text(angle = 0, hjust = 0.5)
    )
  
  ggsave(
    filename = file.path(group_dir, "conservation_index_histogram_pat1.png"),
    plot = hist_plot4,
    width = 10, height = 6, dpi = 320
  )
}

# Save all groups
walk2(
  .x = names(groups),
  .y = groups,
  .f = ~ save_group_objects(file.path(base_dir, tolower(.x)), .y)
)

# ================================
# 4. Create Summary Table
# ================================

summary_table <- map2_dfr(
  .x = names(groups),
  .y = groups,
  .f = function(group_name, subset_list) {
    tibble(
      Group_Type = paste(group_name, "-", c("main", "sign", "non_sign", "pat1", "sign_pat1", "non_sign_pat1",
                                            "new_pat1", "new_sign_pat1", "top_bottom", "sign_top_bottom",
                                            "bottom_top", "sign_bottom_top")),
      Count = sapply(subset_list[c("main", "sign", "non_sign", "pat1", "sign_pat1", "non_sign_pat1", 
                                   "new_pat1", "new_sign_pat1", "top_bottom", "sign_top_bottom", 
                                   "bottom_top", "sign_bottom_top")], nrow),
      Unique_Genes = sapply(subset_list[c("main", "sign", "non_sign", "pat1", "sign_pat1", "non_sign_pat1",
                                          "new_pat1", "new_sign_pat1", "top_bottom", "sign_top_bottom",
                                         "bottom_top", "sign_bottom_top")],
                            function(df) length(unique(df$gene)))
    )
  }
)

# Save and display
write_csv(summary_table, file.path(base_dir, "summary_table.csv"))
print(summary_table)

```

## 3. Directionality analysis
In this analysis, I'm going to explore the directionality of the CAAS results, focusing on how the amino acid changes relate to the trait of interest. This will involve examining the patterns of amino acid substitutions and their potential impact on the trait, given their evolutionary context.

```{r caas_directionality, fig.width=10, fig.height=6, dev="png", dpi=320}
# ================================
# 4. Directionality Analysis
# ================================

# We are going to filter down aggCAAS_df little by little to see how directionality changes
aggCAAS.polished <- aggCAAS_df %>%
  # First we will remove everything outside the scope of the analysis
  ## By significance
  filter(isSignificant == TRUE, pvalue <= 0.05) %>%
  ## By conservation
  filter(cons_idx >= 80) %>%
  ## By AntiCAAS status
  filter(isAntiCAAS %in% c(FALSE, "CONS_ANTICAAS")) %>%
  # Change new_ancestral and new_derived to match ancestral_side and derived_side if not "AMBIGUOUS"
  mutate(
    new_ancestral = ifelse(ancestral_side != "AMBIGUOUS", ancestral_side, new_ancestral),
    new_derived   = ifelse(derived_side != "AMBIGUOUS", derived_side, new_derived),
    # Create new direction column based on new_ancestral and new_derived
    new_direction = case_when(
      new_ancestral == "TOP" & new_derived == "BOTTOM" ~ "TOP->BOTTOM",
      new_ancestral == "BOTTOM"  & new_derived == "TOP" ~ "BOTTOM->TOP",
      TRUE ~ "AMBIGUOUS"
  )) %>%
  # Filter out new_pattern == "pattern4", which even if not contradictory, is too ambiguous
  filter(new_pattern != "pattern4")

# Check rows were new_convAA is gappy (i.e., "-")
aggCAAS.gappy <- aggCAAS.polished %>%
  filter(str_detect(new_convAA, "-"))

# Check cases were new_convAA has only 4 amino acids, 2 at each side of the "/" (i.e., "AA/AA")
## Denotes one pair missing from the MSA
aggCAAS.missing <- aggCAAS.polished %>%
  filter(str_count(new_convAA, "/") == 1) %>%
  filter(!str_detect(new_convAA, "-")) %>%
  filter({
    parts <- str_split(new_convAA, "/", simplify = TRUE)
    nchar(parts[,1]) == 2 & nchar(parts[,2]) == 2
  })

# Extract summary table from "direction" and "new_direction"
direction_summary <- aggCAAS.polished %>%
  group_by(direction, new_direction) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  arrange(desc(Count)) %>%
  # Add total
  mutate(Total = sum(Count)) %>%
  # Add percentage
  mutate(Percentage = (Count / Total) * 100)
# View summary
print(direction_summary)

# Use these categories to subset the data into a list of dfs
direction_dfs <- split(aggCAAS.polished, list(aggCAAS.polished$new_direction), drop = TRUE)


# Stratify each df in direction_dfs by its source_file
direction_dfs_by_source <- purrr::map(direction_dfs, function(df) {
  base::split(as.data.frame(df), df$source_file, drop = TRUE)
})

# Export each df in direction_dfs_by_source to its own subdirectory
walk2(
  .x = names(direction_dfs_by_source),
  .y = direction_dfs_by_source,
  .f = function(direction, source_list) {
    dir_path <- file.path(base_dir, "directionality", tolower(gsub("->", "_to_", direction)))
    createDir(dir_path)
    
    walk2(
      .x = names(source_list),
      .y = source_list,
      .f = function(source_file, df) {
        write_csv(df, file.path(dir_path, paste0(source_file, "_caas.csv")))
      }
    )
  }
)

# Save summary table
write_csv(direction_summary, file.path(base_dir, "directionality", "direction_summary.csv"))

# Write gene lists from each direction
# Use direction_dfs to first extract the df and then the gene list
walk2(
  .x = names(direction_dfs),
  .y = direction_dfs,
  .f = function(direction, df) {
    dir_path <- file.path(base_dir, "directionality", tolower(gsub("->", "_to_", direction)))
    createDir(dir_path)
    
    write_csv(df, file.path(dir_path, paste0(trait, "_",tolower(gsub("->", "_to_", direction)), "_caas.csv")))
    write.table(unique(df$gene), file = file.path(dir_path, paste0(tolower(gsub("->", "_to_", direction)), ".genes")),
                sep = "\n", row.names = FALSE, col.names = FALSE, quote = FALSE)
  }
)

# Make a nice plot to depict the summary with the percentages
direction_plot <- ggplot(direction_summary, aes(x = direction, y = Count, fill = new_direction)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), color = "black", linewidth = 0.5) +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), 
            position = position_dodge(width = 0.7), vjust = -0.5, size = 4) +
  scale_fill_manual(values = c("TOP->BOTTOM" = "forestgreen", "BOTTOM->TOP" = "firebrick", "AMBIGUOUS" = "gray70")) +
  labs(
    title = "Directionality of Significant CAAS",
    x = "Original Direction",
    y = "Number of CAAS",
    fill = "New Direction"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "top"
  ) +
  ylim(0, max(direction_summary$Count) * 1.1)
# Save the plot
direction_plot

# Prepare summary data stratified by isConvergence (FULL, AMBIGUOUS, BOTTOM, TOP)
convergence_summary <- aggCAAS.polished %>%
  group_by(direction, isConvergence) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  arrange(direction, desc(Count)) %>%
  # Compute totals and percentages per original direction for labeling
  group_by(direction) %>%
  mutate(
    Total = sum(Count),
    Percentage = (Count / Total) * 100
  ) %>%
  ungroup()

# View summary
print(convergence_summary)

# Define consistent color palette for the four isConvergence categories
convergence_colors <- c(
  "FULL" = "goldenrod",      # sea green
  "PARTIAL" = "#808080", # gray
  "BOTTOM" = "firebrick",
  "TOP" = "forestgreen"
)

# Create stacked bar plot
convergence_plot <- ggplot(convergence_summary, aes(x = direction, y = Count, fill = isConvergence)) +
  geom_bar(stat = "identity", position = "stack", color = "black", linewidth = 0.5) +
  geom_text(
    aes(label = ifelse(Percentage >= 5, paste0(round(Percentage, 1), "%"), "")),
    position = position_stack(vjust = 0.5),
    size = 4,
    color = "white",
    fontface = "bold"
  ) +
  scale_fill_manual(values = convergence_colors) +
  labs(
    title = "Directionality of Significant CAAS by Molecular Pattern",
    x = "Original Direction",
    y = "Number of CAAS",
    fill = "Convergence"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    legend.position = "top",
    panel.grid.major.x = element_blank()
  ) +
  ylim(0, max(convergence_summary %>% group_by(direction) %>% summarise(Total = sum(Count)) %>% pull(Total)) * 1.1)

# Display the plot
convergence_plot

```
