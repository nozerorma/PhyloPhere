---
title: "Independent contrast selection"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

# Independent Contrast Selection for Neoplasia Analysis in Primates
This script performs independent contrast selection for neoplasia analysis in primates, focusing on malignancy prevalence across species. It includes data preparation, pair selection based on evolutionary distances, and trait file generation for further analysis.

## Setup and Directory Configuration
This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)

```


```{r dirdef, message=FALSE, warning=FALSE}

# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/selection_algorithm.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/dunn_modified.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.

```

## 1. Data Preparation
This section loads pre-processed trait data in a "melted" format, which is structured for easier analysis or visualization. This data will be used in subsequent ranking steps.

```{r, stat_visualization, fig.width=10, fig.height=5, dev="png"}

# Load processed cancer traits data with longevity quotient (LQ)
cancer_traits_processed <- read.csv(file.path(trait_dir, "cancer_traits_processed-LQ.csv"))

# Load melted traits data
melted_traits <- read.csv(file.path(trait_dir, "melted_traits.csv"))

# Read the RDS file with zims-ace data and conflicts
outdir_ci <- file.path(resultsDir, "1.Data-exploration/4.CI_overlaps")
zims_ace_data <- readRDS(file = file.path(outdir_ci, "zims_ace_data.rds"))
prune_dir <- file.path(resultsDir, "1.Data-exploration/5.Data-curation_ZIMS-ACE")
conflicts_jeff <- readRDS(file = file.path(prune_dir, "Jeffrey/conflicts_jeff.rds"))

```

Here, we define a function to calculate patristic (evolutionary) distances between species based on a phylogenetic tree and apply it to our filtered cancer traits data. This distance matrix will be used for pair selection.

```{r, product_matrices}

# Calculate patristic distances for filtered cancer traits
distance_matrix <- calculate_patristic_distances(tree, cancer_traits_processed)

# Excerpt the distance matrix
head(distance_matrix)

```

## 2. Ranking: Species Pair Selection
Selects species pairs for CAAS analysis by prioritizing small evolutionary (patristic) distance and large cancer trait differences (malignant/neoplasia prevalence). Uses corrected distance (patristic distance Ã— trait difference) and iterative Dunn index maximization to ensure well-separated clusters. Stops at Dunn index < 1 (last independent pair) or after 10 iterations. Outputs pairs via pair_sel.f.

```{r, rank, dev="png", fig.width=16, fig.height=8, dpi=320}

# Initialize a list to store selected pairs
selected_pairs_list <- list()

# Run pair selection for both malignant and neoplasia traits
selected_pairs_list <- lapply(c("malignant", "neoplasia"), function(trait) {
  # Select pairs using the pair_sel.f function
  selected_pairs <- pair_sel.f(
    distance_matrix = distance_matrix,
    overlap_df = conflicts_jeff[[paste0(trait, "_OK")]],
    traits_df = melted_traits,
    my_trait = paste0(trait, "_prevalence")
  )$selected_pairs
  
  return(data.frame(selected_pairs))
  })

# Give names to selected_pairs
names(selected_pairs_list) <- c("malignant_prevalence", "neoplasia_prevalence")

# Print the selected pairs
print(selected_pairs_list)

```

## 3. Extract Trait Files
This section generates trait files for varying numbers of species in high and low contrast groups based on the ranked pairs, saving them as tab-separated files for downstream analysis.

```{r, traitfiles}

# Initialize list for filtered species
filtered_species <- list()

# Function to generate trait files
gen_traitfiles <- function(df) {
  df <- df %>%
    rownames_to_column(var = "pair_id") %>%
    mutate(rank = row_number()) %>%  # Assign rank based on order
    pivot_longer(cols = c(species1, species2), names_to = "global_label", values_to = "species") %>%
    mutate(global_label = ifelse(global_label == "species1", "high_extreme", "low_extreme"))  # Label extremes
  
  n_species <- df %>%
    group_by(global_label) %>%
    summarize(n_species = n()) %>%
    pull(n_species)
  
  filtered_species <- df %>%
    group_by(global_label) %>%
    select(species, global_label) %>%
    ungroup() %>%
    mutate(contrast_group = case_when(
      global_label == "high_extreme" ~ 1,  # High extreme group
      global_label == "low_extreme" ~ 0,   # Low extreme group
      TRUE ~ NA_integer_)) %>%
    select(-global_label)  %>%
    mutate(pair = rep(1:(nrow(df)/2), each = 2))  # Assign pair numbers

  return(filtered_species)
}

# Generate trait files for selected pairs
traits_res <- lapply(selected_pairs_list, gen_traitfiles)
names(traits_res) <- names(selected_pairs_list)

# Define output directory
traitfile_dir <- file.path(resultsDir, "2.CAAS/1.Discovery/1.Traitfiles/")
createDir(traitfile_dir)

# Function to write trait files
traitfile_ize <- function(df, name) {
  df <- df %>%
    filter(contrast_group %in% c(0, 1)) %>%  # Keep only valid contrast groups
    ungroup() %>%
    select(species, contrast_group)  # Select species and contrast group
  path <- file.path(traitfile_dir, name)
  createDir(path)
  write.table(df, file.path(path, paste0(name, ".tab")), quote = FALSE,
              row.names = FALSE, col.names = FALSE, sep = "\t")
  return(df)
}

# Save the files with the dataframe name as the file name
lapply(names(traits_res), function(name) {
  traitfile_ize(traits_res[[name]], name)
})

```

## 4. Paired Species Files for Background Gene Selection
Finally, this section creates paired species files by generating all pairwise combinations of species within contrast groups, saving them for use in background gene selection.

```{r, paired_species}

# Function to create paired species files
paired_traitfiles <- function(df, name) {
  top_species <- df %>% filter(contrast_group == 1) %>% pull(species)  # High extreme species
  bottom_species <- df %>% filter(contrast_group == 0) %>% pull(species)  # Low extreme species
  
  paired_species <- data.frame(top_species, bottom_species)
  n <- nrow(paired_species)
  pair_indices <- combn(n, 2)  # Generate all pairwise combinations
  
  paired_dataframes <- apply(pair_indices, 2, function(idx) {
    paired_species[idx, , drop = FALSE]
  })
  
  # Function to reformat paired data
  re_build_traits.f <- function(df) {
    df %>%
      pivot_longer(cols = c(top_species, bottom_species), names_to = "global_label", values_to = "species") %>%
      mutate(global_label = ifelse(global_label == "top_species", "high_extreme", "low_extreme")) %>%
      select(species, global_label) %>%
      mutate(contrast_group = case_when(
        global_label == "high_extreme" ~ 1,
        global_label == "low_extreme" ~ 0,
        TRUE ~ NA_integer_)) %>%
      select(-global_label) %>%
      arrange(contrast_group)
  }
  
  paired_dataframes <- lapply(paired_dataframes, re_build_traits.f)
  
  # Save paired dataframes
  path <- file.path(traitfile_dir, name, "traitfiles")
  createDir(path)
  for (i in seq_along(paired_dataframes)) {
    write.table(paired_dataframes[[i]], file.path(path, paste0(name, "_pair_", i, ".tab")),
                quote = FALSE, row.names = FALSE, col.names = FALSE, sep = "\t")
  }
  
  return(paired_dataframes)
}

# Apply function to generate paired files
paired_species <- imap(traits_res, paired_traitfiles)


# Concatenate the pairs and add a column with the pair number
paired_species_dfs <- lapply(names(paired_species), function(name) {
  df <- paired_species[[name]]
  df <- bind_rows(df)
  df <- df %>%
    left_join(traits_res[[name]], by = "species") %>%
    dplyr::rename(trait = contrast_group.x) %>%
    select(-contrast_group.y) %>%
    mutate(contrast = rep(1:(nrow(df)/4), each = 4)) %>%
    select(species, contrast, trait, pair)
  return(df)
})

names(paired_species_dfs) <- names(paired_species)

# Save the df
paired_species_dfs <- lapply(names(paired_species_dfs), function(name) {
  path <- file.path(traitfile_dir, name, paste0(name, "_paired_species.tab"))
  write.table(paired_species_dfs[[name]], file = path, quote = FALSE, row.names = FALSE, col.names = TRUE, sep = "\t")
  return(paired_species_dfs[[name]])
})

```

## 5: Extracting traitfile tabulated files for permulations
Here, we extract traitfiles for malignant and neoplasia prevalence from the `zims_ace_data` dataset. These traitfiles will be used in subsequent analyses to compare the prevalence of malignancy and neoplasia across species.

```{r extract tabulated traitfiles}

# Extract traitfiles for malignant and neoplasia prevalence from zims_ace_data
malignant_traitfile <- zims_ace_data %>%
  select(species, malignant_prevalence.ZIMS, malignant_prevalence.ACE, malignant_CI_lb.jeff.ZIMS, malignant_CI_ub.jeff.ZIMS) %>%
  # For species where malignant prevalence is NOT NA, check whether
  ## Value is within the confidence interval of ZIMS
  mutate(is_in_ZIMS = ifelse(!is.na(malignant_prevalence.ACE), 
                     malignant_prevalence.ACE >= malignant_CI_lb.jeff.ZIMS & 
                     malignant_prevalence.ACE <= malignant_CI_ub.jeff.ZIMS, 
                     NA)) %>%
  # Keep species where malignant prevalence is NOT FALSE
  mutate(is_in_ZIMS = ifelse(is.na(is_in_ZIMS), "UNK", is_in_ZIMS)) %>%
  filter(is_in_ZIMS != FALSE) %>%
  dplyr::select(species, malignant_prevalence.ZIMS)

neoplasia_traitfile <- zims_ace_data %>%
  select(species, neoplasia_prevalence.ZIMS, neoplasia_prevalence.ACE, neoplasia_CI_lb.jeff.ZIMS, neoplasia_CI_ub.jeff.ZIMS) %>%
  # For species where neoplasia prevalence is NOT NA, check whether
  ## Value is within the confidence interval of ZIMS
  mutate(is_in_ZIMS = ifelse(!is.na(neoplasia_prevalence.ACE), 
                     neoplasia_prevalence.ACE >= neoplasia_CI_lb.jeff.ZIMS & 
                     neoplasia_prevalence.ACE <= neoplasia_CI_ub.jeff.ZIMS, 
                     NA)) %>%
  # Keep species where neoplasia prevalence is NOT FALSE
  mutate(is_in_ZIMS = ifelse(is.na(is_in_ZIMS), "UNK", is_in_ZIMS)) %>%
  filter(is_in_ZIMS != FALSE) %>%
  dplyr::select(species, neoplasia_prevalence.ZIMS)

# Save the traitfiles
traitfile_dir <- file.path(resultsDir, "2.CAAS/1.Discovery/1.5.Bootstrap_traitfiles/")

createDir(file.path(traitfile_dir, "malignant_prevalence"))
write.table(malignant_traitfile, file.path(traitfile_dir, "malignant_prevalence/traitfile.tab"), 
            quote = FALSE, row.names = FALSE, col.names = FALSE, sep = "\t")

createDir(file.path(traitfile_dir, "neoplasia_prevalence"))
write.table(neoplasia_traitfile, file.path(traitfile_dir, "neoplasia_prevalence/traitfile.tab"),
            quote = FALSE, row.names = FALSE, col.names = FALSE, sep = "\t")

# Print the traitfiles
print(malignant_traitfile)
print(neoplasia_traitfile)

```
