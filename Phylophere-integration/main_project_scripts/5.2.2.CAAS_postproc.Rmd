---
title: "CAAS post-processing"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
citations:   
output:
  html_document: default
  pdf_document: default
---

# Post-processing of CAAS results
This script processes the results of the CAAS (Cancer Associated Amino Acid Substitutions) analysis, focusing on declustering and filtering CAAS data for malignancy and neoplasia traits in primates. It includes steps for pre-filtering gaps, identifying outliers, identifying CAAS clusters in genes, and declustering CAAS data.  

## Setup and Directory Configuration
This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)

```

```{r dirdef, message=FALSE, warning=FALSE}

# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.

```

## 1. Pre-filter gaps
In this section, we will read the CAAS files from the discovery folder, filter out rows with gaps (GFG == 0 & GBG == 0), and create a new list of data frames. Each data frame will be named according to the trait it represents.

```{r pre-filter, message=FALSE, warning=FALSE}

# 1. PRE-FILTER GAPS ------------------------------------------------------
caas_folder <- file.path(resultsDir, "2.CAAS/2.Results")

# From caas_folder/$TRAIT/Discovery, extract files
caas_files <- list.files(
  path = caas_folder,
  pattern = "\\.tab.caas$",
  full.names = TRUE,
  recursive = TRUE
)

caas_files_discovery <- caas_files[grepl("/discovery/", caas_files, ignore.case = TRUE)]

# Read files and split dataframes
setup_dfs <- lapply(caas_files_discovery, read_tsv)
names(setup_dfs) <- gsub("_sp.tab.caas", "", basename(caas_files_discovery))

# Filter out rows with no gaps
filter_gap <- function(df) {
  df %>% filter(GFG == 0 & GBG == 0)
}

setup_dfs <- lapply(setup_dfs, filter_gap)

# Load and parse gene lengths --------------------------------------------
gene_length <- read_tsv(
  file.path(dataDir, "2.Alignments/gene_lengths.tab"),
  col_names = c("Gene_file", "Length")
) %>%
  extract(
    col = Gene_file,
    into = c("Gene", "Map", "Map2"),
    regex = "^([^.]+)\\.([^.]+)\\.([^\\.]+)",
    remove = FALSE
  ) %>%
  mutate(
    Map = if_else(str_detect(Map, "^[0-9]+$"), Map2, Map)
  ) %>%
  select(Gene, Length, Map)

# Merge gene lengths with setup_dfs ---------------------------------------
setup_dfs <- lapply(setup_dfs, function(df) {
  df %>%
    left_join(gene_length, by = "Gene") %>%
    mutate(
      Position = as.integer(Position),
      Length   = as.integer(Length)
    ) %>%
    mutate(
      GenePos = paste(Gene, Position, sep = "@")
    )
})

```

## Resampling overview
Here, we will analyze the distribution of species and families across multiple resampling replicates. We will create bar plots to visualize the counts of species and families that appear as "Top" or "Bottom" in each replicate.

```{r resampling, fig.height=15, fig.width=15, dev='png', dpi=320}
# Import resample files to analyze species distribution
resamp_folder <- file.path(resultsDir, "2.CAAS/2.Results")

# From caas_folder/$TRAIT/Discovery, extract files
resamp_files <- list.files(
  path = resamp_folder,
  pattern = "\\.resample$",
  full.names = TRUE,
  recursive = TRUE
)

# Read files and split dataframes
resamp_dfs <- lapply(resamp_files, read_tsv, col_names = c("Round", "Top", "Bottom"))
names(resamp_dfs) <- gsub("\\.resample$", "", basename(resamp_files))

# Family data
family_data <- read_tsv(file.path(dataDir, "5.Phylogeny/taxid_species_family.tsv"))

# Family order
ordered_species <- tree$tip.label

# Split "Top" and "Bottom" into "Top1 and "Bottom1" + "Top2" and "Bottom2"
resamp_dfs2 <- lapply(resamp_dfs, function(df) {
  df <- df %>%
    separate(Top, into = c("Top1", "Top2"), sep = ",") %>%
    separate(Bottom, into = c("Bottom1", "Bottom2"), sep = ",") %>%
    # Make long to see how many times a species appears as a top or a bottom
    pivot_longer(cols = c(Top1, Top2, Bottom1, Bottom2),
                 names_to = "Group", values_to = "Species") %>%
    # Top 1 and Top 2 are Top, so are Bottom 1 and Bottom 2
    mutate(Group = if_else(Group %in% c("Top1", "Top2"), "Top", "Bottom")) %>%
    # Count how many times each species appears as Top or Bottom
    group_by(Species, Group) %>%
    summarise(n = n(), .groups = "drop") %>%
    pivot_wider(names_from = Group, values_from = n, values_fill = 0) %>%
    # Add family information
    left_join(family_data, by = c("Species" = "species")) %>%
    select(-rank, -name_class)
  
  # Define ordered families for plotting
  df$Species <- factor(df$Species, levels = ordered_species)
  
  return(df)
})

resamp_df_fam <- lapply(resamp_dfs2, function(df) {
  df <- df %>%
    group_by(family) %>%
    summarise(
      n_Top = sum(Top, na.rm = TRUE),
      n_Bottom = sum(Bottom, na.rm = TRUE),
      .groups = "drop"
    )
})

# -------------------------------------------
# 1) Species-level: bind & tidy
#    resamp_dfs2 contains 6 dfs with Species, Top, Bottom
#    names like "malignant_prevalence_pair_1", ..., "neoplasia_prevalence_pair_3"
# -------------------------------------------

species_long <- imap_dfr(
  resamp_dfs2,
  ~ .x %>%
      select(Species, Top, Bottom) %>%
      pivot_longer(c(Top, Bottom), names_to = "Group", values_to = "count") %>%
      mutate(dataset = .y)
) %>%
  mutate(
    trait = case_when(
      str_starts(dataset, "malignant_prevalence") ~ "Malignant prevalence",
      str_starts(dataset, "neoplasia_prevalence") ~ "Neoplasia prevalence",
      TRUE ~ "Unknown"
    ),
    replicate = as.integer(str_extract(str_remove(dataset, "\\.tab$"), "\\d+$")) %>% as.integer(),
    Group = factor(Group, levels = c("Top","Bottom")),
    # composite key for fill legend
    grp_rep = factor(paste0(Group, " h", replicate),
                     levels = c("Top h1","Top h2","Top h3",
                                "Bottom h1","Bottom h2","Bottom h3"))
  )

# Order species within each trait by total (Top+Bottom) summed over replicates
species_order <- species_long %>%
  group_by(trait, Species) %>%
  summarise(total = sum(count, na.rm = TRUE), .groups = "drop") %>%
  group_by(trait) %>%
  arrange(trait, desc(total), .by_group = TRUE) %>%
  mutate(ord = row_number()) %>%
  ungroup()

species_long <- species_long %>%
  mutate(Species_plot = factor(Species, levels = ordered_species))

p_species <- ggplot(species_long,
                    aes(x = Species_plot, y = count,
                        fill = grp_rep, group = grp_rep)) +
  geom_col(position = position_dodge2(preserve = "single",
                                      width = 0.8,
                                      reverse = TRUE),
           width = 0.7) +
  coord_flip() +
  facet_wrap(~ trait, ncol = 1, scales = "free_y") +
  labs(x = NULL, y = "Count",
       fill = "Species–Hypothesis",
       title = "Permulations: Counts per species across hypothesis") +
  scale_fill_manual(
    values = c("Top h1" = "#e41a1c", "Top h2" = "#ff7f00", "Top h3" = "#a65628",
               "Bottom h1" = "#984ea3", "Bottom h2" = "#377eb8", "Bottom h3" = "#4daf4a"),
    limits = c("Top h1","Top h2","Top h3","Bottom h1","Bottom h2","Bottom h3"),
    drop = FALSE
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")

# -------------------------------------------
# 2) Family-level: bind & tidy
#    resamp_df_fam contains 6 dfs with family, n_Top, n_Bottom
#    names aligned with resamp_dfs2
# -------------------------------------------

family_long <- imap_dfr(
  resamp_df_fam,
  ~ .x %>%
      rename(Top = n_Top, Bottom = n_Bottom) %>%
      pivot_longer(c(Top, Bottom), names_to = "Group", values_to = "count") %>%
      mutate(dataset = .y)
) %>%
  mutate(
    trait = case_when(
      str_starts(dataset, "malignant_prevalence") ~ "Malignant prevalence",
      str_starts(dataset, "neoplasia_prevalence") ~ "Neoplasia prevalence",
      TRUE ~ "Unknown"
    ),
    replicate = as.integer(str_extract(str_remove(dataset, "\\.tab$"), "\\d+$")),
    Group = factor(Group, levels = c("Top","Bottom")),
    grp_rep = factor(paste0(Group, " h", replicate),
                     levels = c("Top h1","Top h2","Top h3",
                                "Bottom h1","Bottom h2","Bottom h3"))
  )

ordered_families <- family_data %>%
  filter(species %in% ordered_species) %>%
  mutate(family = as.character(family)) %>%
  distinct(species, family) %>%
  arrange(match(species, ordered_species)) %>%
  pull(family) %>%
  unique()

family_long <- family_long %>%
  mutate(
    family_plot = factor(family, levels = ordered_families)
  )

p_family <- ggplot(family_long,
                   aes(x = family_plot, y = count,
                       fill = grp_rep, group = grp_rep)) +
  geom_col(position = position_dodge2(preserve = "single",
                                      width = 0.8,
                                      reverse = TRUE),
           width = 0.7) +
  coord_flip() +
  facet_wrap(~ trait, ncol = 1, scales = "free_y") +
  labs(x = NULL, y = "Count",
       fill = "Family–Hypothesis",
       title = "Permulations: Counts per family across hypothesis") +
  scale_fill_manual(
    values = c("Top h1" = "#e41a1c", "Top h2" = "#ff7f00", "Top h3" = "#a65628",
               "Bottom h1" = "#984ea3", "Bottom h2" = "#377eb8", "Bottom h3" = "#4daf4a"),
    limits = c("Top h1","Top h2","Top h3","Bottom h1","Bottom h2","Bottom h3"),
    drop = FALSE
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")

# Save
createDir(file.path(resultsDir, "2.CAAS/3.CAAS_postproc/0.Resampling"))
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/0.Resampling/resampling_species.png"),
  plot = p_species, width = 15, height = 15, dpi = "retina", dev = "png"
)
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/0.Resampling/resampling_family.png"),
  plot = p_family, width = 15, height = 15, dpi = "retina", dev = "png"
)

# Draw
p_species
p_family

```

## 2.CAAS outliers
In this section, we will observe the distribution of CAAS counts per gene and identify outliers. We will use a boxplot to visualize the distribution and highlight outliers.

```{r caas_outliers, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, dev='png', dpi=320}

# We are going to re-approach this in two ways:
## i. A) Prune top 1% genes by CAAS/gene-length ratio;
##    B) Extract genes standing out as extreme outliers (by convention, 3 * IQR. See Tukey's definition of fences for reference) and tag them as "Dubious"
##    C) Explore CAAS clusters. If a gene has been tagged as "Dubious" AND presents a cluster, we will remove the gene from the analysis. ELSE if the gene is not "Dubious" but presents a cluster, we will only remove the cluster.
## ii. Same as i, but we will not prune the top 1% genes by CAAS/gene-length ratio.

# 2. CAAS OUTLIERS ------------------------------------------------------
# Grep malignant* into malignant_df and neoplasia* into neoplasia_df
malignant_caas <- setup_dfs[grepl("malignant", names(setup_dfs))]
neoplasia_caas <- setup_dfs[grepl("neoplasia", names(setup_dfs))]

# Merge all malignant and neoplasia dataframes into one
malignant_df <- bind_rows(malignant_caas, .id = "Trait")
neoplasia_df <- bind_rows(neoplasia_caas, .id = "Trait")

# Summarize genes by CAAS count
summarize_genes <- function(df) {
  df %>%
    group_by(Gene, Length) %>%
    summarise(
      n_CAAS = n(),
      .groups = "drop"
    )
}

# Merge both traits
malignant_distribution <- summarize_genes(malignant_df) %>% mutate(Trait = "malignant_prevalence") %>%
  # Calculate a quotient of CAAS per gene length
  mutate(
    n_CAAS = as.integer(n_CAAS),
    n_CAAS_per_length = (n_CAAS / Length)*100
  )

neoplasia_distribution <- summarize_genes(neoplasia_df) %>% mutate(Trait = "neoplasia_prevalence") %>%
  # Calculate a quotient of CAAS per gene length
  mutate(
    n_CAAS = as.integer(n_CAAS),
    n_CAAS_per_length = (n_CAAS / Length)*100
  )

df_all <- bind_rows(malignant_distribution, neoplasia_distribution)

# Calculate percentiles and IQR per trait
percentiles_df <- df_all %>%
  group_by(Trait) %>%
  summarise(
    Q1      = quantile(n_CAAS, 0.25),
    Q3      = quantile(n_CAAS, 0.75),
    IQR     = Q3 - Q1,
    iqr_low  = Q1 - 3 * IQR,
    iqr_high = Q3 + 3 * IQR,
    .groups = "drop"
  )

# --- Full-scale plot ---
p_full <- ggplot(df_all, aes(x = n_CAAS)) +
  geom_histogram(binwidth = 0.05, color = "black", fill = "grey80", alpha = 0.8) +
  geom_vline(data = percentiles_df, aes(xintercept = iqr_high, color = "IQR"), linetype = "solid") +
  scale_x_log10(breaks = c(1, 2, 5, 10, 20, 50, 100, 200)) +
  scale_color_manual(values = c("IQR" = "forestgreen")) +
  facet_wrap(~Trait, scales = "free_y") +
  labs(
    title = "Full CAAS Count Distribution IQR Extreme-Outlier Thresholds (Dubious genes)",
    x = "n_CAAS (log-scaled axis)",
    y = "Gene Count",
    color = "Threshold Type"
  ) +
  theme_minimal()

p_full

# Zoom in
zoom_limit <- 100

p_zoom <- ggplot(df_all, aes(x = n_CAAS)) +
  geom_histogram(binwidth = 0.05, color = "black", fill = "grey80", alpha = 0.8) +
  geom_vline(data = percentiles_df, aes(xintercept = iqr_high, color = "IQR"), linetype = "solid") +
  scale_x_log10(breaks = c(1, 2, 5, 10, 20, 50, 100, 200)) +
  scale_y_continuous(breaks = seq(0, zoom_limit, by = 10)) +
  scale_color_manual(values = c("IQR" = "darkgreen")) +
  facet_wrap(~Trait, scales = "free_y") +
  coord_cartesian(ylim = c(0, zoom_limit)) +
  labs(
    title = paste("Zoomed View (y ≤", zoom_limit, ")"),
    x = "n_CAAS (log-scaled axis)",
    y = "Gene Count",
    color = "Threshold Type"
  ) +
  theme_minimal()

p_full / p_zoom


# Approach i: Prune top 1% genes by CAAS/gene-length ratio
## Calculate the top 1% threshold for n_CAAS_per_length
top_1_percent_threshold <- df_all %>%
  group_by(Trait) %>%
  summarise(
    top_1_percent = quantile(n_CAAS_per_length, 0.99),
    .groups = "drop"
  )

## i) Annotate "Extreme" and "Dubious" genes, using top_1_percent_threshold and percentiles_df
df_all.i <- df_all %>%
  left_join(top_1_percent_threshold, by = "Trait") %>%
  mutate(
    Extreme = n_CAAS_per_length > top_1_percent) %>%
  left_join(percentiles_df, by = "Trait") %>%
  mutate(
    Dubious = n_CAAS > iqr_high
  ) %>%
  dplyr::select(Trait, Gene, Length, n_CAAS, n_CAAS_per_length, Extreme, Dubious)

# --- Plot the distribution of n_CAAS_per_length with Dubious annotations
p_i <- ggplot(df_all.i, aes(x = n_CAAS_per_length)) +
  geom_histogram(binwidth = 0.05, color = "black", fill = "grey80", alpha = 0.8) +
  geom_vline(data = top_1_percent_threshold, aes(xintercept = top_1_percent, color = "Top 1%"), linetype = "dashed") +
  scale_x_log10(breaks = c(0.0, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 50, 100)) +
  scale_color_manual(values = c("Top 1%" = "salmon3")) +
  facet_wrap(~Trait, scales = "free_y") +
  labs(
    title = "CAAS Count per Gene Length Distribution with distribution extremes (Top 1%)",
    x = "n_CAAS per Gene Length (%, log-scaled axis)",
    y = "Gene Count",
    color = "Threshold Type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
    
  )

p_i

# Zoom in on the Extreme and Dubious genes
zoom_limit <- 50

p_zoom <- ggplot(df_all.i, aes(x = n_CAAS_per_length)) +
  geom_histogram(binwidth = 0.05, color = "black", fill = "grey80", alpha = 0.8) +
  geom_vline(data = top_1_percent_threshold, aes(xintercept = top_1_percent, color = "Top 1%"), linetype = "dashed") +
  scale_x_log10(breaks = c(0.0, 0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 50, 100)) +
  # Add ticks more tick to y axis
  scale_y_continuous(breaks = seq(0, zoom_limit, by = 10)) +
  scale_color_manual(values = c("Top 1%" = "salmon3")) +
  facet_wrap(~Trait, scales = "free_y") +
  coord_cartesian(ylim = c(0, zoom_limit)) +
  labs(
    title = paste("Zoomed View (y ≤", zoom_limit, ")"),
    x = "n_CAAS per Gene Length (%, log-scaled axis)",
    y = "Gene Count",
    color = "Threshold Type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
    
  )

p_i / p_zoom

# Save lists and plots
createDir(file.path(resultsDir, "2.CAAS/3.CAAS_postproc/1.Outliers"))
# Save the data frame with Extreme and Dubious annotations
write_tsv(df_all.i, file.path(resultsDir, "2.CAAS/3.CAAS_postproc/1.Outliers/caas_outliers.tsv"))
# Save the plots
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/1.Outliers/caas_outliers_full.png"),
  plot = p_full, width = 10, height = 6, dpi = "retina", dev = "png"
)
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/1.Outliers/caas_outliers_zoom.png"),
  plot = p_zoom, width = 10, height = 6, dpi = "retina", dev = "png"
)
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/1.Outliers/caas_outliers_i.png"),
  plot = p_i, width = 10, height = 6, dpi = "retina", dev = "png"
)
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/1.Outliers/caas_outliers_i_zoom.png"),
  plot = p_zoom, width = 10, height = 6, dpi = "retina", dev = "png"
)

```

## 3.CAAS clusters
In this section, we will implement the CAAS clustering algorithm. The algorithm will generate main and lateral windows of size `k`, evaluate whether these windows exceed a density threshold, and iteratively exclude high-density windows for each gene.

```{r caas_clusters, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, dev='png', dpi=320}

# 3. CAAS CLUSTERS ------------------------------------------------------
# Load clusters ------------------------------------------------------
cluster_dir <- file.path(resultsDir, "2.CAAS/3.CAAS_postproc/3.NoTrains")
cluster_files <- list.files(
  path = cluster_dir,
  pattern = "\\.tsv$",
  full.names = TRUE,
  recursive = TRUE,
  all.files = TRUE # This flag ensures hidden files are included
)

# Read cluster files and create a list of data frames
cluster_dfs <- lapply(cluster_files, read_tsv)
names(cluster_dfs) <- gsub(".tsv", "", basename(cluster_files))
# Remove the summary
cluster_dfs <- cluster_dfs[!grepl("discarded_summary", names(cluster_dfs))]

# Polish the summary creating columns "minlength" and "maxcaas"
discarded_caas <- data.frame(
  Approach = names(cluster_dfs),
  n_rows = sapply(cluster_dfs, function(df) {
    sum(df$ClusteringFlag == "Discarded", na.rm = TRUE)
  }),
  minlength = as.integer(gsub(".*minlen(\\d+).*", "\\1", names(cluster_dfs))),
  maxcaas = as.integer(gsub(".*maxcaas(\\d+).*", "\\1", names(cluster_dfs)))
) %>%
  as_tibble() %>%
  mutate(
    # Keep everything up to just before the second underscore
    Trait = sub("^(([^_]+)_([^_]+))_.*$", "\\1", Approach)
  ) %>%
  select(Trait, n_rows, minlength, maxcaas) %>%
  rename(
    Discarded_CAAS = n_rows
  ) %>%
  arrange(Trait, minlength, maxcaas)

ggplot(discarded_caas, aes(x = factor(minlength), y = Discarded_CAAS, fill = factor(maxcaas))) +
  geom_col(position = "dodge") +
  facet_wrap(~ Trait, scales = "free_x") +
  # Raw counts at half bar height
  geom_text(
    aes(y = Discarded_CAAS / 2, label = Discarded_CAAS), position = position_dodge(width = 0.9),
    vjust = 0.5, size = 3.5, color = "black", fontface = "bold", angle = 90) +
  theme_minimal() +
  labs(
    title = "Discarded CAAS per Trait by Minlength and Maxcaas",
    x = "Minlength",
    y = "Number of Discarded CAAS",
    fill = "Max CAAS"
  )

# Save the plot
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/3.NoTrains/3.Discarded_CAA_plot.png"),
  width = 10, height = 6, dpi = "retina", dev = "png"
)

```

## 4. Declustered CAAS

Now we will only fixate on that in which we are interested
In our case, minlength = 4 and maxcaas = 60 seems like a good trade off (similar recovery to minlength=3 maxcaas=70, with added
depth. Minlength=3 and maxcaas=60 isn't bad, although it does remove some interesting cases (ie. in a 3 AA window, if two of the 
amino acids are the same, it will be discarded, even if the third is different and two of the three with no more around isn't 
something I feel confortable discarding, as it seems fairly possible in protein evolution.

```{r caas_declust, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, dev='png', dpi=320}

# 4. DECLUSTERED CAAS ------------------------------------------------------
# Load clusters ------------------------------------------------------
cluster_files <- list.files(
  path = cluster_dir,
  pattern = "\\.tsv$",
  full.names = TRUE,
  recursive = TRUE
  # In this case, we exclude hidden files as they are not relevant
)

# Read cluster files and create a list of data frames
cluster_dfs <- lapply(cluster_files, read_tsv)
names(cluster_dfs) <- gsub(".tsv", "", basename(cluster_files))
# Remove the summary
cluster_dfs <- cluster_dfs[!grepl("discarded_summary", names(cluster_dfs))]

# Lets filter in Discarded CAAS
cluster_filtered <- lapply(cluster_dfs, function(df) {
  df %>%
    mutate(GenePos = paste(Gene, Position, sep = "@")) %>%
    filter(ClusteringFlag == "Discarded") %>%
    pull(GenePos)
})

# Use the filtered clusters to remove from setup_dfs
# Approach i: First remove "Extreme" genes, then remove "Dubious" genes presenting clusters, then remove clusters
declust_setup <- function(prefix) {
  # Select the dfs for the prefix
  df_list <- setup_dfs[grepl(prefix, names(setup_dfs))]

  # Cluster positions for the prefix (drop names to avoid %in% surprises)
  clust_vec <- unlist(cluster_filtered[grepl(prefix, names(cluster_filtered))], use.names = FALSE)

  # Genes flagged Extreme / Dubious for the prefix
  extremes_vec <- df_all.i %>%
    dplyr::filter(Trait == prefix, Extreme) %>%
    dplyr::pull(Gene) %>%
    unique()

  dubious_vec <- df_all.i %>%
    dplyr::filter(Trait == prefix, Dubious) %>%
    dplyr::pull(Gene) %>%
    unique()

  # Pool all dfs for this prefix to find Dubious genes that present any cluster anywhere
  pooled <- dplyr::bind_rows(df_list, .id = "src")

  genes_with_cluster <- pooled %>%
    dplyr::filter(Gene %in% dubious_vec,
                  !is.na(GenePos),
                  GenePos %in% clust_vec) %>%
    dplyr::distinct(Gene) %>%
    dplyr::pull(Gene)

  # Now filter each df deterministically
  out_list <- lapply(df_list, function(df) {
    df %>%
      # 1) drop Extreme genes entirely
      dplyr::filter(!Gene %in% extremes_vec) %>%
      # 2) drop Dubious genes that exhibit any cluster anywhere
      dplyr::filter(!Gene %in% genes_with_cluster) %>%
      # 3) drop clustered positions from the remaining (non-Dubious) genes
      dplyr::filter(is.na(GenePos) | !(GenePos %in% clust_vec))
  })

  return(out_list)
}
# Apply the declust_setup function to each prefix
malignant_declust <- declust_setup("malignant_prevalence")
neoplasia_declust <- declust_setup("neoplasia_prevalence")

# Save the declustered data frames to files
for (prefix in c("malignant_prevalence", "neoplasia_prevalence")) {
  declust_df <- if (prefix == "malignant_prevalence") malignant_declust else neoplasia_declust
  # Create a directory for declustered results if it doesn't exist
  declustered_dir <- file.path(resultsDir, "2.CAAS/3.CAAS_postproc/4.Declustered_i", prefix)
  createDir(declustered_dir)
  for (trait in names(declust_df)) {
    write_tsv(declust_df[[trait]], 
              
              file.path(declustered_dir, paste0(trait, "_declustered.tsv")))
  }
}

# Summary of declustered CAAS
extract_summary <- function(df_list, label) {
  tibble(
    Approach = names(df_list),
    n_CAAS = sapply(df_list, nrow),
    source = label,
    Trait = sub("^(([^_]+)_([^_]+))_.*$", "\\1", names(df_list)),
    Hypothesis_ID = as.integer(gsub(".*_pair_(\\d+).*", "\\1", names(df_list)))
  )
}

# Apply to both original and declustered lists
original_summary <- extract_summary(setup_dfs, "original")
declust_summary <- extract_summary(c(malignant_declust, neoplasia_declust), "declustered")

combined <- full_join(
  original_summary %>% rename(n_CAAS_original = n_CAAS),
  declust_summary %>% rename(n_CAAS_declust = n_CAAS),
  by = c("Approach", "Trait", "Hypothesis_ID")
)

# Calculate percentage reduction and simple significance flag
summary_stats <- combined %>%
  mutate(
    percent_diff = 100 * (n_CAAS_original - n_CAAS_declust) / n_CAAS_original,
    p_value = mapply(function(o, d) {
      # Fisher's test may be better if you have small numbers, but this is simple
      prop.test(c(d, o - d), c(o, o))$p.value
    }, n_CAAS_original, n_CAAS_declust),
    significant = p_value < 0.05
  )

# Reshape for plotting
plot_data <- summary_stats %>%
  select(Hypothesis_ID, Trait, n_CAAS_original, n_CAAS_declust, percent_diff, significant) %>%
  pivot_longer(cols = c(n_CAAS_original, n_CAAS_declust),
               names_to = "source", values_to = "n_CAAS") %>%
  mutate(source = dplyr::recode(source,
                              "n_CAAS_original" = "original",
                              "n_CAAS_declust" = "declustered"))

# Plotting the results
ggplot(plot_data, aes(x = factor(Hypothesis_ID), y = n_CAAS, fill = source)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Trait, scales = "free_x") +
  # Raw counts at half bar height
  geom_text(
    aes(y = n_CAAS / 2, label = n_CAAS), position = position_dodge(width = 0.9),
    vjust = 0.5, size = 3.5, color = "black", fontface = "bold", angle = 90) +
  # Add text annotations for percentage reduction
  geom_text(
    data = summary_stats,
    aes(x = factor(Hypothesis_ID), y = pmax(n_CAAS_original, n_CAAS_declust) + 2,
        label = paste0(round(percent_diff), "%↓", ifelse(significant, "*", "")),
        vjust = -0.1),
    inherit.aes = FALSE,
    size = 5,
    color = "black"
  ) +
  scale_fill_manual(values = c("original" = "steelblue", "declustered" = "darkorange")) +
  theme_minimal(base_size = 12) +
  labs(
    title = "CAAS Before and After Declustering",
    subtitle = "* indicates significant reduction (p < 0.05)",
    x = "Hypothesis ID",
    y = "Number of CAAS",
    fill = "Dataset"
  )

# Save the declustered plot
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/4.Declustered_i/CAAS_declustered_plot.png"),
  width = 10, height = 6, dpi = "retina", dev = "png"
)

```

```{r caas_declust_ii, message=FALSE, warning=FALSE, fig.height=6, fig.width=10, dev='png', dpi=320}

# 4. DECLUSTERED CAAS ------------------------------------------------------
# Load clusters ------------------------------------------------------
cluster_files <- list.files(
  path = cluster_dir,
  pattern = "\\.tsv$",
  full.names = TRUE,
  recursive = TRUE
  # In this case, we exclude hidden files as they are not relevant
)

# Read cluster files and create a list of data frames
cluster_dfs <- lapply(cluster_files, read_tsv)
names(cluster_dfs) <- gsub(".tsv", "", basename(cluster_files))
# Remove the summary
cluster_dfs <- cluster_dfs[!grepl("discarded_summary", names(cluster_dfs))]

# Lets filter in Discarded CAAS
cluster_filtered <- lapply(cluster_dfs, function(df) {
  df %>%
    mutate(GenePos = paste(Gene, Position, sep = "@")) %>%
    filter(ClusteringFlag == "Discarded") %>%
    pull(GenePos)
})

# Use the filtered clusters to remove from setup_dfs
# Approach ii: Remove "Dubious" genes presenting clusters, then remove clusters. Do not remove "Extreme" genes.
declust_setup <- function(prefix) {
  # Select the dfs for the prefix
  df_list <- setup_dfs[grepl(prefix, names(setup_dfs))]

  # Cluster positions for the prefix (drop names to avoid %in% surprises)
  clust_vec <- unlist(cluster_filtered[grepl(prefix, names(cluster_filtered))], use.names = FALSE)

  # Genes flagged Dubious for the prefix
  dubious_vec <- df_all.i %>%
    dplyr::filter(Trait == prefix, Dubious) %>%
    dplyr::pull(Gene) %>%
    unique()

  # Pool all dfs for this prefix to find Dubious genes that present any cluster anywhere
  pooled <- dplyr::bind_rows(df_list, .id = "src")

  genes_with_cluster <- pooled %>%
    dplyr::filter(Gene %in% dubious_vec,
                  !is.na(GenePos),
                  GenePos %in% clust_vec) %>%
    dplyr::distinct(Gene) %>%
    dplyr::pull(Gene)

  # Now filter each df deterministically
  out_list <- lapply(df_list, function(df) {
    df %>%
      # 1) drop Dubious genes that exhibit any cluster anywhere
      dplyr::filter(!Gene %in% genes_with_cluster) %>%
      # 2) drop clustered positions from the remaining (non-Dubious) genes
      dplyr::filter(is.na(GenePos) | !(GenePos %in% clust_vec))
  })

  return(out_list)
}
# Apply the declust_setup function to each prefix
malignant_declust <- declust_setup("malignant_prevalence")
neoplasia_declust <- declust_setup("neoplasia_prevalence")

# Save the declustered data frames to files
for (prefix in c("malignant_prevalence", "neoplasia_prevalence")) {
  declust_df <- if (prefix == "malignant_prevalence") malignant_declust else neoplasia_declust
  # Create a directory for declustered results if it doesn't exist
  declustered_dir <- file.path(resultsDir, "2.CAAS/3.CAAS_postproc/4.Declustered_ii", prefix)
  createDir(declustered_dir)
  for (trait in names(declust_df)) {
    write_tsv(declust_df[[trait]], 
              
              file.path(declustered_dir, paste0(trait, "_declustered.tsv")))
  }
}

# Summary of declustered CAAS
extract_summary <- function(df_list, label) {
  tibble(
    Approach = names(df_list),
    n_CAAS = sapply(df_list, nrow),
    source = label,
    Trait = sub("^(([^_]+)_([^_]+))_.*$", "\\1", names(df_list)),
    Hypothesis_ID = as.integer(gsub(".*_pair_(\\d+).*", "\\1", names(df_list)))
  )
}

# Apply to both original and declustered lists
original_summary <- extract_summary(setup_dfs, "original")
declust_summary <- extract_summary(c(malignant_declust, neoplasia_declust), "declustered")

combined <- full_join(
  original_summary %>% rename(n_CAAS_original = n_CAAS),
  declust_summary %>% rename(n_CAAS_declust = n_CAAS),
  by = c("Approach", "Trait", "Hypothesis_ID")
)

# Calculate percentage reduction and simple significance flag
summary_stats <- combined %>%
  mutate(
    percent_diff = 100 * (n_CAAS_original - n_CAAS_declust) / n_CAAS_original,
    p_value = mapply(function(o, d) {
      # Fisher's test may be better if you have small numbers, but this is simple
      prop.test(c(d, o - d), c(o, o))$p.value
    }, n_CAAS_original, n_CAAS_declust),
    significant = p_value < 0.05
  )

# Reshape for plotting
plot_data <- summary_stats %>%
  select(Hypothesis_ID, Trait, n_CAAS_original, n_CAAS_declust, percent_diff, significant) %>%
  pivot_longer(cols = c(n_CAAS_original, n_CAAS_declust),
               names_to = "source", values_to = "n_CAAS") %>%
  mutate(source = dplyr::recode(source,
                              "n_CAAS_original" = "original",
                              "n_CAAS_declust" = "declustered"))

# Plotting the results
ggplot(plot_data, aes(x = factor(Hypothesis_ID), y = n_CAAS, fill = source)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Trait, scales = "free_x") +
  # Raw counts at half bar height
  geom_text(
    aes(y = n_CAAS / 2, label = n_CAAS), position = position_dodge(width = 0.9),
    vjust = 0.5, size = 3.5, color = "black", fontface = "bold", angle = 90) +
  # Add text annotations for percentage reduction
  geom_text(
    data = summary_stats,
    aes(x = factor(Hypothesis_ID), y = pmax(n_CAAS_original, n_CAAS_declust) + 2,
        label = paste0(round(percent_diff), "%↓", ifelse(significant, "*", "")),
        vjust = -0.1),
    inherit.aes = FALSE,
    size = 5,
    color = "black"
  ) +
  scale_fill_manual(values = c("original" = "steelblue", "declustered" = "darkorange")) +
  theme_minimal(base_size = 12) +
  labs(
    title = "CAAS Before and After Declustering",
    subtitle = "* indicates significant reduction (p < 0.05)",
    x = "Hypothesis ID",
    y = "Number of CAAS",
    fill = "Dataset"
  )

# Save the declustered plot
ggsave(
  filename = file.path(resultsDir, "2.CAAS/3.CAAS_postproc/4.Declustered_ii/CAAS_declustered_plot.png"),
  width = 10, height = 6, dpi = "retina", dev = "png"
)

```
