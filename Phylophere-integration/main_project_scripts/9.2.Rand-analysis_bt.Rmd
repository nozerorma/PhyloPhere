---
title: "Rand analysis"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
citations:  
  output: 
  html_document: default
pdf_document: default
---

# Randomization analysis
This document processes randomization results for malignant and neoplasia prevalence in primates, aggregates results across subanalyses, and extracts significant genes based on p-value criteria. It also saves the aggregated results and significant gene lists for further analysis.

It is the same analysis, restricted to only genes in which changes have been observed in all three hypothesis.

## Setup and Directory Configuration

This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}

# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)

```

```{r dirdef, message=FALSE, warning=FALSE}

# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.

```

## Seed and library loading

```{r message=FALSE, warning=FALSE, r,warning=FALSE}

library(dplyr)
library(stats)  # For norm.sf

```

## 1. Load the randomization dataframes
Here we will load the randomization results for malignant and neoplasia prevalence, process them by approach and pattern type, and aggregate the results across subanalyses. The final output will include aggregated results and significant gene lists based on p-value criteria.

```{r rand_analysis, message=FALSE, warning=FALSE}

rand_dir <- file.path(resultsDir, "2.CAAS/4.Randomizations/new")

# List files for malignant_prevalence and neoplasia_prevalence
mp_rand_files <- list.files(
  path = file.path(rand_dir, "malignant_prevalence_bt"), 
  pattern = "_aggregated_results.csv", 
  full.names = TRUE, 
  recursive = TRUE
)

np_rand_files <- list.files(
  path = file.path(rand_dir, "neoplasia_prevalence_bt"), 
  pattern = "_aggregated_results.csv", 
  full.names = TRUE, 
  recursive = TRUE
)

# Process files by approach and pattern type
process_files_by_approach_and_pattern <- function(file_list, rand_dir, caas_dir) {
  approach_data <- list(pattern1 = list(), total = list())
  
  for (x in file_list) {
    # Extract approach and contrast number from file path
    subdir_full <- gsub(paste0(rand_dir, "/"), "", x)
    parts <- strsplit(subdir_full, "/")[[1]]
    trait <- parts[1]  # e.g., "malignant_prevalence"
    approach <- parts[3]  # e.g., "naive"
    contrast_file <- parts[4]  # e.g., "results_rand_3_aggregated_results.csv"
    contrast_number <- gsub("results_rand_|_aggregated_results.csv", "", contrast_file)
    
    # Print parts
    print(paste("Trait:", trait, "Approach:", approach, "Contrast number:", contrast_number))

    # Read randomization results
    data <- read.csv(x, stringsAsFactors = FALSE)
    colnames(data) <- gsub("(_pattern1|_pattern2)$", "", colnames(data))
    
    # Read corresponding CAAS file
    caas_file <- file.path(rand_dir, trait, "randomizations", approach, paste0(trait,"_", contrast_number, "_positions.csv"))
    print(paste("Processing CAAS file:", caas_file))
    if (file.exists(caas_file)) {
      print(paste("CAAS file found for contrast", contrast_number))
      caas_data <- read.csv(caas_file, stringsAsFactors = FALSE)
      # Count eligible positions: masked == False and caas == False
      eligible_count <- sum(caas_data$masked == "False" & caas_data$caas == "False")
    } else {
      eligible_count <- NA
      warning(paste("CAAS file not found for contrast", contrast_number))
    }
    
    # Store data and weight
    if (grepl("pattern1", x)) {
      if (is.null(approach_data$pattern1[[approach]])) {
        approach_data$pattern1[[approach]] <- list()
      }
      approach_data$pattern1[[approach]] <- append(approach_data$pattern1[[approach]], 
                                                   list(list(data = data, weight = eligible_count)))
    } else {
      if (is.null(approach_data$total[[approach]])) {
        approach_data$total[[approach]] <- list()
      }
      approach_data$total[[approach]] <- append(approach_data$total[[approach]], 
                                                list(list(data = data, weight = eligible_count)))
    }
  }
  
  return(approach_data)
}

# Combine p-values and Z-scores per gene across subanalyses
combine_stats <- function(sublist) {
  # Extract data and weights from sublist
  data_list <- lapply(sublist, function(x) x$data)
  weights <- sapply(sublist, function(x) x$weight)
  
  # Combine all subanalysis data into one dataframe
  combined_df <- do.call(rbind, data_list)
  
  # Aggregate by gene
  aggregated <- combined_df %>%
    group_by(Gene) %>%
    summarise(
      ActualCount_Total = sum(ActualCount),  # Sum of observed CAAS across subanalyses
      RandsAbove_Total = sum(RandsAbove),          # Sum of randomizations above observed CAAS
      NumRands_Total = sum(NumRands),          # Sum of randomizations across subanalyses
      NumPairs = n(),                        # Number of subanalyses this gene appears in
      # Simple combined p-value as (ActualCount_Total + 1) / (NumRands_Total + 1)
      Pvalue_simple = (RandsAbove_Total + 1) / (NumRands_Total + 1),
      # Fisherâ€™s method (unweighted)
      PValueEmpirical_Combined = {
        chi_sq <- -2 * sum(log(PValueEmpirical))
        pchisq(chi_sq, df = 2 * n(), lower.tail = FALSE)
      }
    ) %>%
    mutate(
      # Apply BH correction to combined p-values
      PValue_simple_BH = p.adjust(Pvalue_simple, method = "BH"),
      PValueEmpirical_BH = p.adjust(PValueEmpirical_Combined, method = "BH")
    ) %>%
    # Rank
    arrange(PValueEmpirical_Combined)
  
  return(aggregated)
}

# Process files
mp_rand_processed <- process_files_by_approach_and_pattern(mp_rand_files, rand_dir)
np_rand_processed <- process_files_by_approach_and_pattern(np_rand_files, rand_dir)

# Aggregate data
mp_aggregated_files <- list(
  pattern1 = lapply(mp_rand_processed$pattern1, combine_stats),
  total = lapply(mp_rand_processed$total, combine_stats)
)

np_aggregated_files <- list(
  pattern1 = lapply(np_rand_processed$pattern1, combine_stats),
  total = lapply(np_rand_processed$total, combine_stats)
)

# Save aggregated data
output_dir <- file.path(resultsDir, "2.CAAS/4.5.Rand_results/bt")
createDir(output_dir)

# Malignant prevalence
for (approach in names(mp_aggregated_files$total)) {
  path <- file.path(output_dir, "malignant_prevalence_bt")
  createDir(path)
  output_file <- file.path(path, paste0(approach, "_aggregated_results.csv"))
  write.csv(mp_aggregated_files$total[[approach]], file = output_file, row.names = FALSE)
}

for (approach in names(mp_aggregated_files$pattern1)) {
  path <- file.path(output_dir, "malignant_prevalence_bt")
  createDir(path)
  output_file <- file.path(path, paste0(approach, "_pattern1_aggregated_results.csv"))
  write.csv(mp_aggregated_files$pattern1[[approach]], file = output_file, row.names = FALSE)
}

# Neoplasia prevalence
for (approach in names(np_aggregated_files$total)) {
  path <- file.path(output_dir, "neoplasia_prevalence_bt")
  createDir(path)
  output_file <- file.path(path, paste0(approach, "_aggregated_results.csv"))
  write.csv(np_aggregated_files$total[[approach]], file = output_file, row.names = FALSE)
}

for (approach in names(np_aggregated_files$pattern1)) {
  path <- file.path(output_dir, "neoplasia_prevalence_bt")
  createDir(path)
  output_file <- file.path(path, paste0(approach, "_pattern1_aggregated_results.csv"))
  write.csv(np_aggregated_files$pattern1[[approach]], file = output_file, row.names = FALSE)
}

# Function to extract gene lists based on p-value criteria
extract_significant_genes <- function(df, criteria, out_dir, prefix) {
  for (crit in criteria) {
    sig_genes <- df %>% filter(.data[[crit]] <= 0.05) %>% pull(Gene) %>% unique()
    writeLines(sig_genes, con = file.path(out_dir, paste0(prefix, "_", crit, "_genes.txt")))
  }
}

# Define p-value criteria
pvalue_criteria <- c("Pvalue_simple", "PValueEmpirical_Combined", 
                     "PValue_simple_BH", "PValueEmpirical_BH")

# Output directory for gene lists
gene_list_dir <- file.path(resultsDir, "2.CAAS/4.5.Rand_results/bt/GeneLists")
createDir(gene_list_dir)

# Process malignant and neoplasia separately
for (trait in c("malignant_prevalence", "neoplasia_prevalence")) {
  for (pattern_type in c("pattern1", "total")) {
    data_list <- if (trait == "malignant_prevalence") {
      mp_aggregated_files[[pattern_type]]
    } else {
      np_aggregated_files[[pattern_type]]
    }
    for (approach in names(data_list)) {
      df <- data_list[[approach]]
      out_dir <- file.path(gene_list_dir, trait, pattern_type)
      createDir(out_dir)
      prefix <- paste(approach, trait, pattern_type, sep = "_")
      extract_significant_genes(df, pvalue_criteria, out_dir, prefix)
    }
  }
}

# Function to extract gene lists based on p-value criteria
extract_significant_genes <- function(df, criteria, out_dir, prefix) {
  for (crit in criteria) {
    sig_genes <- df %>% filter(.data[[crit]] <= 0.1) %>% pull(Gene) %>% unique()
    writeLines(sig_genes, con = file.path(out_dir, paste0(prefix, "_", crit, "_genes.txt")))
  }
}
# Output directory for gene lists
gene_list_dir <- file.path(resultsDir, "2.CAAS/4.5.Rand_results/bt/GeneLists.01")
createDir(gene_list_dir)

# Process malignant and neoplasia separately
for (trait in c("malignant_prevalence", "neoplasia_prevalence")) {
  for (pattern_type in c("pattern1", "total")) {
    data_list <- if (trait == "malignant_prevalence") {
      mp_aggregated_files[[pattern_type]]
    } else {
      np_aggregated_files[[pattern_type]]
    }
    for (approach in names(data_list)) {
      df <- data_list[[approach]]
      out_dir <- file.path(gene_list_dir, trait, pattern_type)
      createDir(out_dir)
      prefix <- paste(approach, trait, pattern_type, sep = "_")
      extract_significant_genes(df, pvalue_criteria, out_dir, prefix)
    }
  }
}
```