---
title: "Data Visualization for Neoplasia Analysis in Primates"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

# Neoplasia in Primates: Data Visualization and Processing

This script visualizes and processes data for the Primates' Neoplasia Project, focusing on malignancy prevalence across primate species. It generates family distribution plots, summary tables, and a processed dataset with longevity and statistical annotations.

---

## 1. Setup and Directory Configuration

This section configures the working environment, sets directories, and loads necessary functions and libraries.

```{r setup, message=FALSE, warning=FALSE}
# Suppress warnings and messages in output
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Set the root directory for the project
knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/PhD/NEOPLASY_PRIMATES")
# Display current working directory
getwd()
# Set seed for reproducibility
set.seed(1998)
```

```{r dirdef, message=FALSE, warning=FALSE}
# Define working, data, and results directories
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir, "Malignancy_Primates/Out")

# Load libraries, common functions, primate-specific functions and objects
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/libraries.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/commons.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_functions.R"))
source(file.path(workingDir, "Malignancy_Primates/Scripts/functions/primate_objects.R"))

# Note that all variables may be changed from COMMONS and PRIMATE_OBJECTS scripts.
```

## 2. Summary Tables

This section generates summary tables of cancer prevalence by primate family, including species counts, necropsy totals, and malignancy prevalence categories.
    
```{r prepare_summary_table}

# Define family categories for grouping
selected_families <- c("Atelidae", "Callitrichidae", "Cercopithecidae", "Hominidae", 
                       "Hylobatidae", "Lemuridae", "Lorisidae", "Pitheciidae")
other_primates <- "Other Primates"
primates <- "Primates"

# Prepare cancer traits data with family tags and malignancy ratios
cancer_traits_prep <- traits %>%
  dplyr::mutate(
    family_tag = dplyr::if_else(family %in% selected_families, family, other_primates),
    malignant_ratio = as.numeric(malignant_count) / as.numeric(neoplasia_necropsy) * 100
  ) %>%
  dplyr::select(family, family_tag, species, adult_necropsy_count, neoplasia_necropsy, 
                neoplasia_prevalence, malignant_count, malignant_prevalence, malignant_ratio) %>%
  dplyr::mutate(
    dplyr::across(c(adult_necropsy_count, neoplasia_necropsy, neoplasia_prevalence, 
                    malignant_count, malignant_prevalence, malignant_ratio), as.numeric),
    no_neoplasia = adult_necropsy_count - neoplasia_necropsy,
    no_malignant = adult_necropsy_count - malignant_count,
    in_tree = species %in% tree_species
  ) %>%
  dplyr::mutate(
    global_label_malignancy = dplyr::case_when(
      malignant_prevalence <= quantile(malignant_prevalence, 0.25, na.rm = TRUE) ~ "Low",
      malignant_prevalence >= quantile(malignant_prevalence, 0.75, na.rm = TRUE) ~ "High",
      TRUE ~ "Intermediate"
    ),
    tree_label = dplyr::if_else(in_tree, global_label_malignancy, NA_character_)
  )

# Summarize data by family
cancer_table <- cancer_traits_prep %>%
  dplyr::group_by(family_tag) %>%
  dplyr::summarise(
    species = n(),
    adult_necropsy_count = sum(adult_necropsy_count, na.rm = TRUE),
    neoplasia_necropsy = sum(neoplasia_necropsy, na.rm = TRUE),
    malignant_count = sum(malignant_count, na.rm = TRUE),
    malignant_prevalence = mean(malignant_prevalence, na.rm = TRUE),
    malignant_ratio = mean(malignant_ratio, na.rm = TRUE),
    no_malignant = sum(no_malignant, na.rm = TRUE),
    Low = sum(global_label_malignancy == "Low"),
    Intermediate = sum(global_label_malignancy == "Intermediate"),
    High = sum(global_label_malignancy == "High"),
    in_tree = sum(in_tree),
    in_tree_low = sum(tree_label == "Low", na.rm = TRUE),
    in_tree_intermediate = sum(tree_label == "Intermediate", na.rm = TRUE),
    in_tree_high = sum(tree_label == "High", na.rm = TRUE)
  )

# Add a summary row for all primates
primates_row <- cancer_table %>%
  dplyr::summarise(
    family_tag = "Primates",
    species = sum(species),
    adult_necropsy_count = sum(adult_necropsy_count),
    neoplasia_necropsy = sum(neoplasia_necropsy),
    malignant_count = sum(malignant_count),
    malignant_prevalence = mean(malignant_prevalence),
    malignant_ratio = mean(malignant_ratio),
    no_malignant = sum(no_malignant),
    Low = sum(Low),
    Intermediate = sum(Intermediate),
    High = sum(High),
    in_tree = sum(in_tree),
    in_tree_low = sum(in_tree_low),
    in_tree_intermediate = sum(in_tree_intermediate),
    in_tree_high = sum(in_tree_high)
  )

# Combine family and primates summaries
cancer_table <- dplyr::bind_rows(cancer_table, primates_row)

# Create formatted labels for the table
cancer_table_2 <- cancer_table %>%
  dplyr::mutate(
    species_label = paste(species, "(", Low, "/", Intermediate, "/", High, ")", sep = ""),
    individual_label = paste(adult_necropsy_count, "(", no_malignant, "/", malignant_count, ")", sep = ""),
    phylo_label = paste(in_tree, "(", in_tree_low, "/", in_tree_intermediate, "/", in_tree_high, ")", sep = "")
  )

# Order and select columns for the simplified table
cancer_table_3 <- cancer_table_2 %>%
  dplyr::mutate(family_tag = factor(family_tag, levels = c(selected_families, other_primates, primates))) %>%
  dplyr::arrange(family_tag) %>%
  dplyr::select(family_tag, species_label, individual_label, phylo_label)

# Save summary tables to CSV
cancer_dir <- file.path(resultsDir, "1.Data-exploration/1.Species_distribution")
createDir(cancer_dir)
write.csv(cancer_table_2, file.path(cancer_dir, "malignant_table_complete.csv"), quote = FALSE, row.names = FALSE)
write.csv(cancer_table_3, file.path(cancer_dir, "malignant_table.csv"), quote = FALSE, row.names = FALSE)

# Create HTML tables using kableExtra
# Simplified table
cancer_html <- cancer_table_3 %>%
  knitr::kable("html", 
               caption = "Distribution of malignancy prevalence across primate families and species.",
               align = "llll",
               col.names = c("", "", "", "")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE) %>%
  kableExtra::add_header_above(c("Family", "Species\n(High/Intermediate/Low)", 
                                 "In Phylogeny", "Necropsies(No malignancies/With malignancies)"),
                              align = "left") %>%
  kableExtra::column_spec(1, bold = TRUE, color = "white", background = "#4B4B4B", width = "5cm") %>%
  kableExtra::column_spec(2:4, bold = TRUE, color = "black", background = "#F2F2F2", width = "7.5cm") %>%
  kableExtra::row_spec(nrow(cancer_table_3), bold = TRUE, color = "white", background = "#4B4B4B") %>%
  kableExtra::save_kable(file.path(cancer_dir, "malignant_table.html"))

# Complete table
cancer_complete_html <- cancer_table_2 %>%
  dplyr::select(family_tag, species_label, phylo_label, individual_label, 
                neoplasia_necropsy, malignant_ratio, malignant_prevalence) %>%
  dplyr::mutate(malignant_ratio = round(malignant_ratio)) %>%
  knitr::kable("html", 
               caption = "Comprehensive distribution of malignancy prevalence in primates.",
               align = "lllllll",
               col.names = c("", "", "", "", "", "", "")) %>%
  kableExtra::kable_styling("striped", full_width = FALSE) %>%
  kableExtra::add_header_above(c("Family", "Species\n(High/Intermediate/Low)", "In Phylogeny", 
                                 "Necropsies(No malignancies/With malignancies)", 
                                 "Total\nneoplasias", "%Malignancies/\nTotal neoplasias", 
                                 "Malignant\nprevalence"), align = "left") %>%
  kableExtra::column_spec(1, bold = TRUE, color = "white", background = "#4B4B4B", width = "5cm") %>%
  kableExtra::column_spec(2:7, bold = TRUE, color = "black", background = "#F2F2F2", width = "7.5cm") %>%
  kableExtra::row_spec(nrow(cancer_table_2), bold = TRUE, color = "white", background = "#4B4B4B") %>%
  kableExtra::save_kable(file.path(cancer_dir, "malignant_complete_table.html"))

# Display the simplified table in the knitr output
cancer_table_3

```